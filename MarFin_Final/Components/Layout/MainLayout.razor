@inherits LayoutComponentBase
@inject AuthService AuthService
@inject NavigationManager Navigation
@implements IDisposable

<div class="page">
    @if (AuthService.IsAuthenticated)
    {
        <div class="sidebar @(sidebarCollapsed ? "collapsed" : "")">
            <NavMenu IsCollapsed="@sidebarCollapsed" OnToggleSidebar="@ToggleSidebar" />
        </div>

        <main class="@(sidebarCollapsed ? "sidebar-collapsed" : "")">
            <div class="top-row">
                <div class="search-container">
                    <i class="bi bi-search search-icon"></i>
                    <input type="text" placeholder="Search here.." class="search-input" />
                </div>
                <div class="top-row-right">
                    <button class="icon-button" @onclick="NavigateToSettings">
                        <i class="bi bi-gear"></i>
                    </button>

                    <!-- Notifications Dropdown (Bootstrap) -->
                    <div class="dropdown">
                        <button class="btn position-relative" type="button" data-bs-toggle="dropdown" aria-expanded="false" style="width: 40px; height: 40px; border: none; background-color: transparent; border-radius: 8px; font-size: 18px;">
                            <i class="bi bi-bell"></i>
                            @if (unreadNotifications > 0)
                            {
                                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 0.625rem;">
                                    @unreadNotifications
                                </span>
                            }
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end p-0" style="width: 380px; max-height: 500px;">
                            <li class="px-3 py-2 border-bottom d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">Notifications</h6>
                                <button class="btn btn-link btn-sm p-0 text-decoration-none" @onclick="MarkAllAsRead">Mark all as read</button>
                            </li>
                            <li style="max-height: 400px; overflow-y: auto;">
                                @foreach (var notification in notifications)
                                {
                                    <div class="p-3 border-bottom @(notification.IsRead ? "" : "bg-light")" style="cursor: pointer;">
                                        <div class="d-flex gap-2">
                                            <div class="rounded-circle d-flex align-items-center justify-content-center flex-shrink-0" 
                                                 style="width: 40px; height: 40px; background-color: @GetNotificationBgColor(notification.Type);">
                                                <i class="bi @GetNotificationIcon(notification.Type)" style="color: @GetNotificationColor(notification.Type);"></i>
                                            </div>
                                            <div class="flex-grow-1">
                                                <p class="mb-1 fw-semibold" style="font-size: 0.875rem;">@notification.Title</p>
                                                <p class="mb-1 text-muted" style="font-size: 0.8125rem;">@notification.Message</p>
                                                <small class="text-muted" style="font-size: 0.75rem;">@notification.TimeAgo</small>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </li>
                            <li class="text-center py-2 border-top">
                                <a href="/notifications" class="text-decoration-none" style="font-size: 0.875rem;">View all notifications</a>
                            </li>
                        </ul>
                    </div>

                    <!-- User Profile Dropdown (Bootstrap) -->
                    <div class="dropdown">
                        <button class="btn d-flex align-items-center gap-2" type="button" data-bs-toggle="dropdown" aria-expanded="false" 
                                style="border: none; background-color: transparent; border-radius: 8px; padding: 8px 15px;">
                            <i class="bi bi-person-circle" style="font-size: 20px; color: #0A1828;"></i>
                            <span style="font-size: 14px; font-weight: 500;">@AuthService.CurrentUserName</span>
                            <i class="bi bi-chevron-down"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end p-0" style="width: 260px;">
                            <li class="p-3 bg-light">
                                <div class="d-flex align-items-center gap-2">
                                    <i class="bi bi-person-circle" style="font-size: 2.5rem; color: #6c757d;"></i>
                                    <div>
                                        <p class="mb-0 fw-semibold" style="font-size: 0.875rem;">@AuthService.CurrentUserName</p>
                                        <p class="mb-0 text-muted" style="font-size: 0.75rem;">@AuthService.CurrentUserRole</p>
                                    </div>
                                </div>
                            </li>
                            <li><hr class="dropdown-divider my-0"></li>
                            <li>
                                <button class="dropdown-item d-flex align-items-center gap-2 py-2" @onclick="NavigateToProfile">
                                    <i class="bi bi-person"></i>
                                    <span>My Profile</span>
                                </button>
                            </li>
                            <li>
                                <button class="dropdown-item d-flex align-items-center gap-2 py-2" @onclick="NavigateToAccountManagement">
                                    <i class="bi bi-people"></i>
                                    <span>Manage Accounts</span>
                                </button>
                            </li>
                            <li>
                                <button class="dropdown-item d-flex align-items-center gap-2 py-2" @onclick="NavigateToSettings">
                                    <i class="bi bi-gear"></i>
                                    <span>Settings</span>
                                </button>
                            </li>
                            <li><hr class="dropdown-divider my-0"></li>
                            <li>
                                <button class="dropdown-item d-flex align-items-center gap-2 py-2 text-danger" @onclick="Logout">
                                    <i class="bi bi-box-arrow-right"></i>
                                    <span>Logout</span>
                                </button>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <article class="content">
                @Body
            </article>
        </main>
    }
    else
    {
        @Body
    }
</div>


@code {
    private bool sidebarCollapsed = false;
    private int unreadNotifications = 3;

    private List<Notification> notifications = new();

    protected override void OnInitialized()
    {
        AuthService.OnAuthStateChanged += StateHasChanged;
        LoadNotifications();
    }

    private void LoadNotifications()
    {
        notifications = new List<Notification>
        {
            new Notification
            {
                Type = "Success",
                Title = "Payment Received",
                Message = "Invoice INV-2025-025 has been paid by Tech Startup Inc.",
                TimeAgo = "5 minutes ago",
                IsRead = false
            },
            new Notification
            {
                Type = "Warning",
                Title = "Invoice Overdue",
                Message = "Invoice INV-2025-020 is now 3 days overdue.",
                TimeAgo = "2 hours ago",
                IsRead = false
            },
            new Notification
            {
                Type = "Info",
                Title = "New Lead Assigned",
                Message = "You have been assigned a new lead from Summer Sale campaign.",
                TimeAgo = "5 hours ago",
                IsRead = false
            },
            new Notification
            {
                Type = "Success",
                Title = "Campaign Completed",
                Message = "Summer Sale 2025 campaign has finished with 54% open rate.",
                TimeAgo = "1 day ago",
                IsRead = true
            },
            new Notification
            {
                Type = "Info",
                Title = "Report Generated",
                Message = "Your monthly financial report is ready to view.",
                TimeAgo = "2 days ago",
                IsRead = true
            }
        };
    }

    private string GetNotificationIcon(string type)
    {
        return type.ToLower() switch
        {
            "success" => "bi-check-circle-fill",
            "warning" => "bi-exclamation-triangle-fill",
            "info" => "bi-info-circle-fill",
            "error" => "bi-x-circle-fill",
            _ => "bi-bell-fill"
        };
    }

    private string GetNotificationColor(string type)
    {
        return type.ToLower() switch
        {
            "success" => "#10b981",
            "warning" => "#f59e0b",
            "info" => "#3b82f6",
            "error" => "#ef4444",
            _ => "#666"
        };
    }

    private string GetNotificationBgColor(string type)
    {
        return type.ToLower() switch
        {
            "success" => "#d1fae5",
            "warning" => "#fef3c7",
            "info" => "#dbeafe",
            "error" => "#fee2e2",
            _ => "#f0f0f0"
        };
    }

    private void ToggleSidebar() => sidebarCollapsed = !sidebarCollapsed;

    private void MarkAllAsRead()
    {
        foreach (var notification in notifications)
        {
            notification.IsRead = true;
        }
        unreadNotifications = 0;
        StateHasChanged();
    }

    private void NavigateToProfile()
    {
        Navigation.NavigateTo("/profile");
    }

    private void NavigateToAccountManagement()
    {
        Navigation.NavigateTo("/users");
    }

    private void NavigateToSettings()
    {
        Navigation.NavigateTo("/settings");
    }

    private void Logout()
    {
        AuthService.Logout();
        Navigation.NavigateTo("/login", true);
    }

    public void Dispose()
    {
        AuthService.OnAuthStateChanged -= StateHasChanged;
    }

    private class Notification
    {
        public string Type { get; set; } = "";
        public string Title { get; set; } = "";
        public string Message { get; set; } = "";
        public string TimeAgo { get; set; } = "";
        public bool IsRead { get; set; }
    }
}
@using MarFin_Final.Database.Services
@inject AuthService AuthService

<div class="nav-container @(isDarkMode ? "" : "light-theme")">
    <div class="nav-header">
        <div class="logo-container">
            <NavLink href="/">
                <img src="@(isDarkMode ? "img/marfin_logo.png" : "img/logo_blacktxt.png")" alt="MarFin Logo" class="logo" />
            </NavLink>
        </div>
    </div>

    <nav class="nav-menu">
        <!-- MAIN Section -->
        @if (!IsCollapsed)
        {
            <div class="nav-section-title">MAIN</div>
        }

        <!-- Home - Available to all -->
        <button class="nav-btn @(IsActive("") ? "active" : "")" @onclick="@(() => NavigateTo(""))">
            <i class="bi bi-house-door nav-icon"></i>
            @if (!IsCollapsed)
            {
                <span class="nav-text">Home</span>
            }
        </button>

        <!-- Dashboard - Available to all (role-specific content) -->
        <button class="nav-btn @(IsActive("dashboard") ? "active" : "")" @onclick="@(() => NavigateTo("dashboard"))">
            <i class="bi bi-grid nav-icon"></i>
            @if (!IsCollapsed)
            {
                <span class="nav-text">Dashboard</span>
            }
        </button>

        <!-- Customers - Admin, Marketing, Sales -->
        @if (AuthService.HasPermission(RolePermissions.Permissions.ViewCustomers))
        {
            <button class="nav-btn @(IsActive("customers", "customer-details") ? "active" : "")"
                    @onclick="@(() => NavigateTo("customers"))">
                <i class="bi bi-person-badge nav-icon"></i>
                @if (!IsCollapsed)
                {
                    <span class="nav-text">Customer</span>
                }
            </button>
        }

        <!-- Sales Pipeline - Admin, Sales -->
        @if (AuthService.HasPermission(RolePermissions.Permissions.ViewSalesPipeline))
        {
            <button class="nav-btn @(IsActive("sales-pipeline") ? "active" : "")" @onclick="@(() => NavigateTo("sales-pipeline"))">
                <i class="bi bi-bar-chart-line nav-icon"></i>
                @if (!IsCollapsed)
                {
                    <span class="nav-text">Sales Pipeline</span>
                }
            </button>
        }

        <!-- Marketing - Admin, Marketing -->
        @if (AuthService.HasPermission(RolePermissions.Permissions.ViewMarketing))
        {
            <button class="nav-btn @(IsActive("marketing") ? "active" : "")" @onclick="@(() => NavigateTo("marketing"))">
                <i class="bi bi-megaphone nav-icon"></i>
                @if (!IsCollapsed)
                {
                    <span class="nav-text">Marketing</span>
                }
            </button>
        }

        <!-- Financial - Admin, Finance -->
        @if (AuthService.HasPermission(RolePermissions.Permissions.ViewFinance))
        {
            <button class="nav-btn @(IsActive("financial") ? "active" : "")" @onclick="@(() => NavigateTo("financial"))">
                <i class="bi bi-bank nav-icon"></i>
                @if (!IsCollapsed)
                {
                    <span class="nav-text">Financial</span>
                }
            </button>
        }

        <div class="nav-divider"></div>

        <!-- REPORTS Section -->
        @if (!IsCollapsed && AuthService.HasPermission(RolePermissions.Permissions.ViewReports))
        {
            <div class="nav-section-title">REPORTS</div>
        }

        <!-- Reports - Available to all (role-specific content) -->
        @if (AuthService.HasPermission(RolePermissions.Permissions.ViewReports))
        {
            <button class="nav-btn @(IsActive("reports") ? "active" : "")" @onclick="@(() => NavigateTo("reports"))">
                <i class="bi bi-graph-up-arrow nav-icon"></i>
                @if (!IsCollapsed)
                {
                    <span class="nav-text">Reports</span>
                }
            </button>
        }

        <!-- Documents - Admin only -->
        @if (AuthService.HasPermission(RolePermissions.Permissions.ViewDocuments))
        {
            <button class="nav-btn @(IsActive("documents") ? "active" : "")" @onclick="@(() => NavigateTo("documents"))">
                <i class="bi bi-file-earmark-text nav-icon"></i>
                @if (!IsCollapsed)
                {
                    <span class="nav-text">Documents</span>
                }
            </button>

            <div class="nav-divider"></div>
        }

        <!-- SETTINGS Section -->
        @if (!IsCollapsed && AuthService.HasPermission(RolePermissions.Permissions.ViewSettings))
        {
            <div class="nav-section-title">SETTINGS</div>
        }

        <!-- Settings - Admin only -->
        @if (AuthService.HasPermission(RolePermissions.Permissions.ViewSettings))
        {
            <button class="nav-btn @(IsActive("settings") ? "active" : "")" @onclick="@(() => NavigateTo("settings"))">
                <i class="bi bi-gear nav-icon"></i>
                @if (!IsCollapsed)
                {
                    <span class="nav-text">Settings</span>
                }
            </button>
        }
    </nav>

    <!-- Footer -->
    <div class="nav-footer">
        <!-- User Info -->
        @if (!IsCollapsed && AuthService.IsAuthenticated)
        {
            <div class="user-info">
                <div class="user-avatar">
                    @if (!string.IsNullOrEmpty(AuthService.CurrentUser?.ProfileImagePath))
                    {
                        <img src="@AuthService.CurrentUser.ProfileImagePath" alt="Profile" />
                    }
                    else
                    {
                        <div class="avatar-placeholder">
                            @AuthService.CurrentUserFirstName?.Substring(0, 1).ToUpper()
                        </div>
                    }
                </div>
                <div class="user-details">
                    <span class="user-name">@AuthService.CurrentUserName</span>
                    <span class="user-role">@AuthService.CurrentUserRole</span>
                </div>
            </div>
        }

        <button class="collapse-btn" @onclick="OnToggleSidebar">
            <i class="bi bi-@(IsCollapsed ? "chevron-right" : "chevron-left") nav-icon"></i>
            @if (!IsCollapsed)
            {
                <span class="nav-text">Collapse</span>
            }
        </button>
    </div>
</div>

@code {
    [Parameter]
    public bool IsCollapsed { get; set; }

    [Parameter]
    public EventCallback OnToggleSidebar { get; set; }

    [Parameter]
    public EventCallback<bool> OnThemeChanged { get; set; }

    [Inject]
    private NavigationManager NavigationManager { get; set; } = default!;

    private string currentPath = "";
    private bool isDarkMode = false;

    protected override void OnInitialized()
    {
        currentPath = new Uri(NavigationManager.Uri).AbsolutePath.TrimStart('/');
        NavigationManager.LocationChanged += OnLocationChanged;
        AuthService.OnAuthStateChanged += OnAuthStateChanged;
    }

    private void OnAuthStateChanged()
    {
        StateHasChanged();
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        currentPath = new Uri(e.Location).AbsolutePath.TrimStart('/');
        StateHasChanged();
    }

    private bool IsActive(params string[] paths)
    {
        foreach (var path in paths)
        {
            if (string.IsNullOrEmpty(path))
            {
                if (string.IsNullOrEmpty(currentPath))
                    return true;
            }
            else if (currentPath.StartsWith(path, StringComparison.OrdinalIgnoreCase))
            {
                return true;
            }
        }
        return false;
    }

    private void NavigateTo(string path)
    {
        NavigationManager.NavigateTo(path);
    }

    private async Task ToggleTheme()
    {
        isDarkMode = !isDarkMode;
        await OnThemeChanged.InvokeAsync(isDarkMode);
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
        AuthService.OnAuthStateChanged -= OnAuthStateChanged;
    }
}
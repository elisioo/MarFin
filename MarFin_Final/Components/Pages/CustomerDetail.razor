@page "/customer-details/{CustomerId:int}"
@inject NavigationManager Navigation
@using Ordering_Sorono_IT13.Data
@using Ordering_Sorono_IT13.Models

<div class="customers-container">
    @if (isLoading)
    {
        <div class="loading-state">
            <div class="spinner"></div>
            <p>Loading customer details...</p>
        </div>
    }
    else if (customer == null)
    {
        <div class="error-state">
            <i class="bi bi-exclamation-circle"></i>
            <h2>Customer Not Found</h2>
            <p>@errorMessage</p>
            <button class="btn-primary" @onclick="NavigateBack">
                <i class="bi bi-arrow-left"></i> Back to Customers
            </button>
        </div>
    }
    else
    {
        <div class="details-page">
            <div class="details-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h1>@customer.FullName</h1>
                    <button class="btn-back" @onclick="NavigateBack">
                        <i class="bi bi-arrow-left"></i> Back
                    </button>
                </div>

                <div class="header-tabs">
                    <button class="tab-btn active">Overview</button>
                    <button class="tab-btn">Invoices</button>
                    <button class="tab-btn">Transactions</button>
                    <button class="tab-btn">Documents</button>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger">@errorMessage</div>
            }

            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="alert alert-success">@successMessage</div>
            }

            <div class="details-grid">
                <div class="details-card">
                    <div class="card-header">
                        <h3>Customer Information</h3>
                    </div>
                    
                    <div class="form-group">
                        <label>First Name</label>
                        <input type="text" 
                               class="form-control" 
                               @bind="customer.FirstName" 
                               disabled="@(!isEditing)" />
                    </div>
                    
                    <div class="form-group">
                        <label>Last Name</label>
                        <input type="text" 
                               class="form-control" 
                               @bind="customer.LastName" 
                               disabled="@(!isEditing)" />
                    </div>
                    
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" 
                               class="form-control" 
                               @bind="customer.Email" 
                               disabled="@(!isEditing)" />
                    </div>
                    
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="text" 
                               class="form-control" 
                               @bind="customer.Phone" 
                               disabled="@(!isEditing)" />
                    </div>
                    
                    <div class="form-group">
                        <label>Company Name</label>
                        <input type="text" 
                               class="form-control" 
                               @bind="customer.CompanyName" 
                               disabled="@(!isEditing)" />
                    </div>
                    
                    <div class="form-group">
                        <label>Address</label>
                        <input type="text" 
                               class="form-control" 
                               @bind="customer.Address" 
                               disabled="@(!isEditing)" />
                    </div>
                    
                    <div class="form-group">
                        <label>City</label>
                        <input type="text" 
                               class="form-control" 
                               @bind="customer.City" 
                               disabled="@(!isEditing)" />
                    </div>
                    
                    <div class="form-group">
                        <label>Status</label>
                        @if (isEditing)
                        {
                            <select class="form-control" @bind="customer.CustomerStatus">
                                <option value="Lead">Lead</option>
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                                <option value="Dormant">Dormant</option>
                            </select>
                        }
                        else
                        {
                            <div class="status-display">
                                <span class="status-badge status-@customer.CustomerStatus.ToLower()">
                                    @customer.CustomerStatus
                                </span>
                            </div>
                        }
                    </div>
                    
                    <div class="form-group">
                        <label>Created at</label>
                        <input type="text" 
                               class="form-control" 
                               value="@customer.CreatedDate.ToString("MMM dd, yyyy")" 
                               readonly />
                    </div>

                    @if (isEditing)
                    {
                        <div class="form-actions">
                            <button class="btn-cancel" @onclick="CancelEdit">Cancel</button>
                            <button class="btn-save" @onclick="SaveChanges">Save Changes</button>
                        </div>
                    }
                </div>

                <div class="details-card">
                    <div class="activity-tabs">
                        <button class="activity-tab active">Overview</button>
                        <button class="activity-tab">Transactions</button>
                        <button class="activity-tab">Interactions</button>
                        <button class="activity-tab">Docs</button>
                        <i class="bi bi-three-dots-vertical"></i>
                    </div>
                    
                    <div class="activity-content">
                        <div class="info-section">
                            <h4>Contact Details</h4>
                            <div class="info-item">
                                <span class="info-label">Email:</span>
                                <span class="info-value">@customer.Email</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Phone:</span>
                                <span class="info-value">@(string.IsNullOrEmpty(customer.Phone) ? "N/A" : customer.Phone)</span>
                            </div>
                        </div>

                        <div class="info-section">
                            <h4>Address</h4>
                            <div class="info-item">
                                <span class="info-value">
                                    @if (!string.IsNullOrEmpty(customer.Address))
                                    {
                                        <text>@customer.Address<br /></text>
                                    }
                                    @if (!string.IsNullOrEmpty(customer.City))
                                    {
                                        <text>@customer.City, </text>
                                    }
                                    @if (!string.IsNullOrEmpty(customer.StateProvince))
                                    {
                                        <text>@customer.StateProvince </text>
                                    }
                                    @if (!string.IsNullOrEmpty(customer.PostalCode))
                                    {
                                        <text>@customer.PostalCode<br /></text>
                                    }
                                    @customer.Country
                                </span>
                            </div>
                        </div>

                        <div class="info-section">
                            <h4>Additional Information</h4>
                            <div class="info-item">
                                <span class="info-label">Segment:</span>
                                <span class="info-value">@customer.SegmentName</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Source:</span>
                                <span class="info-value">@(string.IsNullOrEmpty(customer.Source) ? "N/A" : customer.Source)</span>
                            </div>
                        </div>

                        @if (!string.IsNullOrEmpty(customer.Notes))
                        {
                            <div class="info-section">
                                <h4>Notes</h4>
                                <div class="info-item">
                                    <span class="info-value">@customer.Notes</span>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <div class="details-card">
                    <div class="revenue-section">
                        <div class="revenue-icon">
                            <i class="bi bi-receipt"></i>
                        </div>
                        <div class="revenue-info">
                            <div class="revenue-amount">Php @customer.TotalRevenue.ToString("N2")</div>
                            <div class="revenue-label">Total Revenue</div>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn-action btn-action-primary" @onclick="StartEdit" disabled="@isEditing">
                            <i class="bi bi-pencil"></i> Edit Customer
                        </button>
                        <button class="btn-action">
                            <i class="bi bi-plus-lg"></i> Log Interaction
                        </button>
                        <button class="btn-action">
                            <i class="bi bi-envelope"></i> Send Email
                        </button>
                        <button class="btn-action">
                            <i class="bi bi-calendar"></i> Schedule Meeting
                        </button>
                        <button class="btn-action">
                            <i class="bi bi-file-text"></i> Create Invoice
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public int CustomerId { get; set; }

    private readonly CustomerService customerService = new();
    private Ordering_Sorono_IT13.Models.Customer? customer = null;
    private Ordering_Sorono_IT13.Models.Customer? originalCustomer = null;
    private bool isLoading = true;
    private string errorMessage = "";
    private string successMessage = "";
    private bool isEditing = false;

    protected override void OnInitialized()
    {
        LoadCustomerDetails();
    }

    private void LoadCustomerDetails()
    {
        try
        {
            isLoading = true;
            customer = customerService.GetCustomerById(CustomerId);
            if (customer == null)
            {
                errorMessage = "Customer not found";
            }
            else
            {
                originalCustomer = CloneCustomer(customer);
            }
            isLoading = false;
        }
        catch (Exception ex)
        {
            errorMessage = "Error loading customer details: " + ex.Message;
            isLoading = false;
        }
    }

    private void StartEdit()
    {
        isEditing = true;
        if (customer != null)
        {
            originalCustomer = CloneCustomer(customer);
        }
    }

    private void CancelEdit()
    {
        isEditing = false;
        if (originalCustomer != null)
        {
            customer = CloneCustomer(originalCustomer);
        }
        errorMessage = "";
    }

    private void SaveChanges()
    {
        if (customer == null) return;

        try
        {
            bool success = customerService.UpdateCustomer(customer);
            if (success)
            {
                successMessage = "Customer updated successfully!";
                isEditing = false;
                originalCustomer = CloneCustomer(customer);
                errorMessage = "";
            }
            else
            {
                errorMessage = "Failed to update customer";
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Error saving changes: " + ex.Message;
        }
    }

    private void NavigateBack()
    {
        Navigation.NavigateTo("/customers");
    }

    private Ordering_Sorono_IT13.Models.Customer CloneCustomer(Ordering_Sorono_IT13.Models.Customer source)
    {
        return new Ordering_Sorono_IT13.Models.Customer
        {
            CustomerId = source.CustomerId,
            SegmentId = source.SegmentId,
            CreatedBy = source.CreatedBy,
            ModifiedBy = source.ModifiedBy,
            FirstName = source.FirstName,
            LastName = source.LastName,
            Email = source.Email,
            Phone = source.Phone,
            CompanyName = source.CompanyName,
            Address = source.Address,
            City = source.City,
            StateProvince = source.StateProvince,
            PostalCode = source.PostalCode,
            Country = source.Country,
            CustomerStatus = source.CustomerStatus,
            TotalRevenue = source.TotalRevenue,
            Source = source.Source,
            Notes = source.Notes,
            IsActive = source.IsActive,
            IsArchived = source.IsArchived,
            ArchivedDate = source.ArchivedDate,
            ArchivedBy = source.ArchivedBy,
            CreatedDate = source.CreatedDate,
            ModifiedDate = source.ModifiedDate,
            SegmentName = source.SegmentName
        };
    }
}
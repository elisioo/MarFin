@page "/login"
@using MarFin_Final.Components.Layout
@using MarFin_Final.Database.Services
@using MarFin_Final.Models
@layout LoginLayout
@inject NavigationManager Navigation
@inject AuthService AuthService

<div class="login-container">
    <div class="login-card">
        <div class="login-header">
            <div class="logo-section">
                <img src="img/logo_only.png" alt="MarFin Logo" class="login-logo" />
                <h1>MarFin</h1>
            </div>
            <p class="login-subtitle">Sign in to your account</p>
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="error-message">
                <i class="bi bi-exclamation-circle"></i>
                <span>@errorMessage</span>
            </div>
        }

        <form class="login-form" @onsubmit="HandleLogin">
            <div class="form-group">
                <label for="email">Email Address</label>
                <div class="input-wrapper">
                    <i class="bi bi-envelope input-icon"></i>
                    <input type="email"
                           id="email"
                           class="form-input"
                           placeholder="Enter your email"
                           @bind="loginRequest.Email"
                           required />
                </div>
            </div>

            <div class="form-group">
                <label for="password">Password</label>
                <div class="input-wrapper">
                    <i class="bi bi-lock input-icon"></i>
                    <input type="@(showPassword ? "text" : "password")"
                           id="password"
                           class="form-input"
                           placeholder="Enter your password"
                           @bind="loginRequest.Password"
                           minlength="12"
                           required />
                    <button type="button"
                            class="toggle-password"
                            @onclick="TogglePasswordVisibility">
                        <i class="bi @(showPassword ? "bi-eye-slash" : "bi-eye")"></i>
                    </button>
                </div>
            </div>

            <div class="form-options">
                <label class="remember-me">
                    <input type="checkbox" @bind="loginRequest.RememberMe" />
                    <span>Remember me</span>
                </label>
                <a href="#" class="forgot-password">Forgot password?</a>
            </div>

            <button type="submit" class="btn-login" disabled="@isLoading">
                @if (isLoading)
                {
                    <span class="spinner"></span>
                    <span>Signing in...</span>
                }
                else
                {
                    <span>Sign In</span>
                    <i class="bi bi-arrow-right"></i>
                }
            </button>
        </form>

        <div class="login-footer">
            <p>Don't have an account? <a href="/register">Sign up</a></p>
        </div>
    </div>

    <div class="login-info">
        <div class="info-content">
            <h2>Welcome to MarFin</h2>
            <p>Your comprehensive CRM solution for managing customers, sales, marketing campaigns, and financial transactions all in one place.</p>
            <div class="features">
                <div class="feature-item">
                    <i class="bi bi-check-circle-fill"></i>
                    <span>Customer Management</span>
                </div>
                <div class="feature-item">
                    <i class="bi bi-check-circle-fill"></i>
                    <span>Sales Pipeline Tracking</span>
                </div>
                <div class="feature-item">
                    <i class="bi bi-check-circle-fill"></i>
                    <span>Marketing Campaigns</span>
                </div>
                <div class="feature-item">
                    <i class="bi bi-check-circle-fill"></i>
                    <span>Financial Reports</span>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private LoginRequest loginRequest = new();
    private bool showPassword = false;
    private bool isLoading = false;
    private string errorMessage = "";

    protected override void OnInitialized()
    {
        // If already authenticated, redirect to home
        if (AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/", true);
        }
    }

    private void TogglePasswordVisibility()
    {
        showPassword = !showPassword;
    }

    private async Task HandleLogin()
    {
        errorMessage = "";
        isLoading = true;

        // Simulate loading delay
        await Task.Delay(500);

        var result = await AuthService.LoginAsync(loginRequest);

        if (result.Success)
        {
            // Successful login - navigate to home
            Navigation.NavigateTo("/", true);
        }
        else
        {
            errorMessage = result.Message;
            isLoading = false;
        }
    }
}
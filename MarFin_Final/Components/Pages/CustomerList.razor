@page "/customers"
@inject NavigationManager Navigation
@inject AuthService AuthService
@using Ordering_Sorono_IT13.Data
@using Ordering_Sorono_IT13.Models

<div class="customers-container">
    <div class="customers-header">
        <div class="header-title">
            <h1>Customers</h1>
            <span class="record-count">@allCustomers.Count records</span>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage) && !showModal)
    {
        <div class="alert alert-danger">@errorMessage</div>
    }

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success">@successMessage</div>
    }

    <div class="customers-toolbar">
        <button class="btn-primary" @onclick="ToggleModal">
            <span><i class="bi bi-plus-lg"></i></span> New Customer
        </button>
        <div class="toolbar-right">
            <button class="btn-secondary"><span><i class="bi bi-filter"></i></span> Filter by</button>
            <button class="btn-secondary"><span><i class="bi bi-arrow-down-up"></i></span> Sort by</button>
            <div class="search-box">
                <span class="search-icon"><i class="bi bi-search"></i></span>
                <input type="text"
                       placeholder="Search here.."
                       @bind="searchTerm"
                       @bind:event="oninput"
                       @onkeyup="SearchCustomers" />
            </div>
            <button class="btn-secondary">Export</button>
        </div>
    </div>

    @foreach (var group in GetGroupedCustomers())
    {
        <div class="customer-card">
            <div class="customer-card-header">
                <span class="customer-name">@group.Key</span>
                <button class="menu-btn">⋮</button>
            </div>

            <div class="customer-table">
                <div class="table-header">
                    <span>First Name</span>
                    <span>Last Name</span>
                    <span>Email</span>
                    <span>Status</span>
                </div>

                @foreach (var customer in group.Value)
                {
                    <div class="table-row" @onclick="() => NavigateToDetails(customer.CustomerId)">
                        <span>@customer.FirstName</span>
                        <span>@customer.LastName</span>
                        <span>@customer.Email</span>
                        <span>
                            <span class="status-badge status-@customer.CustomerStatus.ToLower()">
                                @customer.CustomerStatus
                            </span>
                        </span>
                    </div>
                }
            </div>
        </div>
    }

    @if (!filteredCustomers.Any())
    {
        <div class="empty-state">
            <i class="bi bi-inbox"></i>
            <p>No customers found</p>
        </div>
    }
</div>

@if (showModal)
{
    <div class="modal-overlay" @onclick="ToggleModal">
        <div class="modal-content" @onclick:stopPropagation>
            <div class="modal-header">
                <div class="modal-title">
                    <span class="user-icon"><i class="bi bi-person"></i></span>
                    <h2>@(isEditMode ? "Edit Customer" : "New Customer")</h2>
                </div>
                <div class="modal-actions">
                    <button class="btn-cancel" @onclick="ToggleModal">Cancel</button>
                    <button class="btn-save" @onclick="SaveCustomer">Save</button>
                </div>
            </div>

            <div class="modal-body">
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-danger">@errorMessage</div>
                }

                <div class="form-row">
                    <div class="form-group">
                        <label>First Name <span class="required">*</span></label>
                        <input type="text" class="form-control" @bind="editingCustomer.FirstName" />
                    </div>
                    <div class="form-group">
                        <label>Last Name <span class="required">*</span></label>
                        <input type="text" class="form-control" @bind="editingCustomer.LastName" />
                    </div>
                </div>

                <div class="form-group">
                    <label>Email Address <span class="required">*</span></label>
                    <input type="email" class="form-control" @bind="editingCustomer.Email" />
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="text" class="form-control" @bind="editingCustomer.Phone" />
                    </div>
                    <div class="form-group">
                        <label>Company Name</label>
                        <input type="text" class="form-control" @bind="editingCustomer.CompanyName" />
                    </div>
                </div>

                <div class="form-group">
                    <label>Address</label>
                    <input type="text" class="form-control" @bind="editingCustomer.Address" />
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>City</label>
                        <input type="text" class="form-control" @bind="editingCustomer.City" />
                    </div>
                    <div class="form-group">
                        <label>State/Province</label>
                        <input type="text" class="form-control" @bind="editingCustomer.StateProvince" />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Postal Code</label>
                        <input type="text" class="form-control" @bind="editingCustomer.PostalCode" />
                    </div>
                    <div class="form-group">
                        <label>Country</label>
                        <input type="text" class="form-control" @bind="editingCustomer.Country" />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Customer Status</label>
                        <select class="form-control" @bind="editingCustomer.CustomerStatus">
                            <option value="Lead">Lead</option>
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                            <option value="Dormant">Dormant</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Source</label>
                        <input type="text" class="form-control" @bind="editingCustomer.Source" placeholder="e.g., Website, Referral, Cold Call" />
                    </div>
                </div>

                <div class="form-group">
                    <label>Notes</label>
                    <textarea class="form-control" rows="3" @bind="editingCustomer.Notes"></textarea>
                </div>
            </div>
        </div>
    </div>
}

@if (showErrorModal)
{
    <div class="modal-overlay" @onclick="CloseErrorModal">
        <div class="modal-content error-modal" @onclick:stopPropagation>
            <div class="modal-header">
                <h2>Error</h2>
                <button class="btn-cancel" @onclick="CloseErrorModal">Close</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">@errorMessage</div>
            </div>
        </div>
    </div>
}

@code {
   private readonly CustomerService customerService = new();
    private List<Customer> allCustomers = new();
    private List<Customer> filteredCustomers = new();
    private string searchTerm = "";
    private bool showModal = false;
    private bool showErrorModal = false;
    private bool isEditMode = false;
    private Customer editingCustomer = new();
    private string errorMessage = "";
    private string successMessage = "";
    private int currentUserId = 1; // ← Make sure this matches a user_id in tbl_Users!

    protected override void OnInitialized()
    {
        if (!AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/login", true);
            return;
        }

        // Add debugging
        try
        {
            Console.WriteLine("Testing database connection...");
            bool connected = DBConnection.TestConnection();
            Console.WriteLine($"Connection test: {connected}");
            
            LoadCustomers();
        }
        catch (Exception ex)
        {
            errorMessage = $"Initialization error: {ex.Message}";
            showErrorModal = true;
            Console.WriteLine($"ERROR: {ex.Message}");
            Console.WriteLine($"Stack: {ex.StackTrace}");
        }
    }
    private void LoadCustomers()
    {
        try
        {
            allCustomers = customerService.GetAllCustomers() ?? new List<Customer>();
            filteredCustomers = new List<Customer>(allCustomers);
            errorMessage = "";
            showErrorModal = false;
        }
        catch (Exception ex)
        {
            errorMessage = "Error loading customers: " + ex.Message;
            showErrorModal = true;
        }
    }

    private void SearchCustomers()
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            filteredCustomers = new List<Customer>(allCustomers);
        }
        else
        {
            // assume service returns filtered list
            filteredCustomers = customerService.SearchCustomers(searchTerm) ?? new List<Customer>();
        }
    }

    private void ToggleModal()
    {
        // toggle modal, reset error when opening/closing modal
        showModal = !showModal;

        if (showModal && !isEditMode)
        {
            editingCustomer = new Customer
            {
                SegmentId = 1,
                CreatedBy = currentUserId,
                Country = "Philippines",
                CustomerStatus = "Lead",
                IsActive = true
            };
            errorMessage = "";
            showErrorModal = false;
        }

        if (!showModal)
        {
            // closing modal: reset edit mode and validation errors
            isEditMode = false;
            errorMessage = "";
            showErrorModal = false;
        }
    }

    private void OpenEditModal(Customer customer)
    {
        if (customer == null) return;

        isEditMode = true;
        editingCustomer = new Customer
        {
            CustomerId = customer.CustomerId,
            SegmentId = customer.SegmentId,
            CreatedBy = customer.CreatedBy,
            ModifiedBy = currentUserId,
            FirstName = customer.FirstName,
            LastName = customer.LastName,
            Email = customer.Email,
            Phone = customer.Phone,
            CompanyName = customer.CompanyName,
            Address = customer.Address,
            City = customer.City,
            StateProvince = customer.StateProvince,
            PostalCode = customer.PostalCode,
            Country = customer.Country,
            CustomerStatus = customer.CustomerStatus,
            Source = customer.Source,
            Notes = customer.Notes,
            IsActive = customer.IsActive
        };

        errorMessage = "";
        showErrorModal = false;
        showModal = true;
    }

    private void CloseErrorModal()
    {
        showErrorModal = false;
    }

    private void SaveCustomer()
    {
        // reset messages
        errorMessage = "";
        successMessage = "";
        showErrorModal = false;

        // simple client validation
        if (string.IsNullOrWhiteSpace(editingCustomer.FirstName))
        {
            errorMessage = "First name is required.";
            showErrorModal = true;
            return;
        }

        if (string.IsNullOrWhiteSpace(editingCustomer.LastName))
        {
            errorMessage = "Last name is required.";
            showErrorModal = true;
            return;
        }

        if (string.IsNullOrWhiteSpace(editingCustomer.Email))
        {
            errorMessage = "Email is required.";
            showErrorModal = true;
            return;
        }

        try
        {
            bool success;

            if (isEditMode)
            {
                // UpdateCustomer should return true/false and ideally set a descriptive error (see notes)
                success = customerService.UpdateCustomer(editingCustomer);

                if (!success)
                {
                    errorMessage = "Failed to update customer. Possible causes: validation error, duplicate data, or server error.";
                    showErrorModal = true;
                    return;
                }

                successMessage = "Customer updated successfully!";
            }
            else
            {
                success = customerService.AddCustomer(editingCustomer);

                if (!success)
                {
                    errorMessage = "Failed to add customer. Possible causes: duplicate email, invalid data, or server error.";
                    showErrorModal = true;
                    return;
                }

                successMessage = "Customer added successfully!";
            }

            // reload and close modal on success
            LoadCustomers();
            ToggleModal();
        }
        catch (Exception ex)
        {
            // show the real cause (be careful with exposing sensitive DB messages in production)
            errorMessage = "Error saving customer: " + ex.Message;
            showErrorModal = true;
        }
    }

    private void NavigateToDetails(int customerId)
    {
        Navigation.NavigateTo($"/customer-details/{customerId}");
    }

    private Dictionary<string, List<Customer>> GetGroupedCustomers()
    {
        return (filteredCustomers ?? new List<Customer>())
            .GroupBy(c => string.IsNullOrWhiteSpace(c.CompanyName) ? "Individual" : c.CompanyName)
            .ToDictionary(g => g.Key, g => g.ToList());
    }
}

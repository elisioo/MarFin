@page "/dashboard"
@using MarFin_Final.Database.Services
@using MarFin_Final.Database.Models

@if (isLoading)
{
    <div class="loading-spinner">
        <i class="bi bi-arrow-clockwise spin"></i>
        <p>Loading dashboard...</p>
    </div>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}
else
{
    <div class="dashboard-container">
        @if (_isRefreshing)
        {
            <div class="refresh-indicator">
                <i class="bi bi-arrow-clockwise spin"></i>
                Updating data...
            </div>
        }

        <div class="dashboard-header">
            <div>
                <h1>
                    @{
                        if (AuthService.IsFinance())
                        {
                            <text>Finance Dashboard</text>;
                        }
                        else if (AuthService.IsMarketing())
                        {
                            <text>Marketing Dashboard</text>;
                        }
                        else if (AuthService.IsSalesRep())
                        {
                            <text>Sales Dashboard</text>;
                        }
                        else
                        {
                            <text>Admin Dashboard</text>;
                        }
                    }
                </h1>
                <p class="subtitle">Real-time business insights and analytics</p>
            </div>
            <div class="header-actions">
                <button class="refresh-btn" @onclick="ManualRefresh" disabled="@isLoading">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
        </div>
        

        <div class="date-filters">
            <button class="filter-btn @(selectedFilter == "thisMonth" ? "active" : "")" @onclick='async () => await SetFilter("thisMonth")'>This Month</button>
            <button class="filter-btn @(selectedFilter == "last3Months" ? "active" : "")" @onclick='async () => await SetFilter("last3Months")'>Last 3 Months</button>
            <button class="filter-btn @(selectedFilter == "custom" ? "active" : "")" @onclick='async () => await SetFilter("custom")'>Custom Range</button>
            @if (selectedFilter == "custom")
            {
                <div class="date-inputs">
                    <input type="date" class="date-input" @bind="startDate" />
                    <span>to</span>
                    <input type="date" class="date-input" @bind="endDate" />
                </div>
                <button class="filter-btn" @onclick="OnDateChanged">Apply</button>
            }
        </div>

        <div class="kpi-row">
            @if (AuthService.IsAdmin() && adminStats != null)
            {
                <div class="kpi-card">
                    <div class="kpi-icon revenue"><i class="bi bi-currency-dollar"></i></div>
                    <div class="kpi-content">
                        <p class="kpi-label">Total Revenue</p>
                        <h2>₱@adminStats.TotalRevenue.ToString("N0")</h2>
                        <span class="kpi-change positive"><i class="bi bi-arrow-up"></i> ₱@adminStats.PeriodRevenue.ToString("N0") this period</span>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon conversion"><i class="bi bi-percent"></i></div>
                    <div class="kpi-content">
                        <p class="kpi-label">Conversion Rate</p>
                        <h2>@adminStats.ConversionRate.ToString("F1")%</h2>
                        <span class="kpi-change positive"><i class="bi bi-arrow-up"></i> Success rate</span>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon active"><i class="bi bi-megaphone"></i></div>
                    <div class="kpi-content">
                        <p class="kpi-label">Active Campaigns</p>
                        <h2>@adminStats.ActiveCampaigns</h2>
                        <span class="kpi-change positive"><i class="bi bi-arrow-up"></i> of @adminStats.TotalCampaigns total</span>
                    </div>
                </div>
            }
            else if (AuthService.IsFinance() && financeStats != null)
            {
                <div class="kpi-card">
                    <div class="kpi-icon revenue"><i class="bi bi-currency-dollar"></i></div>
                    <div class="kpi-content">
                        <p class="kpi-label">Total Revenue</p>
                        <h2>₱@financeStats.TotalRevenue.ToString("N0")</h2>
                        <span class="kpi-change positive"><i class="bi bi-arrow-up"></i> Collected</span>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon pending"><i class="bi bi-hourglass-split"></i></div>
                    <div class="kpi-content">
                        <p class="kpi-label">Pending Amount</p>
                        <h2>₱@financeStats.PendingAmount.ToString("N0")</h2>
                        <span class="kpi-change negative"><i class="bi bi-exclamation-circle"></i> Awaiting payment</span>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon invoices"><i class="bi bi-file-earmark"></i></div>
                    <div class="kpi-content">
                        <p class="kpi-label">Total Invoices</p>
                        <h2>@financeStats.TotalInvoices</h2>
                        <span class="kpi-change positive"><i class="bi bi-arrow-up"></i> This period</span>
                    </div>
                </div>
            }
            else if (AuthService.IsMarketing() && marketingStats != null)
            {
                <div class="kpi-card">
                    <div class="kpi-icon active"><i class="bi bi-megaphone"></i></div>
                    <div class="kpi-content">
                        <p class="kpi-label">Active Campaigns</p>
                        <h2>@marketingStats.ActiveCampaigns</h2>
                        <span class="kpi-change positive"><i class="bi bi-arrow-up"></i> Running</span>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon engagement"><i class="bi bi-envelope-open"></i></div>
                    <div class="kpi-content">
                        <p class="kpi-label">Emails Sent</p>
                        <h2>@marketingStats.TotalEmailsSent.ToString("N0")</h2>
                        <span class="kpi-change positive"><i class="bi bi-arrow-up"></i> This period</span>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon conversion"><i class="bi bi-percent"></i></div>
                    <div class="kpi-content">
                        <p class="kpi-label">Open Rate</p>
                        <h2>@marketingStats.ConversionRate.ToString("F1")%</h2>
                        <span class="kpi-change positive"><i class="bi bi-arrow-up"></i> Engagement</span>
                    </div>
                </div>
            }
            else if (AuthService.IsSalesRep() && salesStats != null)
            {
                <div class="kpi-card">
                    <div class="kpi-icon revenue"><i class="bi bi-currency-dollar"></i></div>
                    <div class="kpi-content">
                        <p class="kpi-label">Pipeline Value</p>
                        <h2>₱@salesStats.PipelineValue.ToString("N0")</h2>
                        <span class="kpi-change positive"><i class="bi bi-arrow-up"></i> Total</span>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon conversion"><i class="bi bi-percent"></i></div>
                    <div class="kpi-content">
                        <p class="kpi-label">Win Rate</p>
                        <h2>@salesStats.WinRate.ToString("F0")%</h2>
                        <span class="kpi-change positive"><i class="bi bi-arrow-up"></i> Success</span>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon active"><i class="bi bi-bullseye"></i></div>
                    <div class="kpi-content">
                        <p class="kpi-label">Closed Deals</p>
                        <h2>@salesStats.ClosedDeals</h2>
                        <span class="kpi-change positive"><i class="bi bi-arrow-up"></i> This period</span>
                    </div>
                </div>
            }
        </div>

        <div class="charts-grid">
            <div class="chart-card large">
                <div class="card-header"><h3>Revenue Trend</h3></div>
                @if (monthlyRevenueData?.Any() == true)
                {
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background-color: #f3f4f6; border-bottom: 2px solid #e5e7eb;">
                                    <th style="padding: 12px; text-align: left;">Month</th>
                                    <th style="padding: 12px; text-align: right;">Revenue</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in monthlyRevenueData)
                                {
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 12px;">@item.Month</td>
                                        <td style="padding: 12px; text-align: right;">₱@item.Revenue.ToString("N0")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="no-data-chart"><i class="bi bi-graph-up"></i><p>No revenue data available</p></div>
                }
            </div>

            <div class="chart-card">
                <div class="card-header"><h3>Lead Sources</h3></div>
                @if (leadSourcesData?.Any() == true)
                {
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background-color: #f3f4f6; border-bottom: 2px solid #e5e7eb;">
                                    <th style="padding: 12px; text-align: left;">Source</th>
                                    <th style="padding: 12px; text-align: right;">Count</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in leadSourcesData)
                                {
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 12px;">@item.Category</td>
                                        <td style="padding: 12px; text-align: right;">@item.Value</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="no-data-chart"><i class="bi bi-funnel"></i><p>No lead sources data available</p></div>
                }
            </div>

            <div class="chart-card">
                <div class="card-header"><h3>Revenue by Segment</h3></div>
                @if (revenueBySegmentData?.Any() == true)
                {
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background-color: #f3f4f6; border-bottom: 2px solid #e5e7eb;">
                                    <th style="padding: 12px; text-align: left;">Segment</th>
                                    <th style="padding: 12px; text-align: right;">Revenue</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in revenueBySegmentData)
                                {
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 12px;">@item.Category</td>
                                        <td style="padding: 12px; text-align: right;">₱@item.Value.ToString("N0")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="no-data-chart"><i class="bi bi-pie-chart"></i><p>No segment data available</p></div>
                }
            </div>

            @if (AuthService.IsSalesRep())
            {
                <div class="chart-card">
                    <div class="card-header"><h3>Pipeline by Stage</h3></div>
                    @if (salesPipelineData?.Any() == true)
                    {
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background-color: #f3f4f6; border-bottom: 2px solid #e5e7eb;">
                                        <th style="padding: 12px; text-align: left;">Stage</th>
                                        <th style="padding: 12px; text-align: right;">Opportunities</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in salesPipelineData)
                                    {
                                        <tr style="border-bottom: 1px solid #e5e7eb;">
                                            <td style="padding: 12px;">@item.Category</td>
                                            <td style="padding: 12px; text-align: right;">@item.Value</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="no-data-chart"><i class="bi bi-diagram-3"></i><p>No pipeline data available</p></div>
                    }
                </div>
            }

            @if (AuthService.IsMarketing())
            {
                <div class="chart-card large">
                    <div class="card-header"><h3>Campaign Performance</h3></div>
                    @if (campaignMetricsData?.Any() == true)
                    {
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background-color: #f3f4f6; border-bottom: 2px solid #e5e7eb;">
                                        <th style="padding: 12px; text-align: left;">Campaign</th>
                                        <th style="padding: 12px; text-align: right;">Sent</th>
                                        <th style="padding: 12px; text-align: right;">Opened</th>
                                        <th style="padding: 12px; text-align: right;">Converted</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in campaignMetricsData)
                                    {
                                        <tr style="border-bottom: 1px solid #e5e7eb;">
                                            <td style="padding: 12px;">@item.CampaignName</td>
                                            <td style="padding: 12px; text-align: right;">@item.Sent</td>
                                            <td style="padding: 12px; text-align: right;">@item.Opened</td>
                                            <td style="padding: 12px; text-align: right;">@item.Converted</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="no-data-chart"><i class="bi bi-megaphone"></i><p>No campaign data available</p></div>
                    }
                </div>
            }
        </div>

        @if (AuthService.IsAdmin() || AuthService.IsFinance())
        {
            <div class="chart-card large" style="margin-top: 2rem;">
                <div class="card-header"><h3>Financial Overview - OHLC</h3></div>
                @if (financialData?.Any() == true)
                {
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background-color: #f3f4f6; border-bottom: 2px solid #e5e7eb;">
                                    <th style="padding: 12px; text-align: left;">Date</th>
                                    <th style="padding: 12px; text-align: right;">Open</th>
                                    <th style="padding: 12px; text-align: right; color: #10b981;">High</th>
                                    <th style="padding: 12px; text-align: right; color: #ef4444;">Low</th>
                                    <th style="padding: 12px; text-align: right; font-weight: bold;">Close</th>
                                    <th style="padding: 12px; text-align: right;">Change %</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var point in financialData.OrderByDescending(x => x.Date))
                                {
                                    var change = point.Close - point.Open;
                                    var changePercent = point.Open > 0 ? (change / point.Open) * 100 : 0;
                                    var changeColor = change >= 0 ? "#10b981" : "#ef4444";
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 12px;">@point.Date.ToString("MMM dd, yyyy")</td>
                                        <td style="padding: 12px; text-align: right;">₱@point.Open.ToString("N0")</td>
                                        <td style="padding: 12px; text-align: right; color: #10b981;">₱@point.High.ToString("N0")</td>
                                        <td style="padding: 12px; text-align: right; color: #ef4444;">₱@point.Low.ToString("N0")</td>
                                        <td style="padding: 12px; text-align: right; font-weight: bold;">₱@point.Close.ToString("N0")</td>
                                        <td style="padding: 12px; text-align: right; color: @changeColor;">@changePercent.ToString("F2")%</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="no-data-chart"><i class="bi bi-graph-up-arrow"></i><p>No financial data available</p></div>
                }
            </div>
        }

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 2rem;">
            <div class="chart-card">
                <div class="section-header">
                    <h3>Recent Activities</h3>
                    <button class="refresh-icon" @onclick="RefreshActivities"><i class="bi bi-arrow-clockwise"></i></button>
                </div>
                @if (activities?.Any() == true)
                {
                    <div class="activity-list">
                        @foreach (var activity in activities)
                        {
                            <div class="activity-item">
                                <div class="activity-icon-dot @activity.Type"></div>
                                <div class="activity-details">
                                    <p class="activity-text">@activity.Text</p>
                                    <p class="activity-time">@activity.Time</p>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="no-data">No recent activities</p>
                }
            </div>

            @if ((AuthService.IsAdmin() || AuthService.IsFinance()) && recentTransactions?.Any() == true)
            {
                <div class="chart-card">
                    <div class="section-header">
                        <h3>Recent Transactions</h3>
                        <a href="/transactions" class="view-all-link">View All <i class="bi bi-arrow-right"></i></a>
                    </div>
                    <div class="transactions-table">
                        <div class="table-header">
                            <span>Invoice</span><span>Customer</span><span>Amount</span><span>Date</span><span>Status</span>
                        </div>
                        @foreach (var transaction in recentTransactions.Take(5))
                        {
                            <div class="table-row">
                                <span class="transaction-invoice">@transaction.Invoice</span>
                                <span class="transaction-customer">@transaction.Customer</span>
                                <span class="transaction-amount">@transaction.Amount</span>
                                <span class="transaction-date">@transaction.Date</span>
                                <span class="transaction-status @transaction.Status.ToLower()">@transaction.Status</span>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
}

@inject NavigationManager Navigation
@inject AuthService AuthService
@inject DashboardService DashboardService

@code {
    private bool isLoading = true;
    private bool _isRefreshing = false;
    private string errorMessage = "";
    private System.Threading.Timer? _refreshTimer;

    private string selectedFilter = "thisMonth";
    private DateTime startDate = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1);
    private DateTime endDate = DateTime.Now;

    private AdminDashboardStats? adminStats;
    private FinanceDashboardStats? financeStats;
    private MarketingDashboardStats? marketingStats;
    private SalesDashboardStats? salesStats;

    private List<LineChartData>? monthlyRevenueData;
    private List<BarChartData>? leadSourcesData;
    private List<BarChartData>? revenueBySegmentData;
    private List<BarChartData>? salesPipelineData;
    private List<CampaignMetrics>? campaignMetricsData;
    private List<FinancialPoint>? financialData;

    private List<ActivityItem>? activities;
    private List<TransactionItem>? recentTransactions;

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/login", true);
            return;
        }

        await LoadDashboardDataAsync();
        _refreshTimer = new System.Threading.Timer(async _ => await RefreshDashboard(), null, TimeSpan.FromSeconds(30), TimeSpan.FromSeconds(30));
    }

    private async Task RefreshDashboard()
    {
        if (_isRefreshing) return;
        _isRefreshing = true;
        try
        {
            await InvokeAsync(async () =>
            {
                await LoadDashboardDataAsync();
                StateHasChanged();
            });
        }
        finally
        {
            _isRefreshing = false;
        }
    }

    public void Dispose() => _refreshTimer?.Dispose();

    private async Task LoadDashboardDataAsync()
    {
        isLoading = true;
        try
        {
            var role = AuthService.GetUserRole();
            var userId = AuthService.GetUserId();

            if (role == "Admin") adminStats = await DashboardService.GetAdminStatsAsync(startDate, endDate);
            else if (role == "Finance") financeStats = await DashboardService.GetFinanceStatsAsync(startDate, endDate);
            else if (role == "Marketing") marketingStats = await DashboardService.GetMarketingStatsAsync(startDate, endDate);
            else if (role == "SalesRep") salesStats = await DashboardService.GetSalesStatsAsync(userId, startDate, endDate);

            monthlyRevenueData = await DashboardService.GetMonthlyRevenueComparisonAsync(startDate, endDate);
            leadSourcesData = await DashboardService.GetLeadSourcesAsync(startDate, endDate);
            revenueBySegmentData = await DashboardService.GetRevenueBySegmentAsync(startDate, endDate);

            if (role == "SalesRep") salesPipelineData = await DashboardService.GetSalesPipelineByStageAsync(userId);
            if (role == "Marketing") campaignMetricsData = await DashboardService.GetCampaignPerformanceAsync(startDate, endDate);

            activities = await DashboardService.GetRecentActivitiesAsync(role, userId);

            if (role == "Admin" || role == "Finance")
            {
                recentTransactions = await DashboardService.GetRecentTransactionsAsync();
                financialData = await DashboardService.GetFinancialDataAsync(startDate, endDate);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading dashboard: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SetFilter(string filter)
    {
        selectedFilter = filter;
        if (filter == "thisMonth")
        {
            startDate = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1);
            endDate = DateTime.Now;
        }
        else if (filter == "last3Months")
        {
            startDate = DateTime.Now.AddMonths(-3);
            endDate = DateTime.Now;
        }
        await LoadDashboardDataAsync();
    }

    private async Task OnDateChanged() => await LoadDashboardDataAsync();

    private async Task RefreshActivities()
    {
        try
        {
            var role = AuthService.GetUserRole();
            activities = await DashboardService.GetRecentActivitiesAsync(role, AuthService.GetUserId());
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error refreshing activities: {ex.Message}");
        }
    }

    private async Task ManualRefresh() => await RefreshDashboard();
}

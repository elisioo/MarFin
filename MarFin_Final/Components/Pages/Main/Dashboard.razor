@page "/dashboard"
@using MarFin_Final.Database.Services
@using MarFin_Final.Database.Models
@using Microsoft.JSInterop

@if (isLoading)
{
    <div class="loading-spinner">
        <i class="bi bi-arrow-clockwise spin"></i>
        <p>Loading dashboard...</p>
    </div>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}
else
{
    <div class="dashboard-container">
        @if (_isRefreshing)
        {
            <div class="refresh-indicator">
                <i class="bi bi-arrow-clockwise spin"></i>
                Updating data...
            </div>
        }

        <div class="dashboard-header">
            <div>
                <h1>
                    @{
                        if (AuthService.IsFinance())
                        {
                            <text>Finance Dashboard</text>
                            ;
                        }
                        else if (AuthService.IsMarketing())
                        {
                            <text>Marketing Dashboard</text>
                            ;
                        }
                        else if (AuthService.IsSalesRep())
                        {
                            <text>Sales Dashboard</text>
                            ;
                        }
                        else
                        {
                            <text>Admin Dashboard</text>
                            ;
                        }
                    }
                </h1>
                <p class="subtitle">Real-time business insights and analytics</p>
            </div>
            <div class="header-actions">
                <button class="refresh-btn" @onclick="ManualRefresh" disabled="@isLoading">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
        </div>

        <div class="date-filters">
            <button class="filter-btn @(selectedFilter == "thisMonth" ? "active" : "")" @onclick='async () => await SetFilter("thisMonth")'>This Month</button>
            <button class="filter-btn @(selectedFilter == "last3Months" ? "active" : "")" @onclick='async () => await SetFilter("last3Months")'>Last 3 Months</button>
            <button class="filter-btn @(selectedFilter == "custom" ? "active" : "")" @onclick='async () => await SetFilter("custom")'>Custom Range</button>
            @if (selectedFilter == "custom")
            {
                <div class="date-inputs">
                    <input type="date" class="date-input" @bind="startDate" />
                    <span>to</span>
                    <input type="date" class="date-input" @bind="endDate" />
                </div>
                <button class="filter-btn" @onclick="OnDateChanged">Apply</button>
            }
        </div>

        <div class="kpi-row">
            @if (AuthService.IsAdmin() && adminStats != null)
            {
                <div class="kpi-card">
                    <div class="kpi-icon revenue"><i class="bi bi-currency-dollar"></i></div>
                    <div class="kpi-content">
                        <p class="kpi-label">Total Revenue</p>
                        <h2>₱@adminStats.TotalRevenue.ToString("N0")</h2>
                        <span class="kpi-change positive"><i class="bi bi-arrow-up"></i> ₱@adminStats.PeriodRevenue.ToString("N0") this period</span>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon conversion"><i class="bi bi-percent"></i></div>
                    <div class="kpi-content">
                        <p class="kpi-label">Conversion Rate</p>
                        <h2>@adminStats.ConversionRate.ToString("F1")%</h2>
                        <span class="kpi-change positive"><i class="bi bi-arrow-up"></i> Success rate</span>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon active"><i class="bi bi-megaphone"></i></div>
                    <div class="kpi-content">
                        <p class="kpi-label">Active Campaigns</p>
                        <h2>@adminStats.ActiveCampaigns</h2>
                        <span class="kpi-change positive"><i class="bi bi-arrow-up"></i> of @adminStats.TotalCampaigns total</span>
                    </div>
                </div>
            }
            else if (AuthService.IsFinance() && financeStats != null)
            {
                <div class="kpi-card">
                    <div class="kpi-icon revenue"><i class="bi bi-currency-dollar"></i></div>
                    <div class="kpi-content">
                        <p class="kpi-label">Total Revenue</p>
                        <h2>₱@financeStats.TotalRevenue.ToString("N0")</h2>
                        <span class="kpi-change positive"><i class="bi bi-arrow-up"></i> Collected</span>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon pending"><i class="bi bi-hourglass-split"></i></div>
                    <div class="kpi-content">
                        <p class="kpi-label">Pending Amount</p>
                        <h2>₱@financeStats.PendingAmount.ToString("N0")</h2>
                        <span class="kpi-change negative"><i class="bi bi-exclamation-circle"></i> Awaiting payment</span>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon invoices"><i class="bi bi-file-earmark"></i></div>
                    <div class="kpi-content">
                        <p class="kpi-label">Total Invoices</p>
                        <h2>@financeStats.TotalInvoices</h2>
                        <span class="kpi-change positive"><i class="bi bi-arrow-up"></i> This period</span>
                    </div>
                </div>
            }
            else if (AuthService.IsMarketing() && marketingStats != null)
            {
                <div class="kpi-card">
                    <div class="kpi-icon active"><i class="bi bi-megaphone"></i></div>
                    <div class="kpi-content">
                        <p class="kpi-label">Active Campaigns</p>
                        <h2>@marketingStats.ActiveCampaigns</h2>
                        <span class="kpi-change positive"><i class="bi bi-arrow-up"></i> Running</span>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon engagement"><i class="bi bi-envelope-open"></i></div>
                    <div class="kpi-content">
                        <p class="kpi-label">Emails Sent</p>
                        <h2>@marketingStats.TotalEmailsSent.ToString("N0")</h2>
                        <span class="kpi-change positive"><i class="bi bi-arrow-up"></i> This period</span>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon conversion"><i class="bi bi-percent"></i></div>
                    <div class="kpi-content">
                        <p class="kpi-label">Open Rate</p>
                        <h2>@marketingStats.ConversionRate.ToString("F1")%</h2>
                        <span class="kpi-change positive"><i class="bi bi-arrow-up"></i> Engagement</span>
                    </div>
                </div>
            }
            else if (AuthService.IsSalesRep() && salesStats != null)
            {
                <div class="kpi-card">
                    <div class="kpi-icon revenue"><i class="bi bi-currency-dollar"></i></div>
                    <div class="kpi-content">
                        <p class="kpi-label">Pipeline Value</p>
                        <h2>₱@salesStats.PipelineValue.ToString("N0")</h2>
                        <span class="kpi-change positive"><i class="bi bi-arrow-up"></i> Total</span>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon conversion"><i class="bi bi-percent"></i></div>
                    <div class="kpi-content">
                        <p class="kpi-label">Win Rate</p>
                        <h2>@salesStats.WinRate.ToString("F0")%</h2>
                        <span class="kpi-change positive"><i class="bi bi-arrow-up"></i> Success</span>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon active"><i class="bi bi-bullseye"></i></div>
                    <div class="kpi-content">
                        <p class="kpi-label">Closed Deals</p>
                        <h2>@salesStats.ClosedDeals</h2>
                        <span class="kpi-change positive"><i class="bi bi-arrow-up"></i> This period</span>
                    </div>
                </div>
            }
        </div>

        <div class="charts-grid">
            <div class="chart-card large">
                <div class="card-header"><h3>Revenue Trend</h3></div>
                @if (monthlyRevenueData?.Any() == true)
                {
                    <div style="height: 300px;">
                        <canvas id="revenueChart"></canvas>
                    </div>
                }
                else
                {
                    <div class="no-data-chart"><i class="bi bi-graph-up"></i><p>No revenue data available</p></div>
                }
            </div>

            <div class="chart-card">
                <div class="card-header"><h3>Lead Sources</h3></div>
                @if (leadSourcesData?.Any() == true)
                {
                    <div style="height: 300px;">
                        <canvas id="leadSourcesChart"></canvas>
                    </div>
                }
                else
                {
                    <div class="no-data-chart"><i class="bi bi-funnel"></i><p>No lead sources data available</p></div>
                }
            </div>

            <div class="chart-card">
                <div class="card-header"><h3>Revenue by Segment</h3></div>
                @if (revenueBySegmentData?.Any() == true)
                {
                    <div style="height: 300px;">
                        <canvas id="segmentChart"></canvas>
                    </div>
                }
                else
                {
                    <div class="no-data-chart"><i class="bi bi-pie-chart"></i><p>No segment data available</p></div>
                }
            </div>

            @if (AuthService.IsSalesRep())
            {
                <div class="chart-card">
                    <div class="card-header"><h3>Pipeline by Stage</h3></div>
                    @if (salesPipelineData?.Any() == true)
                    {
                        <div style="height: 300px;">
                            <canvas id="pipelineChart"></canvas>
                        </div>
                    }
                    else
                    {
                        <div class="no-data-chart"><i class="bi bi-diagram-3"></i><p>No pipeline data available</p></div>
                    }
                </div>
            }

            @if (AuthService.IsMarketing())
            {
                <div class="chart-card large">
                    <div class="card-header"><h3>Campaign Performance</h3></div>
                    @if (campaignMetricsData?.Any() == true)
                    {
                        <div style="height: 300px;">
                            <canvas id="campaignChart"></canvas>
                        </div>
                    }
                    else
                    {
                        <div class="no-data-chart"><i class="bi bi-megaphone"></i><p>No campaign data available</p></div>
                    }
                </div>
            }
        </div>

        @if (AuthService.IsAdmin() || AuthService.IsFinance())
        {
            <div class="chart-card large" style="margin-top: 2rem;">
                <div class="card-header"><h3>Financial Overview - OHLC</h3></div>
                @if (financialData?.Any() == true)
                {
                    <div style="height: 350px;">
                        <canvas id="ohlcChart"></canvas>
                    </div>
                }
                else
                {
                    <div class="no-data-chart"><i class="bi bi-graph-up-arrow"></i><p>No financial data available</p></div>
                }
            </div>
        }

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 2rem;">
            <div class="chart-card">
                <div class="section-header">
                    <h3>Recent Activities</h3>
                    <button class="refresh-icon" @onclick="RefreshActivities"><i class="bi bi-arrow-clockwise"></i></button>
                </div>
                @if (activities?.Any() == true)
                {
                    <div class="activity-list">
                        @foreach (var activity in activities)
                        {
                            <div class="activity-item">
                                <div class="activity-icon-dot @activity.Type"></div>
                                <div class="activity-details">
                                    <p class="activity-text">@activity.Text</p>
                                    <p class="activity-time">@activity.Time</p>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="no-data">No recent activities</p>
                }
            </div>

            @if ((AuthService.IsAdmin() || AuthService.IsFinance()) && recentTransactions?.Any() == true)
            {
                <div class="chart-card">
                    <div class="section-header">
                        <h3>Recent Transactions</h3>
                        <a href="/transactions" class="view-all-link">View All <i class="bi bi-arrow-right"></i></a>
                    </div>
                    <div class="transactions-table">
                        <div class="table-header">
                            <span>Invoice</span><span>Customer</span><span>Amount</span><span>Date</span><span>Status</span>
                        </div>
                        @foreach (var transaction in recentTransactions.Take(5))
                        {
                            <div class="table-row">
                                <span class="transaction-invoice">@transaction.Invoice</span>
                                <span class="transaction-customer">@transaction.Customer</span>
                                <span class="transaction-amount">@transaction.Amount</span>
                                <span class="transaction-date">@transaction.Date</span>
                                <span class="transaction-status @transaction.Status.ToLower()">@transaction.Status</span>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
}

@inject NavigationManager Navigation
@inject AuthService AuthService
@inject DashboardService DashboardService
@inject IJSRuntime JSRuntime

@code {
    private bool isLoading = true;
    private bool _isRefreshing = false;
    private string errorMessage = "";
    private System.Threading.Timer? _refreshTimer;

    private string selectedFilter = "thisMonth";
    private DateTime startDate = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1);
    private DateTime endDate = DateTime.Now;

    private AdminDashboardStats? adminStats;
    private FinanceDashboardStats? financeStats;
    private MarketingDashboardStats? marketingStats;
    private SalesDashboardStats? salesStats;

    private List<LineChartData>? monthlyRevenueData;
    private List<BarChartData>? leadSourcesData;
    private List<BarChartData>? revenueBySegmentData;
    private List<BarChartData>? salesPipelineData;
    private List<CampaignMetrics>? campaignMetricsData;
    private List<FinancialPoint>? financialData;

    private List<ActivityItem>? activities;
    private List<TransactionItem>? recentTransactions;

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/login", true);
            return;
        }

        await LoadDashboardDataAsync();
        _refreshTimer = new System.Threading.Timer(async _ => await RefreshDashboard(), null, TimeSpan.FromSeconds(30), TimeSpan.FromSeconds(30));
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender && !isLoading)
        {
            await RenderChartsAsync();
        }
    }

    private async Task RenderChartsAsync()
    {
        try
        {
            // Revenue Trend Chart
            if (monthlyRevenueData?.Any() == true)
            {
                var labels = monthlyRevenueData.Select(x => x.Month).ToArray();
                var data = monthlyRevenueData.Select(x => x.Revenue).ToArray();

                await JSRuntime.InvokeVoidAsync("chartJsInterop.createLineChart",
                    "revenueChart",
                    labels,
                    new object[] {
                        new {
                            label = "Revenue",
                            data = data,
                            borderColor = "#667eea",
                            backgroundColor = "rgba(102, 126, 234, 0.1)",
                            tension = 0.4,
                            fill = true
                        }
                    });
            }

            // Lead Sources Chart
            if (leadSourcesData?.Any() == true)
            {
                var labels = leadSourcesData.Select(x => x.Category).ToArray();
                var data = leadSourcesData.Select(x => x.Value).ToArray();

                await JSRuntime.InvokeVoidAsync("chartJsInterop.createPieChart",
                    "leadSourcesChart",
                    labels,
                    data);
            }

            // Revenue by Segment Chart
            if (revenueBySegmentData?.Any() == true)
            {
                var labels = revenueBySegmentData.Select(x => x.Category).ToArray();
                var data = revenueBySegmentData.Select(x => x.Value).ToArray();

                await JSRuntime.InvokeVoidAsync("chartJsInterop.createBarChart",
                    "segmentChart",
                    labels,
                    new object[] {
                        new {
                            label = "Revenue",
                            data = data,
                            backgroundColor = new[] { "#667eea", "#764ba2", "#f093fb", "#f5576c", "#4facfe" },
                            borderWidth = 0
                        }
                    });
            }

            // Sales Pipeline Chart
            if (AuthService.IsSalesRep() && salesPipelineData?.Any() == true)
            {
                var labels = salesPipelineData.Select(x => x.Category).ToArray();
                var data = salesPipelineData.Select(x => x.Value).ToArray();

                await JSRuntime.InvokeVoidAsync("chartJsInterop.createBarChart",
                    "pipelineChart",
                    labels,
                    new object[] {
                        new {
                            label = "Opportunities",
                            data = data,
                            backgroundColor = new[] { "#4facfe", "#00f2fe", "#667eea", "#764ba2" },
                            borderWidth = 0
                        }
                    });
            }

            // Campaign Performance Chart
            if (AuthService.IsMarketing() && campaignMetricsData?.Any() == true)
            {
                var labels = campaignMetricsData.Select(x => x.CampaignName).ToArray();
                var sentData = campaignMetricsData.Select(x => x.Sent).ToArray();
                var openedData = campaignMetricsData.Select(x => x.Opened).ToArray();
                var convertedData = campaignMetricsData.Select(x => x.Converted).ToArray();

                await JSRuntime.InvokeVoidAsync("chartJsInterop.createBarChart",
                    "campaignChart",
                    labels,
                    new object[] {
                        new {
                            label = "Sent",
                            data = sentData,
                            backgroundColor = "#667eea"
                        },
                        new {
                            label = "Opened",
                            data = openedData,
                            backgroundColor = "#4facfe"
                        },
                        new {
                            label = "Converted",
                            data = convertedData,
                            backgroundColor = "#10b981"
                        }
                    },
                    new { plugins = new { legend = new { display = true } } });
            }

            // OHLC Chart
            if ((AuthService.IsAdmin() || AuthService.IsFinance()) && financialData?.Any() == true)
            {
                var ohlcData = financialData.Select(x => new
                {
                    date = x.Date.ToString("MMM dd"),
                    open = x.Open,
                    high = x.High,
                    low = x.Low,
                    close = x.Close
                }).ToArray();

                await JSRuntime.InvokeVoidAsync("chartJsInterop.createOHLCChart",
                    "ohlcChart",
                    ohlcData);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error rendering charts: {ex.Message}");
        }
    }

    private async Task RefreshDashboard()
    {
        if (_isRefreshing) return;
        _isRefreshing = true;
        try
        {
            await InvokeAsync(async () =>
            {
                await LoadDashboardDataAsync();
                await RenderChartsAsync();
                StateHasChanged();
            });
        }
        finally
        {
            _isRefreshing = false;
        }
    }

    public void Dispose() => _refreshTimer?.Dispose();

    private async Task LoadDashboardDataAsync()
    {
        isLoading = true;
        try
        {
            var role = AuthService.GetUserRole();
            var userId = AuthService.GetUserId();

            if (role == "Admin") adminStats = await DashboardService.GetAdminStatsAsync(startDate, endDate);
            else if (role == "Finance") financeStats = await DashboardService.GetFinanceStatsAsync(startDate, endDate);
            else if (role == "Marketing") marketingStats = await DashboardService.GetMarketingStatsAsync(startDate, endDate);
            else if (role == "SalesRep") salesStats = await DashboardService.GetSalesStatsAsync(userId, startDate, endDate);

            monthlyRevenueData = await DashboardService.GetMonthlyRevenueComparisonAsync(startDate, endDate);
            leadSourcesData = await DashboardService.GetLeadSourcesAsync(startDate, endDate);
            revenueBySegmentData = await DashboardService.GetRevenueBySegmentAsync(startDate, endDate);

            if (role == "SalesRep") salesPipelineData = await DashboardService.GetSalesPipelineByStageAsync(userId);
            if (role == "Marketing") campaignMetricsData = await DashboardService.GetCampaignPerformanceAsync(startDate, endDate);

            activities = await DashboardService.GetRecentActivitiesAsync(role, userId);

            if (role == "Admin" || role == "Finance")
            {
                recentTransactions = await DashboardService.GetRecentTransactionsAsync();
                financialData = await DashboardService.GetFinancialDataAsync(startDate, endDate);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading dashboard: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SetFilter(string filter)
    {
        selectedFilter = filter;
        if (filter == "thisMonth")
        {
            startDate = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1);
            endDate = DateTime.Now;
        }
        else if (filter == "last3Months")
        {
            startDate = DateTime.Now.AddMonths(-3);
            endDate = DateTime.Now;
        }
        await LoadDashboardDataAsync();
    }

    private async Task OnDateChanged() => await LoadDashboardDataAsync();

    private async Task RefreshActivities()
    {
        try
        {
            var role = AuthService.GetUserRole();
            activities = await DashboardService.GetRecentActivitiesAsync(role, AuthService.GetUserId());
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error refreshing activities: {ex.Message}");
        }
    }

    private async Task ManualRefresh() => await RefreshDashboard();
}
@page "/settings"
@inject NavigationManager Navigation
@inject AuthService AuthService
@inject RemoteDatabaseService RemoteDbService
@inject LocalDatabaseService LocalDbService
@inject UserService UserService
@inject AutoSyncService AutoSyncService

@using MarFin_Final.Data
@using MarFin_Final.Database.Services
@using MarFin_Final.Models
@using MarFin_Final.Services

<div class="settings-container light-theme">
    <div class="settings-header">
        <h1>Settings</h1>
        <p class="settings-subtitle">Manage your preferences and account settings</p>
    </div>

    <div class="settings-content">
        <!-- Settings Sidebar -->
        <div class="settings-sidebar">
            <div class="settings-menu">
                <button class="settings-menu-item @(activeTab == "sync" ? "active" : "")"
                        @onclick='() => SelectTab("sync")'>
                    <i class="bi bi-cloud-arrow-up"></i>
                    <span>Data Sync</span>
                </button>
                <button class="settings-menu-item @(activeTab == "account" ? "active" : "")"
                        @onclick='() => SelectTab("account")'>
                    <i class="bi bi-person"></i>
                    <span>Account</span>
                </button>
            </div>
        </div>

        <!-- Settings Content -->
        <div class="settings-main">
      
            <!-- Data Sync Tab -->
            @if (activeTab == "sync")
            {
                <div class="settings-section">
                    <div class="section-header">
                        <h2>Data Sync</h2>
                        <p>Synchronize your data with DatabaseASP.NET server</p>
                    </div>

                    <!-- Sync Status Card -->
                    <div class="settings-card">
                        <div class="card-header">
                            <h3>Sync Status</h3>
                            <p>Current synchronization status</p>
                        </div>
                        <div class="card-content">
                            <div class="sync-status">
                                <div class="status-item">
                                    <div class="status-icon @(syncStatus == "connected" ? "connected" : "disconnected")">
                                        <i class="bi @(syncStatus == "connected" ? "bi-check-circle-fill" : "bi-exclamation-circle-fill")"></i>
                                    </div>
                                    <div class="status-info">
                                        <span class="status-label">Server Connection</span>
                                        <span class="status-value">@(syncStatus == "connected" ? "Connected" : "Disconnected")</span>
                                    </div>
                                </div>
                                <div class="status-item">
                                    <div class="status-icon">
                                        <i class="bi bi-calendar-event"></i>
                                    </div>
                                    <div class="status-info">
                                        <span class="status-label">Last Sync</span>
                                        <span class="status-value">@lastSyncTime</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Connection Test Card -->
                    <div class="settings-card">
                        <div class="card-header">
                            <h3>Connection Test</h3>
                            <p>Test your connection to the remote database</p>
                        </div>
                        <div class="card-content">
                            <button class="btn btn-outline-primary" @onclick="TestConnection" disabled="@isTestingConnection">
                                @if (isTestingConnection)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                    <span>Testing...</span>
                                }
                                else
                                {
                                    <i class="bi bi-arrow-repeat me-2"></i>
                                    <span>Test Connection</span>
                                }
                            </button>
                            @if (!string.IsNullOrEmpty(connectionTestMessage))
                            {
                                <div class="alert @(connectionTestSuccess ? "alert-success" : "alert-warning") mt-3">
                                    <i class="bi @(connectionTestSuccess ? "bi-check-circle" : "bi-exclamation-triangle") me-2"></i>
                                    @connectionTestMessage
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Sync Options Card -->
                    <div class="settings-card">
                        <div class="card-header">
                            <h3>Sync Options</h3>
                            <p>Configure what data to synchronize</p>
                        </div>
                        <div class="card-content">
                            <div class="sync-options">
                                <div class="sync-option">
                                    <div class="option-header">
                                        <label class="checkbox-label">
                                            <input type="checkbox" @bind="syncCustomers" />
                                            <span>Customers</span>
                                        </label>
                                        <span class="option-desc">Sync customer data</span>
                                    </div>
                                </div>
                                <div class="sync-option">
                                    <div class="option-header">
                                        <label class="checkbox-label">
                                            <input type="checkbox" @bind="syncInvoices" />
                                            <span>Invoices</span>
                                        </label>
                                        <span class="option-desc">Sync invoice records</span>
                                    </div>
                                </div>
                                <div class="sync-option">
                                    <div class="option-header">
                                        <label class="checkbox-label">
                                            <input type="checkbox" @bind="syncTransactions" />
                                            <span>Transactions</span>
                                        </label>
                                        <span class="option-desc">Sync financial transactions</span>
                                    </div>
                                </div>
                                <div class="sync-option">
                                    <div class="option-header">
                                        <label class="checkbox-label">
                                            <input type="checkbox" @bind="syncReports" disabled />
                                            <span>Reports</span>
                                        </label>
                                        <span class="option-desc">Sync generated reports (Coming Soon)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sync Actions Card -->
                    <div class="settings-card">
                        <div class="card-header">
                            <h3>Sync Actions</h3>
                            <p>Manage your data synchronization</p>
                        </div>
                        <div class="card-content">
                            <div class="auto-sync-settings mb-3">
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" id="autoSyncToggle" @bind="AutoSyncEnabled" />
                                    <label class="form-check-label text-dark" for="autoSyncToggle">
                                        Auto Sync
                                    </label>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label text-dark">Auto Sync Interval</label>
                                    <select class="form-select" @bind="AutoSyncIntervalMinutes">
                                        <option value="5">Every 5 minutes</option>
                                        <option value="15">Every 15 minutes</option>
                                        <option value="30">Every 30 minutes</option>
                                        <option value="60">Every 60 minutes</option>
                                    </select>
                                </div>
                            </div>
                            <div class="sync-actions">
                                <button class="btn btn-primary @(isSyncing ? "disabled" : "")"
                                        @onclick="PerformSync"
                                        disabled="@isSyncing">
                                    @if (isSyncing)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                        <span>Syncing... @syncProgress</span>
                                    }
                                    else
                                    {
                                        <i class="bi bi-cloud-arrow-up me-2"></i>
                                        <span>Sync Now</span>
                                    }
                                </button>
                                <button class="btn btn-outline-secondary" @onclick="RefreshStats">
                                    <i class="bi bi-arrow-clockwise me-2"></i>
                                    <span>Refresh Stats</span>
                                </button>
                                <button class="btn btn-outline-info" @onclick="RunDiagnostics">
                                    <i class="bi bi-bug me-2"></i>
                                    <span>Run Diagnostics</span>
                                </button>
                            </div>
                            @if (!string.IsNullOrEmpty(syncMessage))
                            {
                                <div class="alert @(syncSuccess ? "alert-success" : "alert-warning") mt-3">
                                    <i class="bi @(syncSuccess ? "bi-check-circle" : "bi-exclamation-triangle") me-2"></i>
                                    @syncMessage
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }

            <!-- Account Tab -->
            @if (activeTab == "account")
            {
                <div class="settings-section">
                    <div class="section-header">
                        <h2>Account</h2>
                        <p>Manage your account information</p>
                    </div>

                    <!-- Account Info Card -->
                    <div class="settings-card">
                        <div class="card-header">
                            <h3>Account Information</h3>
                            <p>Your current account details</p>
                        </div>
                        <div class="card-content">
                            <div class="account-info">
                                <div class="info-item">
                                    <span class="info-label">Full Name</span>
                                    <span class="info-value">@AuthService.CurrentUserName</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Role</span>
                                    <span class="info-value">@AuthService.CurrentUserRole</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Account Status</span>
                                    <span class="info-value">
                                        <span class="badge bg-success">Active</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Security Card -->
                    <div class="settings-card">
                        <div class="card-header">
                            <h3>Security</h3>
                            <p>Manage your security settings</p>
                        </div>
                        <div class="card-content">
                            <button class="btn btn-outline-primary">
                                <i class="bi bi-key me-2"></i>
                                <span>Change Password</span>
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private string activeTab = "sync"; // Start on sync tab
    private string selectedTheme = "light";
    private string syncStatus = "disconnected";
    private string lastSyncTime = "Never";
    private bool isSyncing = false;
    private bool syncSuccess = false;
    private string syncMessage = "";
    private string syncProgress = "";

    private bool isTestingConnection = false;
    private bool connectionTestSuccess = false;
    private string connectionTestMessage = "";

    private bool syncCustomers = true;
    private bool syncInvoices = true;
    private bool syncTransactions = false;
    private bool syncReports = false;

    private bool _autoSyncEnabled;
    private int _autoSyncIntervalMinutes = 15;

    private bool AutoSyncEnabled
    {
        get => _autoSyncEnabled;
        set
        {
            if (_autoSyncEnabled == value)
            {
                return;
            }

            _autoSyncEnabled = value;
            AutoSyncService.ConfigureAutoSync(value, _autoSyncIntervalMinutes, syncCustomers, syncInvoices);
            StateHasChanged();
        }
    }

    private int AutoSyncIntervalMinutes
    {
        get => _autoSyncIntervalMinutes;
        set
        {
            if (_autoSyncIntervalMinutes == value)
            {
                return;
            }

            _autoSyncIntervalMinutes = value;
            AutoSyncService.ConfigureAutoSync(_autoSyncEnabled, value, syncCustomers, syncInvoices);
            StateHasChanged();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/login", true);
        }

        // Initialize auto-sync UI from global service state
        _autoSyncEnabled = AutoSyncService.AutoSyncEnabled;
        _autoSyncIntervalMinutes = AutoSyncService.IntervalMinutes;

        // Load saved theme preference
        var savedTheme = GetSavedTheme();
        selectedTheme = savedTheme ?? "dark";

        // Test connection on load
        await TestConnectionOnLoad();
    }

    private async Task TestConnectionOnLoad()
    {
        try
        {
            var (isConnected, message) = await RemoteDbService.GetConnectionStatusAsync();
            syncStatus = isConnected ? "connected" : "disconnected";

            if (isConnected)
            {
                var lastSync = await RemoteDbService.GetLastSyncTimeAsync();
                if (lastSync.HasValue)
                {
                    lastSyncTime = lastSync.Value.ToString("MMM dd, yyyy HH:mm");
                }
            }
        }
        catch (Exception)
        {
            syncStatus = "disconnected";
        }

        StateHasChanged();
    }

    private async Task TestConnection()
    {
        isTestingConnection = true;
        connectionTestMessage = "";
        StateHasChanged();

        try
        {
            var (isConnected, message) = await RemoteDbService.GetConnectionStatusAsync();
            connectionTestSuccess = isConnected;
            connectionTestMessage = message;
            syncStatus = isConnected ? "connected" : "disconnected";
        }
        catch (Exception ex)
        {
            connectionTestSuccess = false;
            connectionTestMessage = $"Connection test failed: {ex.Message}";
            syncStatus = "disconnected";
        }
        finally
        {
            isTestingConnection = false;
            StateHasChanged();
        }
    }

    private void SelectTab(string tab)
    {
        activeTab = tab;
    }

    private void SelectTheme(string theme)
    {
        selectedTheme = theme;
        SaveThemePreference(theme);
        StateHasChanged();
    }

    private void SaveThemePreference(string theme)
    {
        // TODO: Save to local storage or database
    }

    private string? GetSavedTheme()
    {
        // TODO: Retrieve from local storage or database
        return null;
    }

    private async Task PerformSync()
    {
        isSyncing = true;
        syncMessage = "";
        syncProgress = "";
        StateHasChanged();

        try
        {
            // Test connection first
            var (isConnected, message) = await RemoteDbService.GetConnectionStatusAsync();
            if (!isConnected)
            {
                syncSuccess = false;
                syncMessage = "Cannot connect to remote database. Please check your connection.";
                syncStatus = "disconnected";
                return;
            }

            syncStatus = "connected";

            // Ensure at least one applicable data type is selected
            if (!syncCustomers && !syncInvoices)
            {
                syncSuccess = false;
                syncMessage = "Please select at least one data type (Customers or Invoices) to sync.";
                return;
            }

            try
            {
                var remoteUsers = await RemoteDbService.GetAllRemoteUsersAsync();
                if (remoteUsers != null && remoteUsers.Count > 0)
                {
                    var syncedFromRemote = await UserService.SyncUsersFromRemoteAsync(remoteUsers);
                    Console.WriteLine($"Settings.PerformSync: Synced {syncedFromRemote} users from cloud to local.");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Settings.PerformSync: Cloud-to-local user sync error: {ex.Message}");
            }

            // Sync users first so remote tbl_Users is up to date
            syncProgress = "(Syncing users...)";
            StateHasChanged();

            try
            {
                var users = await LocalDbService.GetAllUsersAsync();
                if (users != null && users.Count > 0)
                {
                    await RemoteDbService.SyncUsersToRemoteAsync(users);
                }
                else
                {
                    Console.WriteLine("Settings.PerformSync: No local users found to sync.");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Settings.PerformSync: User sync error: {ex.Message}");
                // Continue with customers/invoices even if user sync fails
            }

            // Fetch all data from local database
            syncProgress = "(Fetching data from local database...)";
            StateHasChanged();

            var customers = await LocalDbService.GetAllCustomersAsync();
            var invoices = await LocalDbService.GetAllInvoicesAsync();

            var selectedCustomerCount = syncCustomers ? (customers?.Count ?? 0) : 0;
            var selectedInvoiceCount = syncInvoices ? (invoices?.Count ?? 0) : 0;

            // Check if there's data to sync based on selected options
            if (selectedCustomerCount == 0 && selectedInvoiceCount == 0)
            {
                syncSuccess = false;
                syncMessage = "No selected data found in local database to sync.";
                return;
            }

            syncProgress = $"(Syncing {selectedCustomerCount} customers and {selectedInvoiceCount} invoices...)";
            StateHasChanged();

            // Use comprehensive sync function with filtered data
            var syncResult = await RemoteDbService.SyncAllDataAsync(
                syncCustomers ? (customers ?? new List<Customer>()) : new List<Customer>(),
                syncInvoices ? (invoices ?? new List<Invoice>()) : new List<Invoice>());

            syncSuccess = syncResult.IsSuccess;
            syncMessage = syncResult.Message;
            
            if (syncResult.TotalSynced > 0)
            {
                lastSyncTime = DateTime.Now.ToString("MMM dd, yyyy HH:mm");
            }
        }
        catch (Exception ex)
        {
            syncSuccess = false;
            syncMessage = $"Sync failed: {ex.Message}";
            syncStatus = "disconnected";
        }
        finally
        {
            isSyncing = false;
            StateHasChanged();
        }
    }

    private async Task RefreshStats()
    {
        try
        {
            var stats = await RemoteDbService.GetSyncStatsAsync();
            syncMessage = $"Remote database stats - Customers: {stats.CustomerCount}, Invoices: {stats.InvoiceCount}, Transactions: {stats.TransactionCount}";
            syncSuccess = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            syncMessage = $"Failed to get stats: {ex.Message}";
            syncSuccess = false;
            StateHasChanged();
        }
    }

    private async Task RunDiagnostics()
    {
        try
        {
            syncMessage = "Running diagnostics...";
            syncSuccess = false;
            StateHasChanged();

            var diagnostics = await ConnectionDiagnostics.RunAllDiagnosticsAsync();
            syncMessage = diagnostics;
            syncSuccess = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            syncMessage = $"Diagnostics error: {ex.Message}";
            syncSuccess = false;
            StateHasChanged();
        }
    }

    private async Task HandleAutoSyncToggleAsync(bool enabled)
    {
        _autoSyncEnabled = enabled;
        AutoSyncService.ConfigureAutoSync(enabled, _autoSyncIntervalMinutes, syncCustomers, syncInvoices);
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        // Do not stop global auto sync when leaving the Settings page.
    }
}
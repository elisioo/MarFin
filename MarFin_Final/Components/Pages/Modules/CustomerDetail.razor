@page "/customer-details/{CustomerId:int}"
@inject NavigationManager Navigation
@inject AuthService AuthService
@using MarFin_Final.Data
@using MarFin_Final.Database.Services
@using MarFin_Final.Models

<AuthorizeRoute RequiredPermission="@RolePermissions.Permissions.ViewCustomers">
    <div class="customers-container">
        @if (isLoading)
        {
            <div class="loading-state">
                <div class="spinner"></div>
                <p>Loading customer details...</p>
            </div>
        }
        else if (customer == null)
        {
            <div class="error-state">
                <i class="bi bi-exclamation-circle"></i>
                <h2>Customer Not Found</h2>
                <p>@errorMessage</p>
                <button class="btn-primary" @onclick="NavigateBack">
                    <i class="bi bi-arrow-left"></i> Back to Customers
                </button>
            </div>
        }
        else
        {
            <div class="details-page">
                <div class="details-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <button class="btn-back" @onclick="NavigateBack">
                                <i class="bi bi-arrow-left"></i> Back
                            </button>
                            <h1>@customer.FullName</h1>
                            <div class="customer-meta">
                                <span class="status-badge status-@customer.CustomerStatus.ToLower()">
                                    @customer.CustomerStatus
                                </span>
                                @if (!string.IsNullOrEmpty(customer.CompanyName))
                                {
                                    <span class="company-badge">
                                        <i class="bi bi-building"></i> @customer.CompanyName
                                    </span>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-danger">
                        @errorMessage
                        <button class="alert-close" @onclick="() => errorMessage = string.Empty">×</button>
                    </div>
                }

                @if (!string.IsNullOrEmpty(successMessage))
                {
                    <div class="alert alert-success">
                        @successMessage
                        <button class="alert-close" @onclick="() => successMessage = string.Empty">×</button>
                    </div>
                }

                <div class="details-grid">
                    @* Left Column - Customer Information *@
                    <div class="details-card">
                        <div class="card-header">
                            <h3>Customer Information</h3>
                            @* Only Admin and Marketing can edit *@
                            @if (!isEditing && (AuthService.IsAdmin() || AuthService.IsMarketing()))
                            {
                                <button class="btn-edit" @onclick="StartEdit">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                            }
                        </div>

                        <div class="form-group">
                            <label>First Name</label>
                            <input type="text"
                                   class="form-control @(validationErrors.ContainsKey("FirstName") ? "is-invalid" : "")"
                                   @bind="customer.FirstName"
                                   disabled="@(!isEditing)" />
                            @if (validationErrors.ContainsKey("FirstName"))
                            {
                                <span class="validation-error">@validationErrors["FirstName"]</span>
                            }
                        </div>

                        <div class="form-group">
                            <label>Last Name</label>
                            <input type="text"
                                   class="form-control @(validationErrors.ContainsKey("LastName") ? "is-invalid" : "")"
                                   @bind="customer.LastName"
                                   disabled="@(!isEditing)" />
                            @if (validationErrors.ContainsKey("LastName"))
                            {
                                <span class="validation-error">@validationErrors["LastName"]</span>
                            }
                        </div>

                        <div class="form-group">
                            <label>Email</label>
                            <input type="email"
                                   class="form-control @(validationErrors.ContainsKey("Email") ? "is-invalid" : "")"
                                   @bind="customer.Email"
                                   disabled="@(!isEditing)" />
                            @if (validationErrors.ContainsKey("Email"))
                            {
                                <span class="validation-error">@validationErrors["Email"]</span>
                            }
                        </div>

                        <div class="form-group">
                            <label>Phone</label>
                            <input type="text"
                                   class="form-control"
                                   @bind="customer.Phone"
                                   disabled="@(!isEditing)"
                                   placeholder="N/A" />
                        </div>

                        <div class="form-group">
                            <label>Company Name</label>
                            <input type="text"
                                   class="form-control"
                                   @bind="customer.CompanyName"
                                   disabled="@(!isEditing)"
                                   placeholder="N/A" />
                        </div>

                        <div class="form-group">
                            <label>Address</label>
                            <input type="text"
                                   class="form-control"
                                   @bind="customer.Address"
                                   disabled="@(!isEditing)"
                                   placeholder="N/A" />
                        </div>

                        <div class="form-group">
                            <label>City</label>
                            <input type="text"
                                   class="form-control"
                                   @bind="customer.City"
                                   disabled="@(!isEditing)"
                                   placeholder="N/A" />
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>State/Province</label>
                                <input type="text"
                                       class="form-control"
                                       @bind="customer.StateProvince"
                                       disabled="@(!isEditing)"
                                       placeholder="N/A" />
                            </div>
                            <div class="form-group">
                                <label>Postal Code</label>
                                <input type="text"
                                       class="form-control @(validationErrors.ContainsKey("PostalCode") ? "is-invalid" : "")"
                                       @bind="customer.PostalCode"
                                       disabled="@(!isEditing)"
                                       placeholder="N/A" />
                                @if (validationErrors.ContainsKey("PostalCode"))
                                {
                                    <span class="validation-error">@validationErrors["PostalCode"]</span>
                                }
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Country</label>
                            <input type="text"
                                   class="form-control"
                                   @bind="customer.Country"
                                   disabled="@(!isEditing)" />
                        </div>

                        <div class="form-group">
                            <label>Status</label>
                            @if (isEditing)
                            {
                                <select class="form-control" @bind="customer.CustomerStatus">
                                    <option value="Lead">Lead</option>
                                    <option value="Active">Active</option>
                                    <option value="Inactive">Inactive</option>
                                    <option value="Dormant">Dormant</option>
                                </select>
                            }
                            else
                            {
                                <div class="status-display">
                                    <span class="status-badge status-@customer.CustomerStatus.ToLower()">
                                        @customer.CustomerStatus
                                    </span>
                                </div>
                            }
                        </div>

                        <div class="form-group">
                            <label>Source</label>
                            <input type="text"
                                   class="form-control"
                                   @bind="customer.Source"
                                   disabled="@(!isEditing)"
                                   placeholder="N/A" />
                        </div>

                        <div class="form-group">
                            <label>Notes</label>
                            <textarea class="form-control"
                                      rows="3"
                                      @bind="customer.Notes"
                                      disabled="@(!isEditing)"
                                      placeholder="No notes"></textarea>
                        </div>

                        <div class="form-group">
                            <label>Member Since</label>
                            <input type="text"
                                   class="form-control"
                                   value="@customer.CreatedDate.ToString("MMMM dd, yyyy")"
                                   readonly />
                        </div>

                        @if (isEditing)
                        {
                            <div class="form-actions">
                                <button class="btn-cancel" @onclick="CancelEdit">Cancel</button>
                                <button class="btn-save" @onclick="SaveChanges" disabled="@isSaving">
                                    @if (isSaving)
                                    {
                                        <span class="spinner-small"></span>
                                    }
                                    Save Changes
                                </button>
                            </div>
                        }
                    </div>

                    @* Middle Column - Activity Overview *@
                    <div class="details-card">
                        <div class="card-header">
                            <h3>Overview</h3>
                        </div>

                        <div class="activity-content">
                            <div class="info-section">
                                <h4>Contact Details</h4>
                                <div class="info-item">
                                    <span class="info-label">
                                        <i class="bi bi-envelope"></i> Email:
                                    </span>
                                    <span class="info-value">
                                        <a href="mailto:@customer.Email">@customer.Email</a>
                                    </span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">
                                        <i class="bi bi-telephone"></i> Phone:
                                    </span>
                                    <span class="info-value">
                                        @if (!string.IsNullOrEmpty(customer.Phone))
                                        {
                                            <a href="tel:@customer.Phone">@customer.Phone</a>
                                        }
                                        else
                                        {
                                            <text>N/A</text>
                                        }
                                    </span>
                                </div>
                            </div>

                            <div class="info-section">
                                <h4>Location</h4>
                                <div class="info-item">
                                    <span class="info-label">
                                        <i class="bi bi-geo-alt"></i> Address:
                                    </span>
                                    <span class="info-value">
                                        @if (!string.IsNullOrEmpty(customer.Address) || !string.IsNullOrEmpty(customer.City))
                                        {
                                            @if (!string.IsNullOrEmpty(customer.Address))
                                            {
                                                <text>@customer.Address<br /></text>
                                            }
                                            @if (!string.IsNullOrEmpty(customer.City))
                                            {
                                                <text>@customer.City</text>
                                            }
                                            @if (!string.IsNullOrEmpty(customer.StateProvince))
                                            {
                                                <text>, @customer.StateProvince</text>
                                            }
                                            @if (!string.IsNullOrEmpty(customer.PostalCode))
                                            {
                                                <text> @customer.PostalCode</text>
                                            }
                                            <br />
                                            <text>@customer.Country</text>
                                        }
                                        else
                                        {
                                            <text>N/A</text>
                                        }
                                    </span>
                                </div>
                            </div>

                            <div class="info-section">
                                <h4>Business Information</h4>
                                @if (!string.IsNullOrEmpty(customer.CompanyName))
                                {
                                    <div class="info-item">
                                        <span class="info-label">
                                            <i class="bi bi-building"></i> Company:
                                        </span>
                                        <span class="info-value">@customer.CompanyName</span>
                                    </div>
                                }
                                <div class="info-item">
                                    <span class="info-label">
                                        <i class="bi bi-tag"></i> Segment:
                                    </span>
                                    <span class="info-value">@customer.SegmentName</span>
                                </div>
                                @if (!string.IsNullOrEmpty(customer.Source))
                                {
                                    <div class="info-item">
                                        <span class="info-label">
                                            <i class="bi bi-signpost"></i> Source:
                                        </span>
                                        <span class="info-value">@customer.Source</span>
                                    </div>
                                }
                            </div>

                            @if (!string.IsNullOrEmpty(customer.Notes))
                            {
                                <div class="info-section">
                                    <h4>Notes</h4>
                                    <div class="info-item">
                                        <span class="info-value notes-text">@customer.Notes</span>
                                    </div>
                                </div>
                            }

                            <div class="info-section">
                                <h4>Timeline</h4>
                                <div class="info-item">
                                    <span class="info-label">
                                        <i class="bi bi-calendar-plus"></i> Created:
                                    </span>
                                    <span class="info-value">@customer.CreatedDate.ToString("MMM dd, yyyy 'at' h:mm tt")</span>
                                </div>
                                @if (customer.ModifiedDate > customer.CreatedDate)
                                {
                                    <div class="info-item">
                                        <span class="info-label">
                                            <i class="bi bi-calendar-check"></i> Last Modified:
                                        </span>
                                        <span class="info-value">@customer.ModifiedDate.ToString("MMM dd, yyyy 'at' h:mm tt")</span>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    @* Right Column - Revenue, Invoice History & Actions *@
                    <div class="details-card">
                        <div class="revenue-section">
                            <div class="revenue-icon">
                                <i class="bi bi-cash-coin"></i>
                            </div>
                            <div class="revenue-info">
                                <div class="revenue-amount">₱@customer.TotalRevenue.ToString("N2")</div>
                                <div class="revenue-label">Total Revenue</div>
                            </div>
                        </div>

                        <div class="card-header">
                            <h3>Quick Actions</h3>
                        </div>

                        <div class="action-buttons">
                            @* Only Admin and Marketing can edit *@
                            @if (AuthService.IsAdmin() || AuthService.IsMarketing())
                            {
                                <button class="btn-action btn-action-primary" @onclick="StartEdit" disabled="@isEditing">
                                    <i class="bi bi-pencil"></i> Edit Customer
                                </button>
                            }
                            
                            @* Sales can log interactions *@
                            @if (AuthService.IsSalesRep() || AuthService.IsAdmin())
                            {
                                <button class="btn-action">
                                    <i class="bi bi-plus-lg"></i> Log Interaction
                                </button>
                            }
                            
                            @* Everyone can send email *@
                            <button class="btn-action" @onclick="SendEmail">
                                <i class="bi bi-envelope"></i> Send Email
                            </button>
                            
                            @* Everyone can call *@
                            <button class="btn-action">
                                <i class="bi bi-telephone"></i> Call Customer
                            </button>
                            
                            @* Only Finance and Admin can create invoices *@
                            @if (AuthService.IsFinance() || AuthService.IsAdmin())
                            {
                                <button class="btn-action" @onclick="CreateInvoiceForCustomer">
                                    <i class="bi bi-file-text"></i> Create Invoice
                                </button>
                            }
                            
                            @* Only Admin and Marketing can archive *@
                            @if (AuthService.IsAdmin() || AuthService.IsMarketing())
                            {
                                <button class="btn-action btn-action-danger" @onclick="ConfirmArchive">
                                    <i class="bi bi-archive"></i> Archive Customer
                                </button>
                            }
                        </div>

                        <div class="card-header mt-3">
                            <h3>Invoice History</h3>
                        </div>

                        @if (isInvoicesLoading)
                        {
                            <div class="loading-state">
                                <div class="spinner"></div>
                                <p>Loading invoice history...</p>
                            </div>
                        }
                        else if (!customerInvoices.Any())
                        {
                            <div class="empty-state text-center">
                                <i class="bi bi-receipt fs-2 text-muted"></i>
                                <p>No invoices found for this customer</p>
                            </div>
                        }
                        else
                        {
                            <div class="invoice-history-table">
                                <div class="table-header small">
                                    <span>Invoice #</span>
                                    <span>Date</span>
                                    <span>Status</span>
                                    <span class="text-end">Amount</span>
                                </div>
                                @foreach (var inv in customerInvoices.Take(5))
                                {
                                    <div class="table-row small" @onclick="() => NavigateToInvoice(inv.InvoiceId)">
                                        <span>@inv.InvoiceNumber</span>
                                        <span>@inv.InvoiceDate.ToString("MM/dd/yyyy")</span>
                                        <span>
                                            <span class="status-badge @inv.StatusBadgeClass">
                                                @(inv.IsOverdue ? "Overdue" : inv.PaymentStatus)
                                            </span>
                                        </span>
                                        <span class="text-end">₱@inv.TotalAmount.ToString("N2")</span>
                                    </div>
                                }
                                @if (customerInvoices.Count > 5)
                                {
                                    <div class="text-end mt-1">
                                        <small>@(customerInvoices.Count - 5) more invoice(s)...</small>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>

    @* Archive Confirmation Modal *@
    @if (showArchiveModal)
    {
        <div class="modal-overlay" @onclick="CloseArchiveModal">
            <div class="modal-content confirm-modal" @onclick:stopPropagation>
                <div class="modal-header">
                    <div class="modal-title">
                        <span class="user-icon warning"><i class="bi bi-exclamation-triangle"></i></span>
                        <h2>Archive Customer</h2>
                    </div>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to archive <strong>@customer?.FullName</strong>?</p>
                    <p class="text-muted">This customer will be moved to the archived list but can be restored later.</p>

                    <div class="modal-footer">
                        <button class="btn-cancel" @onclick="CloseArchiveModal">Cancel</button>
                        <button class="btn-danger" @onclick="ArchiveCustomer" disabled="@isSaving">
                            @if (isSaving)
                            {
                                <span class="spinner-small"></span>
                            }
                            Archive Customer
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</AuthorizeRoute>

@code {
    [Parameter]
    public int CustomerId { get; set; }

    private readonly CustomerService customerService = new();
    private readonly InvoiceService invoiceService = new();

    private Customer? customer = null;

    private Customer? originalCustomer = null;
    private bool isLoading = true;
    private bool isInvoicesLoading = true;

    private bool isSaving = false;
    private bool showArchiveModal = false;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;

    private bool isEditing = false;
    private Dictionary<string, string> validationErrors = new();
    private int currentUserId => AuthService.CurrentUserId ?? 1;

    private List<Invoice> customerInvoices = new();

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/login", true);
            return;
        }

        await LoadCustomerDetails();
    }

    private async Task LoadCustomerDetails()
    {
        try
        {
            isLoading = true;
            StateHasChanged();

            await Task.Run(() =>
            {
                customer = customerService.GetCustomerById(CustomerId);
                customerInvoices = invoiceService.GetInvoicesByCustomerId(CustomerId);
            });

            if (customer == null)
            {
                errorMessage = "Customer not found";
            }
            else
            {
                originalCustomer = CloneCustomer(customer);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading customer details: {ex.Message}";
            Console.WriteLine($"LoadCustomerDetails Error: {ex.Message}\n{ex.StackTrace}");
        }
        finally
        {
            isLoading = false;
            isInvoicesLoading = false;
            StateHasChanged();
        }
    }

    private void StartEdit()
    {
        // Only Admin and Marketing can edit
        if (!AuthService.IsAdmin() && !AuthService.IsMarketing())
        {
            errorMessage = "You don't have permission to edit this customer";
            return;
        }

        isEditing = true;
        if (customer != null)
        {
            originalCustomer = CloneCustomer(customer);
        }
        validationErrors.Clear();
        errorMessage = string.Empty;
    }

    private void CancelEdit()
    {
        isEditing = false;
        if (originalCustomer != null && customer != null)
        {
            customer = CloneCustomer(originalCustomer);
        }
        validationErrors.Clear();
        errorMessage = string.Empty;
    }

    private bool ValidateCustomer()
    {
        validationErrors.Clear();

        if (customer == null) return false;

        if (string.IsNullOrWhiteSpace(customer.FirstName))
        {
            validationErrors["FirstName"] = "First name is required";
        }

        if (string.IsNullOrWhiteSpace(customer.LastName))
        {
            validationErrors["LastName"] = "Last name is required";
        }

        if (string.IsNullOrWhiteSpace(customer.Email))
        {
            validationErrors["Email"] = "Email is required";
        }
        else if (!IsValidEmail(customer.Email))
        {
            validationErrors["Email"] = "Please enter a valid email address";
        }

        // Postal code: allow empty, but if provided must be numeric only
        if (!string.IsNullOrWhiteSpace(customer.PostalCode) && customer.PostalCode.Any(c => !char.IsDigit(c)))
        {
            validationErrors["PostalCode"] = "Postal code must contain numbers only";
        }

        return !validationErrors.Any();
    }

    private bool IsValidEmail(string email)
    {
        try
        {
            var addr = new System.Net.Mail.MailAddress(email);
            return addr.Address == email;
        }
        catch
        {
            return false;
        }
    }

    private async Task SaveChanges()
    {
        if (customer == null) return;

        // Only Admin and Marketing can save changes
        if (!AuthService.IsAdmin() && !AuthService.IsMarketing())
        {
            errorMessage = "You don't have permission to modify this customer";
            return;
        }

        if (!ValidateCustomer())
        {
            errorMessage = "Please correct the validation errors";
            return;
        }

        try
        {
            isSaving = true;
            customer.ModifiedBy = currentUserId;
            StateHasChanged();

            bool success = false;
            await Task.Run(() =>
            {
                success = customerService.UpdateCustomer(customer);
            });

            if (success)
            {
                successMessage = "Customer updated successfully!";
                isEditing = false;
                originalCustomer = CloneCustomer(customer);
                errorMessage = string.Empty;
            }
            else
            {
                errorMessage = "Failed to update customer. Please try again.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving changes: {ex.Message}";
            Console.WriteLine($"SaveChanges Error: {ex.Message}\n{ex.StackTrace}");
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private void SendEmail()
    {
        if (customer != null && !string.IsNullOrEmpty(customer.Email))
        {
            Navigation.NavigateTo($"mailto:{customer.Email}");
        }
    }

    private void ConfirmArchive()
    {
        // Only Admin and Marketing can archive
        if (!AuthService.IsAdmin() && !AuthService.IsMarketing())
        {
            errorMessage = "You don't have permission to archive customers";
            return;
        }

        showArchiveModal = true;
    }

    private void CloseArchiveModal()
    {
        showArchiveModal = false;
    }

    private async Task ArchiveCustomer()
    {
        if (customer == null) return;

        try
        {
            isSaving = true;
            StateHasChanged();

            bool success = false;
            await Task.Run(() =>
            {
                success = customerService.ArchiveCustomer(customer.CustomerId, currentUserId);
            });

            if (success)
            {
                Navigation.NavigateTo("/customers");
            }
            else
            {
                errorMessage = "Failed to archive customer";
                CloseArchiveModal();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error archiving customer: {ex.Message}";
            Console.WriteLine($"ArchiveCustomer Error: {ex.Message}\n{ex.StackTrace}");
            CloseArchiveModal();
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private void NavigateBack()
    {
        Navigation.NavigateTo("/customers");
    }

    private void CreateInvoiceForCustomer()
    {
        if (customer == null)
        {
            return;
        }

        Navigation.NavigateTo($"/financial?customerId={customer.CustomerId}");
    }

    private void NavigateToInvoice(int invoiceId)
    {
        Navigation.NavigateTo($"/financial?invoiceId={invoiceId}");
    }

    private Customer CloneCustomer(Customer source)
    {
        return new Customer
        {
            CustomerId = source.CustomerId,
            SegmentId = source.SegmentId,
            CreatedBy = source.CreatedBy,
            ModifiedBy = source.ModifiedBy,
            FirstName = source.FirstName,
            LastName = source.LastName,
            Email = source.Email,
            Phone = source.Phone,
            CompanyName = source.CompanyName,
            Address = source.Address,
            City = source.City,
            StateProvince = source.StateProvince,
            PostalCode = source.PostalCode,
            Country = source.Country,
            CustomerStatus = source.CustomerStatus,
            TotalRevenue = source.TotalRevenue,
            Source = source.Source,
            Notes = source.Notes,
            IsActive = source.IsActive,
            IsArchived = source.IsArchived,
            ArchivedDate = source.ArchivedDate,
            ArchivedBy = source.ArchivedBy,
            CreatedDate = source.CreatedDate,
            ModifiedDate = source.ModifiedDate,
            SegmentName = source.SegmentName
        };
    }
}
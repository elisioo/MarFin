@page "/sales-pipeline"
@using MarFin_Final.Models
@using MarFin_Final.Data

<div class="sales-pipeline-container">
    <!-- Header -->
    <div class="pipeline-header">
        <div class="header-title">
            <h1>@(showArchived ? "Archived Opportunities" : "Sales Pipeline")</h1>
            <span class="header-subtitle">
                @if (showArchived)
                {
                    <span>@filteredOpportunities.Count archived opportunities</span>
                }
                else
                {
                    <span>Track and manage your sales opportunities</span>
                }
            </span>
        </div>
    </div>

    @if (!showArchived)
    {
        <!-- Sales Pipeline Summary -->
        <div class="pipeline-summary">
            <h6>
                Sales Pipeline Summary
                @if (!showSummaryCards)
                {
                    <span class="text-primary ms-1" style="cursor: pointer;" @onclick="ToggleSummaryCards">view</span>
                }
                else
                {
                    <span class="text-primary ms-1" style="cursor: pointer;" @onclick="ToggleSummaryCards">hide</span>
                }
            </h6>
            @if (showSummaryCards)
            {
                <div class="pipeline-metrics">
                    <div class="metric-card">
                        <div class="metric-icon green">
                            <i class="bi bi-bullseye"></i>
                        </div>
                        <div class="metric-content">
                            <h2>₱@totalPipelineValue.ToString("N0")</h2>
                            <p>Total Pipeline Value</p>
                            <span class="metric-badge positive">
                                <i class="bi bi-graph-up"></i> Active
                            </span>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-icon blue">
                            <i class="bi bi-bell"></i>
                        </div>
                        <div class="metric-content">
                            <h2>@activeDealsCount</h2>
                            <p>Active Deals</p>
                            <span class="metric-badge positive">
                                <i class="bi bi-graph-up"></i> Open
                            </span>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-icon red">
                            <i class="bi bi-graph-up-arrow"></i>
                        </div>
                        <div class="metric-content">
                            <h2>₱@avgDealSize.ToString("N0")</h2>
                            <p>Avg. Deal Size</p>
                            <span class="metric-badge positive">
                                <i class="bi bi-calculator"></i> Average
                            </span>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-icon teal">
                            <i class="bi bi-check-circle"></i>
                        </div>
                        <div class="metric-content">
                            <h2>@winRate.ToString("N1")%</h2>
                            <p>Win Rate</p>
                            <span class="metric-badge positive">
                                <i class="bi bi-trophy"></i> Success
                            </span>
                        </div>
                    </div>
                </div>
            }
        </div>
    }

    <!-- Toolbar -->
    <div class="sales-pipeline-toolbar">
        @if (!showArchived)
        {
            <button class="btn-primary" @onclick="ToggleModal">
                <i class="bi bi-plus-lg"></i> New Opportunity
            </button>
        }
        else
        {
            <div></div>
        }

        <div class="toolbar-filters">
            <button class="@(showArchived ? "btn-primary" : "btn-filter")" @onclick="ToggleArchivedView">
                <i class="bi bi-@(showArchived ? "arrow-left" : "archive")"></i>
                @(showArchived ? "Back to Active Pipeline" : "View Archived")
            </button>

            @if (!showArchived && (!string.IsNullOrEmpty(searchTerm) || selectedStageFilter > 0))
            {
                <button class="btn-filter" @onclick="ClearFilters" title="Clear all filters">
                    <i class="bi bi-x-circle"></i> Clear Filters
                </button>
            }

            @if (!showArchived)
            {
                <div class="filter-dropdown">
                    <button class="btn-filter" @onclick="() => showStageDropdown = !showStageDropdown">
                        <i class="bi bi-funnel"></i> Stage
                        @if (selectedStageFilter > 0)
                        {
                            <span class="filter-badge">@(allStages.FirstOrDefault(s => s.StageId == selectedStageFilter)?.StageName ?? "Selected")</span>
                        }
                    </button>
                    @if (showStageDropdown)
                    {
                        <div class="dropdown-menu show">
                            <button @onclick='() => { selectedStageFilter = 0; showStageDropdown = false; ApplyFilters(); }'>All Stages</button>
                            @foreach (var stage in allStages)
                            {
                                <button @onclick='() => { selectedStageFilter = stage.StageId; showStageDropdown = false; ApplyFilters(); }'>@stage.StageName</button>
                            }
                        </div>
                    }
                </div>
            }

            <div class="search-box">
                <span class="search-icon"><i class="bi bi-search"></i></span>
                <input type="text" placeholder="Search opportunities..." @bind="searchTerm" @bind:event="oninput" @onkeyup="PerformSearch" />
                @if (!string.IsNullOrEmpty(searchTerm))
                {
                    <button class="search-clear" @onclick="ClearSearch">×</button>
                }
            </div>
            <!-- View Toggle -->
            <div class="view-toggle">

                <button class="@(isPipelineView ? "view-btn active" : "view-btn")" @onclick="@(() => SetView(true))" title="Pipeline View">
                    <i class="bi bi-grid-3x3-gap"></i>
                </button>
                <button class="@(!isPipelineView ? "view-btn active" : "view-btn")" @onclick="@(() => SetView(false))" title="List View">
                    <i class="bi bi-list-ul"></i>
                </button>
            </div>
            
        </div>
    

    </div>

    <!-- Active Pipeline Views -->
    @if (!showArchived)
    {
        @if (isPipelineView)
        {
            <div class="pipeline-board">
                @foreach (var stage in pipelineStages)
                {
                    <div class="pipeline-column">
                        <div class="column-header">
                            <div class="stage-indicator" style="background-color: @stage.StageColor"></div>
                            <span class="stage-name">@stage.StageName (@stage.Deals.Count)</span>
                        </div>

                        <div class="column-content">
                            @foreach (var deal in stage.Deals)
                            {
                                <div class="deal-card" @onclick="@(() => EditOpportunity(deal.OpportunityId))">
                                    <h4>@deal.OpportunityName</h4>
                                    <p class="deal-company">@deal.CompanyName</p>
                                    <div class="deal-value">₱@deal.DealValue.ToString("N2")</div>

                                    <div class="deal-meta">
                                        <span>
                                            <i class="bi bi-calendar"></i>
                                            @(deal.ExpectedCloseDate?.ToString("MMM dd") ?? "No date")
                                        </span>
                                        <span><i class="bi bi-person"></i> @deal.AssignedToName</span>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <!-- List View -->
            <div class="list-view">
                <div class="list-header">
                    <span>Deal Name</span>
                    <span>Company</span>
                    <span>Value</span>
                    <span>Stage</span>
                    <span>Owner</span>
                    <span>Date</span>
                </div>

                @foreach (var deal in GetPaginatedOpportunities())
                {
                    <div class="list-row" @onclick="@(() => EditOpportunity(deal.OpportunityId))">
                        <span>@deal.OpportunityName</span>
                        <span>@deal.CompanyName</span>
                        <span>₱@deal.DealValue.ToString("N2")</span>
                        <span>
                            <span class="stage-badge" style="background-color: @deal.StageColor">
                                @deal.StageName
                            </span>
                        </span>
                        <span>@deal.AssignedToName</span>
                        <span>@(deal.ExpectedCloseDate?.ToString("MMM dd, yyyy") ?? "No date")</span>
                    </div>
                }
            </div>

            <!-- Pagination Controls -->
            <div class="pagination-section">
                <div class="pagination-info">
                    <span>Showing <strong>@((currentPage - 1) * pageSize + 1)</strong> to <strong>@Math.Min(currentPage * pageSize, totalRecords)</strong> of <strong>@totalRecords</strong> opportunities</span>
                </div>

                <div class="pagination-controls">
                    <div class="page-size-selector">
                        <label>Rows per page:</label>
                        <select @bind="pageSize" @bind:after="ReloadWithNewPageSize">
                            <option value="5">5</option>
                            <option value="10">10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                        </select>
                    </div>

                    <div class="pagination-buttons">
                        <button class="pagination-btn" @onclick="() => ChangePage(1)" disabled="@(currentPage == 1)">
                            <i class="bi bi-chevron-double-left"></i>
                        </button>
                        <button class="pagination-btn" @onclick="() => ChangePage(currentPage - 1)" disabled="@(currentPage == 1)">
                            <i class="bi bi-chevron-left"></i>
                        </button>

                        @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(TotalPages, currentPage + 2); i++)
                        {
                            int pageNum = i;
                            <button class="@(currentPage == pageNum ? "pagination-btn active" : "pagination-btn")" @onclick="() => ChangePage(pageNum)">
                                @pageNum
                            </button>
                        }

                        <button class="pagination-btn" @onclick="() => ChangePage(currentPage + 1)" disabled="@(currentPage == TotalPages)">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                        <button class="pagination-btn" @onclick="() => ChangePage(TotalPages)" disabled="@(currentPage == TotalPages)">
                            <i class="bi bi-chevron-double-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        }
    }
    else
    {
        <!-- Archived View (Customer-style) -->
        @if (!filteredOpportunities.Any())
        {
            <div class="empty-state">
                <i class="bi bi-inbox"></i>
                <p>@(string.IsNullOrEmpty(searchTerm) ? "No archived opportunities found" : "No archived opportunities match your search")</p>
                @if (!string.IsNullOrEmpty(searchTerm))
                {
                    <button class="btn-secondary" @onclick="ClearSearch">Clear Search</button>
                }
            </div>
        }
        else
        {
            @foreach (var group in GetGroupedOpportunities())
            {
                <div class="customer-card">
                    <div class="customer-card-header">
                        <span class="customer-name">@group.Key</span>
                        <span class="customer-count">@group.Value.Count opportunity(s)</span>
                    </div>

                    <div class="customer-table">
                        <div class="table-header">
                            <span>Opportunity Name</span>
                            <span>Company</span>
                            <span>Value</span>
                            <span>Stage</span>
                            <span>Archived Date</span>
                            <span>Actions</span>
                        </div>

                        @foreach (var deal in group.Value)
                        {
                            <div class="table-row">
                                <span>@deal.OpportunityName</span>
                                <span>@deal.CompanyName</span>
                                <span>₱@deal.DealValue.ToString("N2")</span>
                                <span>
                                    <span class="status-badge" style="background-color: @deal.StageColor; color: white;">
                                        @deal.StageName
                                    </span>
                                </span>
                                <span>@(deal.ArchivedDate?.ToString("MMM dd, yyyy") ?? "N/A")</span>
                                <span class="action-buttons-cell">
                                    <button class="btn-icon btn-icon-success" @onclick="() => ShowRestoreConfirmation(deal)" title="Restore">
                                        <i class="bi bi-arrow-counterclockwise"></i>
                                    </button>
                                </span>
                            </div>
                        }
                    </div>
                </div>
            }
        }
    }
</div>

<!-- Opportunity Modal -->
@if (showModal)
{
    <div class="modal-overlay" @onclick="CloseModalOutside">
        <div class="modal-content" @onclick:stopPropagation>
            <div class="modal-header">
                <h2>@(isEditMode ? "Edit Opportunity" : "New Opportunity")</h2>
                <button class="btn-cancel" @onclick="ToggleModal">×</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group full-width">
                        <label>Deal Name <span class="required">*</span></label>
                        <input type="text" class="form-control" placeholder="Enter deal name" @bind="newOpportunity.OpportunityName" />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Customer <span class="required">*</span></label>
                        <select class="form-control" @bind="newOpportunity.CustomerId">
                            <option value="0">Select customer</option>

                            @foreach (var customer in customers)
                            {
                                <option value="@customer.CustomerId">@customer.FullName - @customer.CompanyName</option>
                            }
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Pipeline Stage <span class="required">*</span></label>
                        <select class="form-control" @bind="newOpportunity.StageId">
                            <option value="0">Select stage</option>
                            @foreach (var stage in allStages)
                            {
                                <option value="@stage.StageId">@stage.StageName</option>
                            }
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Deal Value <span class="required">*</span></label>
                        <div class="input-with-prefix">
                            <span class="input-prefix">₱</span>
                            <input type="number" step="0.01" class="form-control with-prefix" placeholder="0.00" @bind="newOpportunity.DealValue" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Probability (%)</label>
                        <input type="number" class="form-control" placeholder="0-100" min="0" max="100" @bind="newOpportunity.Probability" />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Expected Close Date</label>
                        <input type="date" class="form-control" @bind="closeDate" />
                    </div>
                    <div class="form-group">
                        <label>Assigned To <span class="required">*</span></label>
                        <select class="form-control" @bind="newOpportunity.AssignedTo">
                            <option value="0">Select user</option>
                            <option value="1">Current User</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label>Notes</label>
                        <textarea class="form-control" rows="3" placeholder="Add notes..." @bind="newOpportunity.Notes"></textarea>
                    </div>
                </div>

                <div class="form-info">
                    <i class="bi bi-info-circle"></i>
                    <span>Fields marked with <span class="required">*</span> are required</span>
                </div>

                <div class="modal-actions">
                    @if (isEditMode)
                    {
                        <button class="btn-danger" @onclick="ShowDeleteConfirmation">
                            <i class="bi bi-archive"></i> Archive
                        </button>
                    }
                    <button class="btn-primary" @onclick="SaveOpportunity">
                        <i class="bi bi-check-lg"></i> @(isEditMode ? "Update Deal" : "Create Deal")
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Confirmation Modal -->
@if (showConfirmModal)
{
    <div class="modal-overlay">
        <div class="confirm-modal">
            <div class="confirm-icon">
                <i class="bi bi-exclamation-triangle"></i>
            </div>
            <h3>@confirmTitle</h3>
            <p>@confirmMessage</p>
            <div class="confirm-actions">
                <button class="btn-cancel-confirm" @onclick="CancelConfirmation">Cancel</button>
                <button class="btn-confirm" @onclick="ConfirmAction">
                    @confirmButtonText
                </button>
            </div>
        </div>
    </div>
}

@code {
    private readonly CustomerService customerService = new();
    private readonly SalesPipelineService pipelineService = new();

    private string searchTerm = "";
    private bool isPipelineView = true;
    private bool showModal = false;
    private bool isEditMode = false;
    private bool showArchived = false;
    private bool showSummaryCards = false;

    private int selectedStageFilter = 0;
    private bool showStageDropdown = false;

    private DateTime? closeDate { get; set; }

    private List<SalesPipelineModel> allOpportunities = new();
    private List<SalesPipelineModel> filteredOpportunities = new();
    private List<Customer> customers = new();
    private List<PipelineStageModel> allStages = new();

    private decimal totalPipelineValue = 0;
    private int activeDealsCount = 0;
    private decimal avgDealSize = 0;
    private decimal winRate = 0;

    // Pagination
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalRecords = 0;
    private int TotalPages => (int)Math.Ceiling(totalRecords / (double)pageSize);

    // Confirmation modal
    private bool showConfirmModal = false;
    private string confirmTitle = "";
    private string confirmMessage = "";
    private string confirmButtonText = "";
    private Action? confirmCallback;

    private class PipelineColumn
    {
        public int StageId { get; set; }
        public string StageName { get; set; } = "";
        public string StageColor { get; set; } = "";
        public int StageOrder { get; set; }
        public List<SalesPipelineModel> Deals { get; set; } = new();
    }

    private List<PipelineColumn> pipelineStages = new();
    private SalesPipelineModel newOpportunity = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        await Task.Run(() =>
        {
            allStages = pipelineService.GetAllStages();
            allOpportunities = showArchived
                ? pipelineService.GetArchivedOpportunities()
                : pipelineService.GetAllOpportunities();
            customers = customerService.GetAllCustomers();

            var metrics = pipelineService.GetPipelineMetrics();
            totalPipelineValue = Convert.ToDecimal(metrics["TotalValue"]);
            activeDealsCount = Convert.ToInt32(metrics["ActiveDeals"]);
            avgDealSize = Convert.ToDecimal(metrics["AvgDealSize"]);
            winRate = Convert.ToDecimal(metrics["WinRate"]);

            filteredOpportunities = new List<SalesPipelineModel>(allOpportunities);

            if (!showArchived)
            {
                OrganizePipelineStages();
            }
        });
    }

    private void OrganizePipelineStages()
    {
        pipelineStages.Clear();

        foreach (var stage in allStages.OrderBy(s => s.StageOrder))
        {
            // Limit to 5 most recently added deals per stage
            var stageDeals = filteredOpportunities
                .Where(o => o.StageId == stage.StageId)
                .OrderByDescending(o => o.OpportunityId) // Most recently added first
                .Take(5)
                .ToList();

            pipelineStages.Add(new PipelineColumn
            {
                StageId = stage.StageId,
                StageName = stage.StageName,
                StageColor = stage.StageColor,
                StageOrder = stage.StageOrder,
                Deals = stageDeals
            });
        }
    }

    private Dictionary<string, List<SalesPipelineModel>> GetGroupedOpportunities()
    {
        return filteredOpportunities
            .GroupBy(o => string.IsNullOrWhiteSpace(o.CompanyName) ? "Individual Customers" : o.CompanyName)
            .OrderBy(g => g.Key)
            .ToDictionary(g => g.Key, g => g.OrderBy(o => o.OpportunityName).ToList());
    }

    private void SetView(bool pipelineView) => isPipelineView = pipelineView;

    private async Task ToggleArchivedView()
    {
        showArchived = !showArchived;
        searchTerm = "";
        selectedStageFilter = 0;
        await LoadData();
    }

    private void ToggleModal()
    {
        showModal = !showModal;
        if (showModal && !isEditMode)
        {
            newOpportunity = new SalesPipelineModel { AssignedTo = 1 };
            closeDate = null;
        }
        else if (!showModal)
        {
            isEditMode = false;
        }
    }

    private void CloseModalOutside()
    {
        showModal = false;
        isEditMode = false;
    }

    private void EditOpportunity(int opportunityId)
    {
        var opp = allOpportunities.FirstOrDefault(o => o.OpportunityId == opportunityId);
        if (opp != null)
        {
            newOpportunity = new SalesPipelineModel
            {
                OpportunityId = opp.OpportunityId,
                OpportunityName = opp.OpportunityName,
                CustomerId = opp.CustomerId,
                StageId = opp.StageId,
                DealValue = opp.DealValue,
                Probability = opp.Probability,
                ExpectedCloseDate = opp.ExpectedCloseDate,
                AssignedTo = opp.AssignedTo,
                Notes = opp.Notes
            };
            closeDate = opp.ExpectedCloseDate;
            isEditMode = true;
            showModal = true;
        }
    }

    private async Task SaveOpportunity()
    {
        if (string.IsNullOrWhiteSpace(newOpportunity.OpportunityName) ||
            newOpportunity.CustomerId == 0 ||
            newOpportunity.StageId == 0 ||
            newOpportunity.AssignedTo == 0)
            return;

        newOpportunity.ExpectedCloseDate = closeDate;

        bool success = isEditMode
            ? await Task.Run(() => pipelineService.UpdateOpportunity(newOpportunity))
            : await Task.Run(() => pipelineService.AddOpportunity(newOpportunity));

        if (success)
        {
            await LoadData();
            ToggleModal();
        }
    }

    private void ShowDeleteConfirmation()
    {
        confirmTitle = "Archive Opportunity";
        confirmMessage = $"Are you sure you want to archive '{newOpportunity.OpportunityName}'? This opportunity will be moved to the archived list but can be restored later.";
        confirmButtonText = "Archive";
        confirmCallback = async () => await DeleteOpportunity();
        showConfirmModal = true;
    }

    private void ShowRestoreConfirmation(SalesPipelineModel opportunity)
    {
        confirmTitle = "Restore Opportunity";
        confirmMessage = $"Are you sure you want to restore '{opportunity.OpportunityName}'? This will move it back to the active pipeline.";
        confirmButtonText = "Restore";
        confirmCallback = async () => await RestoreOpportunity(opportunity.OpportunityId);
        showConfirmModal = true;
    }

    private async Task DeleteOpportunity()
    {
        if (isEditMode && newOpportunity.OpportunityId > 0)
        {
            bool success = await Task.Run(() => pipelineService.ArchiveOpportunity(newOpportunity.OpportunityId));
            if (success)
            {
                await LoadData();
                ToggleModal();
            }
        }
    }

    private async Task RestoreOpportunity(int opportunityId)
    {
        bool success = await Task.Run(() => pipelineService.RestoreOpportunity(opportunityId));
        if (success)
        {
            await LoadData();
        }
    }

    private async void ConfirmAction()
    {
        showConfirmModal = false;
        if (confirmCallback != null)
        {
            await Task.Run(confirmCallback);
            confirmCallback = null;
        }
    }

    private void CancelConfirmation()
    {
        showConfirmModal = false;
        confirmCallback = null;
    }

    private void ClearSearch()
    {
        searchTerm = "";
        ApplyFilters();
    }

    private void ClearFilters()
    {
        searchTerm = "";
        selectedStageFilter = 0;
        filteredOpportunities = new List<SalesPipelineModel>(allOpportunities);

        if (!showArchived)
        {
            OrganizePipelineStages();
        }

        StateHasChanged();
    }

    private void PerformSearch()
    {
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        filteredOpportunities = allOpportunities;

        // Apply stage filter (only for active view)
        if (!showArchived && selectedStageFilter > 0)
        {
            filteredOpportunities = filteredOpportunities.Where(o => o.StageId == selectedStageFilter).ToList();
        }
        
        // Apply search filter
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            var term = searchTerm.ToLower();
            filteredOpportunities = filteredOpportunities.Where(o =>
                o.OpportunityName.ToLower().Contains(term) ||
                o.CompanyName.ToLower().Contains(term) ||
                o.CustomerName.ToLower().Contains(term))
                .ToList();
        }

        if (!showArchived)
        {
            OrganizePipelineStages();
        }

        StateHasChanged();
    }

    private void FilterByStage(ChangeEventArgs e)
    {
        selectedStageFilter = Convert.ToInt32(e.Value);
        ApplyFilters();
    }

    private List<SalesPipelineModel> GetPaginatedOpportunities()
    {
        totalRecords = filteredOpportunities.Count;
        return filteredOpportunities
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize)
            .ToList();
    }

    private async Task ChangePage(int page)
    {
        if (page < 1 || page > TotalPages) return;
        currentPage = page;
        StateHasChanged();
    }

    private async Task ReloadWithNewPageSize()
    {
        currentPage = 1;
        StateHasChanged();
    }

    private void ToggleSummaryCards()
    {
        showSummaryCards = !showSummaryCards;
    }
}
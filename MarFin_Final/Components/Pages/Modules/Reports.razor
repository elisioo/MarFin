@page "/reports"
@inject NavigationManager Navigation
@inject AuthService AuthService
@inject IJSRuntime JS
@using MarFin_Final.Database.Services
@using System.Globalization
@using MarFin_Final.Services
@using Microsoft.Maui.Storage
@using Microsoft.Maui.ApplicationModel
@using System.IO

@code {
    private ReportService reportService = new ReportService();
    private bool isLoading = true;
    private string errorMessage = "";

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/login", true);
            return;
        }

        if (!AuthService.HasPermission(RolePermissions.Permissions.ViewReports))
        {
            Navigation.NavigateTo("/dashboard", true);
            return;
        }

        await LoadReportData();
    }

    private async Task LoadReportData()
    {
        try
        {
            isLoading = true;
            errorMessage = "";

            // Load revenue data
            revenueData = await reportService.GetRevenueByMonthAsync(startDate, endDate);

            // Load campaign performance
            campaignPerformance = await reportService.GetCampaignPerformanceAsync(startDate, endDate);

            // Load top customers
            topCustomers = await reportService.GetTopCustomersAsync(startDate, endDate);

            // Load sales opportunities
            salesOpportunities = await reportService.GetSalesOpportunitiesAsync(startDate, endDate);

            // Load customer segments
            customerSegments = await reportService.GetCustomerSegmentsAsync(startDate, endDate);

            // Load revenue sources
            revenueSources = await reportService.GetRevenueBySourceAsync(startDate, endDate);

            _revenueChartRendered = false;
            isLoading = false;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading report data: {ex.Message}";
            isLoading = false;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!isLoading && revenueData.Any() && !_revenueChartRendered)
        {
            await RenderRevenueChartAsync();
            _revenueChartRendered = true;
        }
    }

    private async Task RenderRevenueChartAsync()
    {
        var labels = revenueData
            .Select(r => new DateTime(r.Year, r.Month, 1).ToString("MMM"))
            .ToArray();

        var incomeData = revenueData.Select(r => (double)r.Income).ToArray();
        var expenseData = revenueData.Select(r => (double)r.Expense).ToArray();

        await JS.InvokeVoidAsync(
            "chartJsInterop.createBarChart",
            "revenueByMonthChart",
            labels,
            new object[]
            {
                new
                {
                    label = "Income",
                    data = incomeData,
                    backgroundColor = "#10b981"
                },
                new
                {
                    label = "Expenses",
                    data = expenseData,
                    backgroundColor = "#ef4444"
                }
            });
    }
}

<div class="reports-container">
    <div class="reports-header">
        <div class="header-title">
            <h1>Reports & Analytics</h1>
            <span class="header-subtitle">
                @if (AuthService.IsAdmin())
                {
                    @:Complete analytics and reports across all departments
                }
                else if (AuthService.IsFinance())
                {
                    @:Financial reports and transaction analytics
                }
                else if (AuthService.IsMarketing())
                {
                    @:Marketing campaign and customer analytics
                }
                else if (AuthService.IsSalesRep())
                {
                    @:Sales pipeline and opportunity reports
                }
            </span>
        </div>
        <button class="btn-export">
            <i class="bi bi-download"></i> Export All Reports
        </button>
    </div>

    <!-- Date Range Filters -->
    <div class="date-filters">
        <button class="filter-btn @(selectedFilter == "thisMonth" ? "active" : "")" @onclick='() => SetFilterAndReload("thisMonth")'>
            This Month
        </button>
        <button class="filter-btn @(selectedFilter == "last3Months" ? "active" : "")" @onclick='() => SetFilterAndReload("last3Months")'>
            Last 3 Months
        </button>
        <button class="filter-btn @(selectedFilter == "thisYear" ? "active" : "")" @onclick='() => SetFilterAndReload("thisYear")'>
            This Year
        </button>
        <button class="filter-btn @(selectedFilter == "custom" ? "active" : "")" @onclick='() => SetFilter("custom")'>
            Custom Range
        </button>
        @if (selectedFilter == "custom")
        {
            <div class="date-inputs">
                <input type="date" class="date-input" @bind="startDate" @bind:after="LoadReportData" />
                <span>-</span>
                <input type="date" class="date-input" @bind="endDate" @bind:after="LoadReportData" />
            </div>
        }
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">
            <span>@errorMessage</span>
            <button class="alert-close" @onclick='() => errorMessage = ""'>×</button>
        </div>
    }

    <!-- Performance Overview - Role-Based -->
    <div class="section-title">Performance Overview</div>

    <div class="charts-grid">
        <!-- ADMIN & FINANCE: Revenue by Month Chart -->
        @if (AuthService.IsAdmin() || AuthService.IsFinance())
        {
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Revenue by Month</h3>
                    <button class="btn-chart-action"><i class="bi bi-three-dots-vertical"></i></button>
                </div>
                <div class="chart-content">
                    @if (isLoading)
                    {
                        <p>Loading revenue data...</p>
                    }
                    else if (revenueData.Any())
                    {
                        <div style="height: 260px;">
                            <canvas id="revenueByMonthChart"></canvas>
                        </div>
                    }
                    else
                    {
                        <p>No revenue data available for the selected period.</p>
                    }
                </div>
            </div>
        }

        <!-- ADMIN & MARKETING: Campaign Performance -->
        @if (AuthService.IsAdmin() || AuthService.IsMarketing())
        {
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Campaign Performance</h3>
                    <button class="btn-chart-action"><i class="bi bi-three-dots-vertical"></i></button>
                </div>
                <div class="chart-content">
                    @if (isLoading)
                    {
                        <p>Loading campaign data...</p>
                    }
                    else if (campaignPerformance != null)
                    {
                        <div class="metric-list">
                            <div class="metric-item">
                                <span class="metric-label">Email Open Rate</span>
                                <div class="metric-bar-container">
                                    <div class="metric-bar" style="width: @(Math.Min(campaignPerformance.OpenRate, 100))%"></div>
                                </div>
                                <span class="metric-value">@campaignPerformance.OpenRate.ToString("F1")%</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">Click Through Rate</span>
                                <div class="metric-bar-container">
                                    <div class="metric-bar" style="width: @(Math.Min(campaignPerformance.ClickRate, 100))%"></div>
                                </div>
                                <span class="metric-value">@campaignPerformance.ClickRate.ToString("F1")%</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">Conversion Rate</span>
                                <div class="metric-bar-container">
                                    <div class="metric-bar" style="width: @(Math.Min(campaignPerformance.ConversionRate, 100))%"></div>
                                </div>
                                <span class="metric-value">@campaignPerformance.ConversionRate.ToString("F1")%</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">ROI</span>
                                <div class="metric-bar-container">
                                    <div class="metric-bar" style="width: @(Math.Min(campaignPerformance.ROI / 10, 100))%"></div>
                                </div>
                                <span class="metric-value">@campaignPerformance.ROI.ToString("F1")%</span>
                            </div>
                        </div>
                    }
                    else
                    {
                        <p>No campaign data available for the selected period.</p>
                    }
                </div>
            </div>
        }

        <!-- ADMIN, FINANCE, SALES: Top Customers -->
        @if (AuthService.IsAdmin() || AuthService.IsFinance() || AuthService.IsSalesRep())
        {
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Top Customers</h3>
                    <button class="btn-chart-action"><i class="bi bi-three-dots-vertical"></i></button>
                </div>
                <div class="chart-content">
                    <div class="customer-list">
                        @foreach (var customer in topCustomers)
                        {
                            <div class="customer-item">
                                <span class="customer-rank">@customer.Rank.</span>
                                <span class="customer-name">@customer.Name</span>
                                <span class="customer-amount">@customer.Amount</span>
                                <span class="customer-transactions">@customer.Transactions txns</span>
                                <button class="btn-arrow"><i class="bi bi-arrow-right"></i></button>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }

        <!-- ADMIN, SALES: Sales Pipeline Health -->
        @if (AuthService.IsAdmin() || AuthService.IsSalesRep())
        {
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Sales Opportunities</h3>
                    <button class="btn-chart-action"><i class="bi bi-three-dots-vertical"></i></button>
                </div>
                <div class="chart-content">
                    @if (isLoading)
                    {
                        <p>Loading sales data...</p>
                    }
                    else if (salesOpportunities != null)
                    {
                        <div class="opportunity-stats">
                            <div class="opp-stat">
                                <span class="opp-label">Active</span>
                                <span class="opp-value">@salesOpportunities.Active</span>
                            </div>
                            <div class="opp-stat">
                                <span class="opp-label">Won</span>
                                <span class="opp-value">@salesOpportunities.Won</span>
                            </div>
                            <div class="opp-stat">
                                <span class="opp-label">Lost</span>
                                <span class="opp-value">@salesOpportunities.Lost</span>
                            </div>
                            <div class="opp-stat">
                                <span class="opp-label">Win Rate</span>
                                <span class="opp-value">@salesOpportunities.WinRate.ToString("F1")%</span>
                            </div>
                        </div>
                        <div class="pipeline-value">
                            <span class="pipeline-label">Total Pipeline Value:</span>
                            <span class="pipeline-amount">₱@salesOpportunities.TotalPipelineValue.ToString("N2")</span>
                        </div>
                    }
                    else
                    {
                        <p>No sales data available for the selected period.</p>
                    }
                </div>
            </div>
        }

        <!-- ADMIN, MARKETING: Customer Segments -->
        @if (AuthService.IsAdmin() || AuthService.IsMarketing())
        {
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Customer Segments</h3>
                    <button class="btn-chart-action"><i class="bi bi-three-dots-vertical"></i></button>
                </div>
                <div class="chart-content">
                    <div class="segment-list">
                        @foreach (var segment in customerSegments)
                        {
                            <div class="segment-item">
                                <div class="segment-info">
                                    <span class="segment-name">@segment.Name</span>
                                    <span class="segment-count">@segment.Count customers</span>
                                </div>
                                <div class="segment-bar-container">
                                    <div class="segment-bar" style="width: @segment.Percentage%"></div>
                                </div>
                                <span class="segment-percentage">@segment.Percentage%</span>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }

        <!-- ADMIN, FINANCE: Revenue by Source -->
        @if (AuthService.IsAdmin() || AuthService.IsFinance())
        {
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Revenue by Source</h3>
                    <button class="btn-chart-action"><i class="bi bi-three-dots-vertical"></i></button>
                </div>
                <div class="chart-content">
                    <div class="source-list">
                        @foreach (var source in revenueSources)
                        {
                            <div class="source-item">
                                <span class="source-label">@source.Name</span>
                                <div class="source-bar-container">
                                    <div class="source-bar" style="width: @source.Percentage%"></div>
                                </div>
                                <span class="source-value">@source.Percentage%</span>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Generate Custom Reports Section -->
    <div class="section-title" style="margin-top: 3rem;">Generate Custom Reports</div>

    <div class="custom-reports-grid">
        <!-- ADMIN, MARKETING: Customer Report -->
        @if (AuthService.IsAdmin() || AuthService.IsMarketing())
        {
            <div class="report-card">
                <div class="report-icon customer">
                    <i class="bi bi-person-badge"></i>
                </div>
                <div class="report-content">
                    <h4>Customer Report</h4>
                    <p>Complete customer data with interactions, segments, and revenue breakdown</p>
                </div>
                <button class="btn-generate" @onclick='() => OpenConfirmModal("customer", "Customer Report")'>
                    <i class="bi bi-file-earmark-arrow-down"></i> Generate
                </button>
            </div>
        }

        <!-- ADMIN, FINANCE: Financial Report -->
        @if (AuthService.IsAdmin() || AuthService.IsFinance())
        {
            <div class="report-card">
                <div class="report-icon financial">
                    <i class="bi bi-bar-chart"></i>
                </div>
                <div class="report-content">
                    <h4>Financial Report</h4>
                    <p>Revenue, expenses, invoices, and transaction details with P&L statement</p>
                </div>
                <button class="btn-generate" @onclick='() => OpenConfirmModal("financial", "Financial Report")'>
                    <i class="bi bi-file-earmark-arrow-down"></i> Generate
                </button>
            </div>
        }

        <!-- ADMIN, MARKETING: Campaign Report -->
        @if (AuthService.IsAdmin() || AuthService.IsMarketing())
        {
            <div class="report-card">
                <div class="report-icon campaign">
                    <i class="bi bi-megaphone"></i>
                </div>
                <div class="report-content">
                    <h4>Campaign Report</h4>
                    <p>Marketing campaign performance, ROI, engagement metrics, and conversions</p>
                </div>
                <button class="btn-generate" @onclick='() => OpenConfirmModal("campaign", "Campaign Report")'>
                    <i class="bi bi-file-earmark-arrow-down"></i> Generate
                </button>
            </div>
        }

        <!-- ADMIN, SALES: Sales Pipeline Report -->
        @if (AuthService.IsAdmin() || AuthService.IsSalesRep())
        {
            <div class="report-card">
                <div class="report-icon sales">
                    <i class="bi bi-graph-up-arrow"></i>
                </div>
                <div class="report-content">
                    <h4>Sales Pipeline Report</h4>
                    <p>Opportunity tracking, win rates, pipeline health, and forecast analysis</p>
                </div>
                <button class="btn-generate" @onclick='() => OpenConfirmModal("sales", "Sales Pipeline Report")'>
                    <i class="bi bi-file-earmark-arrow-down"></i> Generate
                </button>
            </div>
        }

        <!-- ADMIN, FINANCE: Invoice Report -->
        @if (AuthService.IsAdmin() || AuthService.IsFinance())
        {
            <div class="report-card">
                <div class="report-icon invoice">
                    <i class="bi bi-receipt"></i>
                </div>
                <div class="report-content">
                    <h4>Invoice Report</h4>
                    <p>All invoices with payment status, overdue tracking, and aging analysis</p>
                </div>
                <button class="btn-generate" @onclick='() => OpenConfirmModal("invoice", "Invoice Report")'>
                    <i class="bi bi-file-earmark-arrow-down"></i> Generate
                </button>
            </div>
        }

        <!-- ADMIN ONLY: User Activity Report -->
        @if (AuthService.IsAdmin())
        {
            <div class="report-card">
                <div class="report-icon activity">
                    <i class="bi bi-activity"></i>
                </div>
                <div class="report-content">
                    <h4>User Activity Report</h4>
                    <p>System usage, user logins, actions performed, and audit trail</p>
                </div>
                <button class="btn-generate" @onclick='() => OpenConfirmModal("activity", "User Activity Report")'>
                    <i class="bi bi-file-earmark-arrow-down"></i> Generate
                </button>
            </div>
        }
    </div>
</div>

@if (showConfirmModal)
{
    <div class="modal-backdrop"></div>
    <div class="modal-container">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3>Generate @pendingReportTitle?</h3>
            </div>
            <div class="modal-body">
                <p>Report period: @startDate.ToString("MMMM dd, yyyy") – @endDate.ToString("MMMM dd, yyyy")</p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" @onclick="CancelGenerateReport">Cancel</button>
                <button class="btn-primary" @onclick="ConfirmGenerateReport">Generate</button>
            </div>
        </div>
    </div>
}

@code {
    private bool showConfirmModal;
    private string? pendingReportType;
    private string pendingReportTitle = "";

    private string selectedFilter = "thisMonth";
    private DateTime startDate = DateTime.Now.AddDays(-30);
    private DateTime endDate = DateTime.Now;

    private void SetFilter(string filter)
    {
        selectedFilter = filter;

        if (filter == "thisMonth")
        {
            startDate = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1);
            endDate = DateTime.Now;
        }
        else if (filter == "last3Months")
        {
            startDate = DateTime.Now.AddMonths(-3);
            endDate = DateTime.Now;
        }
        else if (filter == "thisYear")
        {
            startDate = new DateTime(DateTime.Now.Year, 1, 1);
            endDate = DateTime.Now;
        }
    }

    private string GetMonthName(int month)
    {
        var months = new[] { "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec" };
        return months[month % 12];
    }

    private void OpenConfirmModal(string reportType, string reportTitle)
    {
        pendingReportType = reportType;
        pendingReportTitle = reportTitle;
        showConfirmModal = true;
    }

    private void CancelGenerateReport()
    {
        showConfirmModal = false;
        pendingReportType = null;
    }

    private async Task ConfirmGenerateReport()
    {
        var type = pendingReportType;
        showConfirmModal = false;
        pendingReportType = null;

        if (!string.IsNullOrEmpty(type))
        {
            await GenerateReport(type);
        }
    }

    private async Task GenerateReport(string reportType)
    {
        try
        {
            // Generate PDF bytes using QuestPDF-based ReportPdfService
            var pdfBytes = ReportPdfService.GenerateReportPdf(
                reportType,
                startDate,
                endDate,
                campaignPerformance,
                revenueData,
                topCustomers,
                salesOpportunities,
                customerSegments,
                revenueSources,
                null
            );

            // Save to a temporary file and open with the system PDF viewer
            var cacheDir = FileSystem.CacheDirectory;
            var fileName = $"MarFin_{reportType}_Report_{DateTime.Now:yyyyMMdd_HHmmss}.pdf";
            var filePath = Path.Combine(cacheDir, fileName);

            File.WriteAllBytes(filePath, pdfBytes);

            await Launcher.OpenAsync(new OpenFileRequest
            {
                File = new ReadOnlyFile(filePath)
            });
        }
        catch (Exception ex)
        {
            errorMessage = $"Error generating report: {ex.Message}";
        }
    }

    private async Task SetFilterAndReload(string filter)
    {
        SetFilter(filter);
        await LoadReportData();
    }

    // Data properties
    private bool _revenueChartRendered;
    private List<ReportService.RevenueData> revenueData = new List<ReportService.RevenueData>();
    private ReportService.CampaignPerformanceData? campaignPerformance;
    private List<ReportService.TopCustomerData> topCustomers = new List<ReportService.TopCustomerData>();
    private ReportService.SalesOpportunitiesData? salesOpportunities;
    private List<ReportService.CustomerSegmentData> customerSegments = new List<ReportService.CustomerSegmentData>();
    private List<ReportService.RevenueSourceData> revenueSources = new List<ReportService.RevenueSourceData>();
}
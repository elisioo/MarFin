@page "/reports"
@inject NavigationManager Navigation
@inject AuthService AuthService
@inject IJSRuntime JS
@implements IDisposable
@using MarFin_Final.Database.Services
@using MarFin_Final.Data
@using MarFin_Final.Models
@using System.Globalization
@using MarFin_Final.Services
@using Microsoft.Maui.Storage
@using Microsoft.Maui.ApplicationModel
@using System.IO
@using System.Text

@inject InvoiceService InvoiceService
@inject ReportService ReportService

<div class="reports-container">
    <div class="reports-header">
        <div class="header-title">
            <h1>Reports & Analytics</h1>
            <span class="header-subtitle">
                @if (AuthService.IsAdmin())
                {
                    @:Complete analytics and reports across all departments
                }
                else if (AuthService.IsFinance())
                {
                    @:Financial reports and transaction analytics
                }
                else if (AuthService.IsMarketing())
                {
                    @:Marketing campaign and customer analytics
                }
                else if (AuthService.IsSalesRep())
                {
                    @:Sales pipeline and opportunity reports
                }
            </span>
        </div>
        <button class="btn-export" @onclick='() => OpenReportModal("all", "All Reports")'>
            <i class="bi bi-download"></i> Export All Reports
        </button>
    </div>

    <!-- Date Range Filters -->
    <div class="date-filters">
        <button class="filter-btn @(selectedFilter == "thisMonth" ? "active" : "")" @onclick='() => SetFilterAndReload("thisMonth")'>
            This Month
        </button>
        <button class="filter-btn @(selectedFilter == "last3Months" ? "active" : "")" @onclick='() => SetFilterAndReload("last3Months")'>
            Last 3 Months
        </button>
        <button class="filter-btn @(selectedFilter == "thisYear" ? "active" : "")" @onclick='() => SetFilterAndReload("thisYear")'>
            This Year
        </button>
        <button class="filter-btn @(selectedFilter == "custom" ? "active" : "")" @onclick='() => SetFilter("custom")'>
            Custom Range
        </button>
        @if (selectedFilter == "custom")
        {
            <div class="date-inputs">
                <input type="date" class="date-input" @bind="startDate" @bind:after="LoadReportData" />
                <span>-</span>
                <input type="date" class="date-input" @bind="endDate" @bind:after="LoadReportData" />
            </div>
        }
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">
            <span>@errorMessage</span>
            <button class="alert-close" @onclick='() => errorMessage = ""'>×</button>
        </div>
    }

    <!-- Performance Overview - Role-Based -->
    <div class="section-title">Performance Overview</div>

    <div class="charts-grid">
        <!-- ADMIN & FINANCE: Revenue by Month Chart -->
        @if (AuthService.IsAdmin() || AuthService.IsFinance())
        {
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Revenue by Month</h3>
                    <div class="chart-header-actions">
                        <button class="btn-chart-action" @onclick='() => ToggleCardMenu("revenue")'>
                            <i class="bi bi-three-dots-vertical"></i>
                        </button>
                        @if (activeCardMenu == "revenue")
                        {
                            <div class="chart-action-menu">
                                <button type="button" @onclick='() => OpenViewModal("revenue", "Revenue by Month")'>View</button>
                                <button type="button" @onclick='() => OpenReportModal("financial", "Financial Report")'>Export as PDF</button>
                            </div>
                        }
                    </div>
                </div>
                <div class="chart-content">
                    @if (isLoading)
                    {
                        <p>Loading revenue data...</p>
                    }
                    else if (revenueData.Any())
                    {
                        <div style="height: 260px;">
                            <canvas id="revenueByMonthChart"></canvas>
                        </div>
                    }
                    else
                    {
                        <p>No revenue data available for the selected period.</p>
                    }
                </div>
            </div>
        }

        <!-- ADMIN & MARKETING: Campaign Performance -->
        @if (AuthService.IsAdmin() || AuthService.IsMarketing())
        {
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Campaign Performance</h3>
                    <div class="chart-header-actions">
                        <button class="btn-chart-action" @onclick='() => ToggleCardMenu("campaign")'>
                            <i class="bi bi-three-dots-vertical"></i>
                        </button>
                        @if (activeCardMenu == "campaign")
                        {
                            <div class="chart-action-menu">
                                <button type="button" @onclick='() => OpenViewModal("campaign", "Campaign Performance")'>View</button>
                                <button type="button" @onclick='() => OpenReportModal("campaign", "Campaign Report")'>Export as PDF</button>
                            </div>
                        }
                    </div>
                </div>
                <div class="chart-content">
                    @if (isLoading)
                    {
                        <p>Loading campaign data...</p>
                    }
                    else if (campaignPerformance != null)
                    {
                        <div class="metric-list">
                            <div class="metric-item">
                                <span class="metric-label">Email Open Rate</span>
                                <div class="metric-bar-container">
                                    <div class="metric-bar" style="width: @(Math.Min(campaignPerformance.OpenRate, 100))%"></div>
                                </div>
                                <span class="metric-value">@campaignPerformance.OpenRate.ToString("F1")%</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">Click Through Rate</span>
                                <div class="metric-bar-container">
                                    <div class="metric-bar" style="width: @(Math.Min(campaignPerformance.ClickRate, 100))%"></div>
                                </div>
                                <span class="metric-value">@campaignPerformance.ClickRate.ToString("F1")%</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">Conversion Rate</span>
                                <div class="metric-bar-container">
                                    <div class="metric-bar" style="width: @(Math.Min(campaignPerformance.ConversionRate, 100))%"></div>
                                </div>
                                <span class="metric-value">@campaignPerformance.ConversionRate.ToString("F1")%</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">ROI</span>
                                <div class="metric-bar-container">
                                    <div class="metric-bar" style="width: @(Math.Min(campaignPerformance.ROI / 10, 100))%"></div>
                                </div>
                                <span class="metric-value">@campaignPerformance.ROI.ToString("F1")%</span>
                            </div>
                        </div>
                    }
                    else
                    {
                        <p>No campaign data available for the selected period.</p>
                    }
                </div>
            </div>
        }

        <!-- ADMIN, FINANCE, SALES: Top Customers -->
        @if (AuthService.IsAdmin() || AuthService.IsFinance() || AuthService.IsSalesRep())
        {
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Top Customers</h3>
                    <div class="chart-header-actions">
                        <button class="btn-chart-action" @onclick='() => ToggleCardMenu("topCustomers")'>
                            <i class="bi bi-three-dots-vertical"></i>
                        </button>
                        @if (activeCardMenu == "topCustomers")
                        {
                            <div class="chart-action-menu">
                                <button type="button" @onclick='() => OpenViewModal("topCustomers", "Top Customers")'>View</button>
                                <button type="button" @onclick='() => OpenReportModal("customer", "Customer Report")'>Export as PDF</button>
                            </div>
                        }
                    </div>
                </div>
                <div class="chart-content">
                    <div class="customer-list">
                        @foreach (var customer in topCustomers)
                        {
                            <div class="customer-item">
                                <span class="customer-rank">@customer.Rank.</span>
                                <span class="customer-name">@customer.Name</span>
                                <span class="customer-amount">@customer.Amount</span>
                                <span class="customer-transactions">@customer.Transactions txns</span>
                                <button class="btn-arrow"><i class="bi bi-arrow-right"></i></button>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }

        <!-- ADMIN, SALES: Sales Pipeline Health -->
        @if (AuthService.IsAdmin() || AuthService.IsSalesRep())
        {
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Sales Opportunities</h3>
                    <div class="chart-header-actions">
                        <button class="btn-chart-action" @onclick='() => ToggleCardMenu("sales")'>
                            <i class="bi bi-three-dots-vertical"></i>
                        </button>
                        @if (activeCardMenu == "sales")
                        {
                            <div class="chart-action-menu">
                                <button type="button" @onclick='() => OpenViewModal("sales", "Sales Opportunities")'>View</button>
                                <button type="button" @onclick='() => OpenReportModal("sales", "Sales Pipeline Report")'>Export as PDF</button>
                            </div>
                        }
                    </div>
                </div>
                <div class="chart-content">
                    @if (isLoading)
                    {
                        <p>Loading sales data...</p>
                    }
                    else if (salesOpportunities != null)
                    {
                        <div class="opportunity-stats">
                            <div class="opp-stat">
                                <span class="opp-label">Active</span>
                                <span class="opp-value">@salesOpportunities.Active</span>
                            </div>
                            <div class="opp-stat">
                                <span class="opp-label">Won</span>
                                <span class="opp-value">@salesOpportunities.Won</span>
                            </div>
                            <div class="opp-stat">
                                <span class="opp-label">Lost</span>
                                <span class="opp-value">@salesOpportunities.Lost</span>
                            </div>
                            <div class="opp-stat">
                                <span class="opp-label">Win Rate</span>
                                <span class="opp-value">@salesOpportunities.WinRate.ToString("F1")%</span>
                            </div>
                        </div>
                        <div class="pipeline-value">
                            <span class="pipeline-label">Total Pipeline Value:</span>
                            <span class="pipeline-amount">₱@salesOpportunities.TotalPipelineValue.ToString("N2")</span>
                        </div>
                    }
                    else
                    {
                        <p>No sales data available for the selected period.</p>
                    }
                </div>
            </div>
        }

        <!-- ADMIN, MARKETING: Customer Segments -->
        @if (AuthService.IsAdmin() || AuthService.IsMarketing())
        {
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Customer Segments</h3>
                    <div class="chart-header-actions">
                        <button class="btn-chart-action" @onclick='() => ToggleCardMenu("segments")'>
                            <i class="bi bi-three-dots-vertical"></i>
                        </button>
                        @if (activeCardMenu == "segments")
                        {
                            <div class="chart-action-menu">
                                <button type="button" @onclick='() => OpenViewModal("segments", "Customer Segments")'>View</button>
                                <button type="button" @onclick='() => OpenReportModal("customer", "Customer Report")'>Export as PDF</button>
                            </div>
                        }
                    </div>
                </div>
                <div class="chart-content">
                    <div class="segment-list">
                        @foreach (var segment in customerSegments)
                        {
                            <div class="segment-item">
                                <div class="segment-info">
                                    <span class="segment-name">@segment.Name</span>
                                    <span class="segment-count">@segment.Count customers</span>
                                </div>
                                <div class="segment-bar-container">
                                    <div class="segment-bar" style="width: @segment.Percentage%"></div>
                                </div>
                                <span class="segment-percentage">@segment.Percentage%</span>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }

        <!-- ADMIN, FINANCE: Revenue by Source -->
        @if (AuthService.IsAdmin() || AuthService.IsFinance())
        {
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Revenue by Source</h3>
                    <div class="chart-header-actions">
                        <button class="btn-chart-action" @onclick='() => ToggleCardMenu("sources")'>
                            <i class="bi bi-three-dots-vertical"></i>
                        </button>
                        @if (activeCardMenu == "sources")
                        {
                            <div class="chart-action-menu">
                                <button type="button" @onclick='() => OpenViewModal("sources", "Revenue by Source")'>View</button>
                                <button type="button" @onclick='() => OpenReportModal("financial", "Financial Report")'>Export as PDF</button>
                            </div>
                        }
                    </div>
                </div>
                <div class="chart-content">
                    <div class="source-list">
                        @foreach (var source in revenueSources)
                        {
                            <div class="source-item">
                                <span class="source-label">@source.Name</span>
                                <div class="source-bar-container">
                                    <div class="source-bar" style="width: @source.Percentage%"></div>
                                </div>
                                <span class="source-value">@source.Percentage%</span>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Generate Custom Reports Section -->
    <div class="section-title" style="margin-top: 3rem;">Generate Custom Reports</div>

    <div class="custom-reports-grid">
        <!-- ADMIN, MARKETING: Customer Report -->
        @if (AuthService.IsAdmin() || AuthService.IsMarketing())
        {
            <div class="report-card">
                <div class="report-icon customer">
                    <i class="bi bi-person-badge"></i>
                </div>
                <div class="report-content">
                    <h4>Customer Report</h4>
                    <p>Complete customer data with interactions, segments, and revenue breakdown</p>
                </div>
                <button class="btn-generate" @onclick='() => OpenReportModal("customer", "Customer Report")'>
                    <i class="bi bi-file-earmark-arrow-down"></i> Generate
                </button>
            </div>
        }

        <!-- ADMIN, FINANCE: Financial Report -->
        @if (AuthService.IsAdmin() || AuthService.IsFinance())
        {
            <div class="report-card">
                <div class="report-icon financial">
                    <i class="bi bi-bar-chart"></i>
                </div>
                <div class="report-content">
                    <h4>Financial Report</h4>
                    <p>Revenue, expenses, invoices, and transaction details with P&L statement</p>
                </div>
                <button class="btn-generate" @onclick='() => OpenReportModal("financial", "Financial Report")'>
                    <i class="bi bi-file-earmark-arrow-down"></i> Generate
                </button>
            </div>
        }

        <!-- ADMIN, MARKETING: Campaign Report -->
        @if (AuthService.IsAdmin() || AuthService.IsMarketing())
        {
            <div class="report-card">
                <div class="report-icon campaign">
                    <i class="bi bi-megaphone"></i>
                </div>
                <div class="report-content">
                    <h4>Campaign Report</h4>
                    <p>Marketing campaign performance, ROI, engagement metrics, and conversions</p>
                </div>
                <button class="btn-generate" @onclick='() => OpenReportModal("campaign", "Campaign Report")'>
                    <i class="bi bi-file-earmark-arrow-down"></i> Generate
                </button>
            </div>
        }

        <!-- ADMIN, SALES: Sales Pipeline Report -->
        @if (AuthService.IsAdmin() || AuthService.IsSalesRep())
        {
            <div class="report-card">
                <div class="report-icon sales">
                    <i class="bi bi-graph-up-arrow"></i>
                </div>
                <div class="report-content">
                    <h4>Sales Pipeline Report</h4>
                    <p>Opportunity tracking, win rates, pipeline health, and forecast analysis</p>
                </div>
                <button class="btn-generate" @onclick='() => OpenReportModal("sales", "Sales Pipeline Report")'>
                    <i class="bi bi-file-earmark-arrow-down"></i> Generate
                </button>
            </div>
        }

        <!-- ADMIN, FINANCE: Invoice Report -->
        @if (AuthService.IsAdmin() || AuthService.IsFinance())
        {
            <div class="report-card">
                <div class="report-icon invoice">
                    <i class="bi bi-receipt"></i>
                </div>
                <div class="report-content">
                    <h4>Invoice Report</h4>
                    <p>All invoices with payment status, overdue tracking, and aging analysis</p>
                </div>
                <button class="btn-generate" @onclick='() => OpenReportModal("invoice", "Invoice Report")'>
                    <i class="bi bi-file-earmark-arrow-down"></i> Generate
                </button>
            </div>
        }

        <!-- ADMIN ONLY: User Activity Report -->
        @if (AuthService.IsAdmin())
        {
            <div class="report-card">
                <div class="report-icon activity">
                    <i class="bi bi-activity"></i>
                </div>
                <div class="report-content">
                    <h4>User Activity Report</h4>
                    <p>System usage, user logins, actions performed, and audit trail</p>
                </div>
                <button class="btn-generate" @onclick='() => OpenReportModal("activity", "User Activity Report")'>
                    <i class="bi bi-file-earmark-arrow-down"></i> Generate
                </button>
            </div>
        }
    </div>
</div>

@if (showViewModal)
{
    <div class="modal-overlay p-3" @onclick="CloseViewModal">
        <div class="modal-content view-report-modal p-3" @onclick:stopPropagation>
            <div class="modal-header">
                <h3>@viewModalTitle</h3>
            </div>
            <div class="modal-body">
                @if (viewModalType == "revenue")
                {
                    @if (revenueData.Any())
                    {
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Month</th>
                                    <th>Income</th>
                                    <th>Expenses</th>
                                    <th>Net Profit</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var r in revenueData.OrderBy(x => x.Year).ThenBy(x => x.Month))
                                {
                                    var monthName = new DateTime(r.Year, r.Month, 1).ToString("MMMM yyyy");
                                    var profit = r.Income - r.Expense;
                                    <tr>
                                        <td>@monthName</td>
                                        <td>₱@r.Income.ToString("N2")</td>
                                        <td>₱@r.Expense.ToString("N2")</td>
                                        <td>₱@profit.ToString("N2")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <p>No revenue data available for the selected period.</p>
                    }
                }
                else if (viewModalType == "campaign")
                {
                    @if (campaignPerformance != null)
                    {
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Email Open Rate</td>
                                    <td>@campaignPerformance.OpenRate.ToString("F2")%</td>
                                </tr>
                                <tr>
                                    <td>Click-Through Rate</td>
                                    <td>@campaignPerformance.ClickRate.ToString("F2")%</td>
                                </tr>
                                <tr>
                                    <td>Conversion Rate</td>
                                    <td>@campaignPerformance.ConversionRate.ToString("F2")%</td>
                                </tr>
                                <tr>
                                    <td>ROI</td>
                                    <td>@campaignPerformance.ROI.ToString("F2")%</td>
                                </tr>
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <p>No campaign data available for the selected period.</p>
                    }
                }
                else if (viewModalType == "topCustomers")
                {
                    @if (topCustomers.Any())
                    {
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Customer</th>
                                    <th>Total Amount</th>
                                    <th>Transactions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var c in topCustomers)
                                {
                                    <tr>
                                        <td>@c.Rank</td>
                                        <td>@c.Name</td>
                                        <td>₱@c.Amount.ToString("N2")</td>
                                        <td>@c.Transactions</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <p>No customer data available for the selected period.</p>
                    }
                }
                else if (viewModalType == "sales")
                {
                    @if (salesOpportunities != null)
                    {
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Active</th>
                                    <th>Won</th>
                                    <th>Lost</th>
                                    <th>Total Pipeline Value</th>
                                    <th>Win Rate</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>@salesOpportunities.Active</td>
                                    <td>@salesOpportunities.Won</td>
                                    <td>@salesOpportunities.Lost</td>
                                    <td>₱@salesOpportunities.TotalPipelineValue.ToString("N2")</td>
                                    <td>@salesOpportunities.WinRate.ToString("F2")%</td>
                                </tr>
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <p>No sales data available for the selected period.</p>
                    }
                }
                else if (viewModalType == "segments")
                {
                    @if (customerSegments.Any())
                    {
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Segment</th>
                                    <th>Customer Count</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var s in customerSegments)
                                {
                                    <tr>
                                        <td>@s.Name</td>
                                        <td>@s.Count</td>
                                        <td>@s.Percentage.ToString("F2")%</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <p>No customer segment data available for the selected period.</p>
                    }
                }
                else if (viewModalType == "sources")
                {
                    @if (revenueSources.Any())
                    {
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Source</th>
                                    <th>Amount</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var s in revenueSources)
                                {
                                    <tr>
                                        <td>@s.Name</td>
                                        <td>₱@s.Amount.ToString("N2")</td>
                                        <td>@s.Percentage.ToString("F2")%</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <p>No revenue source data available for the selected period.</p>
                    }
                }
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" @onclick="CloseViewModal">Close</button>
            </div>
        </div>
    </div>
}

@if (showReportModal)
{
    <div class="modal-overlay p-3" @onclick="CloseReportModal">
        <div class="modal-content view-report-modal p-3" @onclick:stopPropagation>
            <div class="modal-header">
                <div>
                    <h3>@reportModalTitle</h3>
                    <p class="text-muted mb-0">Report period: @startDate.ToString("MMMM dd, yyyy") – @endDate.ToString("MMMM dd, yyyy")</p>
                </div>
            </div>
            <div class="modal-body">
                @if (reportModalType == "financial")
                {
                    if (revenueData.Any() || revenueSources.Any())
                    {
                        if (revenueData.Any())
                        {
                            var totalIncome = revenueData.Sum(r => r.Income);
                            var totalExpense = revenueData.Sum(r => r.Expense);
                            var netProfit = totalIncome - totalExpense;
                            var margin = totalIncome > 0 ? (netProfit / totalIncome * 100) : 0;

                            <h5>Revenue Overview</h5>
                            <div class="mb-3">
                                <p><strong>Total Income:</strong> ₱@totalIncome.ToString("N2")</p>
                                <p><strong>Total Expenses:</strong> ₱@totalExpense.ToString("N2")</p>
                                <p><strong>Net Profit:</strong> ₱@netProfit.ToString("N2")</p>
                                <p><strong>Profit Margin:</strong> @margin.ToString("F2")%</p>
                            </div>

                            <h5>Monthly Breakdown</h5>
                            <table class="report-table">
                                <thead>
                                    <tr>
                                        <th>Month</th>
                                        <th>Income</th>
                                        <th>Expenses</th>
                                        <th>Net Profit</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var r in revenueData.OrderBy(x => x.Year).ThenBy(x => x.Month))
                                    {
                                        var monthName = new DateTime(r.Year, r.Month, 1).ToString("MMMM yyyy");
                                        var profit = r.Income - r.Expense;
                                        <tr>
                                            <td>@monthName</td>
                                            <td>₱@r.Income.ToString("N2")</td>
                                            <td>₱@r.Expense.ToString("N2")</td>
                                            <td>₱@profit.ToString("N2")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }

                        if (revenueSources.Any())
                        {
                            <h5 class="mt-4">Revenue by Source</h5>
                            <table class="report-table">
                                <thead>
                                    <tr>
                                        <th>Source</th>
                                        <th>Amount</th>
                                        <th>Percentage</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var s in revenueSources)
                                    {
                                        <tr>
                                            <td>@s.Name</td>
                                            <td>₱@s.Amount.ToString("N2")</td>
                                            <td>@s.Percentage.ToString("F2")%</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }
                    }
                    else
                    {
                        <p>No financial data available for the selected period.</p>
                    }
                }
                else if (reportModalType == "campaign")
                {
                    if (campaignPerformance != null)
                    {
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Email Open Rate</td>
                                    <td>@campaignPerformance.OpenRate.ToString("F2")%</td>
                                </tr>
                                <tr>
                                    <td>Click-Through Rate</td>
                                    <td>@campaignPerformance.ClickRate.ToString("F2")%</td>
                                </tr>
                                <tr>
                                    <td>Conversion Rate</td>
                                    <td>@campaignPerformance.ConversionRate.ToString("F2")%</td>
                                </tr>
                                <tr>
                                    <td>ROI</td>
                                    <td>@campaignPerformance.ROI.ToString("F2")%</td>
                                </tr>
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <p>No campaign data available for the selected period.</p>
                    }
                }
                else if (reportModalType == "customer")
                {
                    if (topCustomers.Any())
                    {
                        <h5>Top Customers</h5>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Customer</th>
                                    <th>Total Amount</th>
                                    <th>Transactions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var c in topCustomers)
                                {
                                    <tr>
                                        <td>@c.Rank</td>
                                        <td>@c.Name</td>
                                        <td>₱@c.Amount.ToString("N2")</td>
                                        <td>@c.Transactions</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }

                    if (customerSegments.Any())
                    {
                        <h5 class="mt-4">Customer Segments</h5>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Segment</th>
                                    <th>Customer Count</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var s in customerSegments)
                                {
                                    <tr>
                                        <td>@s.Name</td>
                                        <td>@s.Count</td>
                                        <td>@s.Percentage.ToString("F2")%</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }

                    if (!topCustomers.Any() && !customerSegments.Any())
                    {
                        <p>No customer data available for the selected period.</p>
                    }
                }
                else if (reportModalType == "sales")
                {
                    if (salesOpportunities != null)
                    {
                        <h5>Sales Pipeline Summary</h5>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Total Opportunities</th>
                                    <th>Active</th>
                                    <th>Won</th>
                                    <th>Lost</th>
                                    <th>Total Pipeline Value</th>
                                    <th>Win Rate</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>@(salesOpportunityDetails?.Count ?? 0)</td>
                                    <td>@salesOpportunities.Active</td>
                                    <td>@salesOpportunities.Won</td>
                                    <td>@salesOpportunities.Lost</td>
                                    <td>₱@salesOpportunities.TotalPipelineValue.ToString("N2")</td>
                                    <td>@salesOpportunities.WinRate.ToString("F2")%</td>
                                </tr>
                            </tbody>
                        </table>
                    }

                    if (salesOpportunityDetails != null && salesOpportunityDetails.Any())
                    {
                        <h5 class="mt-4">Opportunities Detail</h5>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Opportunity</th>
                                    <th>Company</th>
                                    <th>Stage</th>
                                    <th>Est. Revenue</th>
                                    <th>Probability</th>
                                    <th>Weighted Revenue</th>
                                    <th>Owner</th>
                                    <th>Est. Close Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var opp in salesOpportunityDetails)
                                {
                                    <tr>
                                        <td>@opp.OpportunityName</td>
                                        <td>@opp.CompanyName</td>
                                        <td>@opp.StageName</td>
                                        <td>₱@opp.DealValue.ToString("N2")</td>
                                        <td>@opp.Probability.ToString("N0")%</td>
                                        <td>₱@opp.WeightedValue.ToString("N2")</td>
                                        <td>@opp.OwnerName</td>
                                        <td>@(opp.ExpectedCloseDate?.ToString("MMM dd, yyyy") ?? "-")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }

                    if ((salesOpportunities == null || (salesOpportunityDetails == null || !salesOpportunityDetails.Any())) && !topCustomers.Any())
                    {
                        <p>No sales data available for the selected period.</p>
                    }
                }
                else if (reportModalType == "invoice")
                {
                    if (invoices != null && invoices.Any())
                    {
                        var totalAmount = invoices.Sum(i => i.TotalAmount ?? 0m);
                        var paidAmount = invoices
                            .Where(i => string.Equals(i.PaymentStatus, "Paid", StringComparison.OrdinalIgnoreCase))
                            .Sum(i => i.TotalAmount ?? 0m);
                        var overdueAmount = invoices.Where(i => i.IsOverdue).Sum(i => i.TotalAmount ?? 0m);

                        <h5>Invoice Summary</h5>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Total Invoices</td>
                                    <td>@invoices.Count</td>
                                </tr>
                                <tr>
                                    <td>Total Amount</td>
                                    <td>₱@totalAmount.ToString("N2")</td>
                                </tr>
                                <tr>
                                    <td>Paid Amount</td>
                                    <td>₱@paidAmount.ToString("N2")</td>
                                </tr>
                                <tr>
                                    <td>Overdue Amount</td>
                                    <td>₱@overdueAmount.ToString("N2")</td>
                                </tr>
                            </tbody>
                        </table>

                        <h5 class="mt-4">Detailed Invoice List</h5>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Invoice #</th>
                                    <th>Date</th>
                                    <th>Customer</th>
                                    <th>Status</th>
                                    <th>Due Date</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var inv in invoices.OrderByDescending(i => i.InvoiceDate))
                                {
                                    var status = inv.IsOverdue && !string.Equals(inv.PaymentStatus, "Paid", StringComparison.OrdinalIgnoreCase)
                                        ? "Overdue"
                                        : (inv.PaymentStatus ?? "Pending");

                                    var customerDisplay = string.IsNullOrEmpty(inv.CustomerCompany)
                                        ? inv.CustomerName
                                        : inv.CustomerCompany;

                                    <tr>
                                        <td>@(inv.InvoiceNumber ?? "N/A")</td>
                                        <td>@inv.InvoiceDate.ToString("MMM dd, yyyy")</td>
                                        <td>@(customerDisplay ?? "Unknown")</td>
                                        <td>@status</td>
                                        <td>@inv.DueDate.ToString("MMM dd, yyyy")</td>
                                        <td>₱@(inv.TotalAmount ?? 0m)</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <p>No invoices found for the selected period.</p>
                    }
                }
                else if (reportModalType == "all")
                {
                    <p>This combined report will include financial, campaign, sales, and customer analytics. Use "Download as PDF" to view the full comprehensive report.</p>
                }
                else
                {
                    <p>Unknown report type selected.</p>
                }
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" @onclick="CloseReportModal">
                    <span>Close</span>
                </button>

                <div class="dropdown-filter">
                    <button class="modal-btn modal-btn-primary export-toggle" @onclick="ToggleExportMenu">
                        <i class="bi bi-download"></i>
                        <span>Export</span>
                        <i class="bi bi-chevron-down ms-1"></i>
                    </button>

                    @if (showExportMenu)
                    {
                        <div class="dropdown-menu show dropdown-menu-end export-dropdown-menu">
                            <button type="button" @onclick="DownloadReportPdfFromModal">
                                <i class="bi bi-file-earmark-pdf"></i>
                                <div class="dropdown-text">
                                    <div class="dropdown-title">Download PDF</div>
                                    <div class="dropdown-description">Best for printing and sharing</div>
                                </div>
                            </button>

                            @if (CanExportCsv())
                            {
                                <button type="button" @onclick="DownloadReportCsvFromModal">
                                    <i class="bi bi-file-earmark-spreadsheet"></i>
                                    <div class="dropdown-text">
                                        <div class="dropdown-title">Download CSV</div>
                                        <div class="dropdown-description">Open in Excel or Google Sheets</div>
                                    </div>
                                </button>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    private PdfExportService pdfExportService = new PdfExportService();

    private bool isLoading = true;
    private string errorMessage = string.Empty;

    private string selectedFilter = "thisMonth";
    private DateTime startDate = DateTime.Now.AddDays(-30);
    private DateTime endDate = DateTime.Now;

    private string? activeCardMenu;
    private bool showViewModal;
    private string viewModalType = string.Empty;
    private string viewModalTitle = string.Empty;

    private bool showReportModal;
    private string reportModalType = string.Empty;
    private string reportModalTitle = string.Empty;

    private bool showExportMenu = false;

    private string pdfDownloadStatus = string.Empty;
    private System.Threading.Timer? pdfStatusTimer;

    private List<Invoice> invoices = new();

    private List<ReportService.RevenueData> revenueData = new();
    private ReportService.CampaignPerformanceData? campaignPerformance;
    private List<ReportService.TopCustomerData> topCustomers = new();
    private ReportService.SalesOpportunitiesData? salesOpportunities;
    private List<ReportService.SalesOpportunityDetailData> salesOpportunityDetails = new();
    private List<ReportService.CustomerSegmentData> customerSegments = new();
    private List<ReportService.RevenueSourceData> revenueSources = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadReportData();
    }

    private void SetFilter(string filter)
    {
        selectedFilter = filter;

        if (filter == "thisMonth")
        {
            startDate = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1);
            endDate = DateTime.Now;
        }
        else if (filter == "last3Months")
        {
            startDate = DateTime.Now.AddMonths(-3);
            endDate = DateTime.Now;
        }
        else if (filter == "thisYear")
        {
            startDate = new DateTime(DateTime.Now.Year, 1, 1);
            endDate = DateTime.Now;
        }
    }

    private async Task LoadReportData()
    {
        try
        {
            isLoading = true;
            errorMessage = string.Empty;

            revenueData = await ReportService.GetRevenueByMonthAsync(startDate, endDate);
            campaignPerformance = await ReportService.GetCampaignPerformanceAsync(startDate, endDate);
            topCustomers = await ReportService.GetTopCustomersAsync(startDate, endDate);
            salesOpportunities = await ReportService.GetSalesOpportunitiesAsync(startDate, endDate);
            salesOpportunityDetails = await ReportService.GetSalesOpportunityDetailsAsync(startDate, endDate);
            customerSegments = await ReportService.GetCustomerSegmentsAsync(startDate, endDate);
            revenueSources = await ReportService.GetRevenueBySourceAsync(startDate, endDate);

            invoices = await InvoiceService.GetInvoicesByDateRangeAsync(startDate, endDate);
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load report data: {ex.Message}";
            Console.WriteLine($"[Reports] Error loading report data: {ex}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ToggleCardMenu(string cardKey)
    {
        if (activeCardMenu == cardKey)
        {
            activeCardMenu = null;
        }
        else
        {
            activeCardMenu = cardKey;
        }
    }

    private void OpenViewModal(string type, string title)
    {
        viewModalType = type;
        viewModalTitle = title;
        showViewModal = true;
        activeCardMenu = null;
    }

    private void CloseViewModal()
    {
        showViewModal = false;
        viewModalType = string.Empty;
        viewModalTitle = string.Empty;
    }

    private void OpenReportModal(string reportType, string reportTitle)
    {
        reportModalType = reportType;
        reportModalTitle = reportTitle;
        showReportModal = true;
        activeCardMenu = null;
    }

    private void CloseReportModal()
    {
        showReportModal = false;
        reportModalType = string.Empty;
        reportModalTitle = string.Empty;
    }

    private void ToggleExportMenu()
    {
        showExportMenu = !showExportMenu;
    }

    private async Task DownloadReportPdfFromModal()
    {
        showExportMenu = false;

        if (string.IsNullOrEmpty(reportModalType))
        {
            return;
        }

        await GenerateReport(reportModalType);
    }

    private async Task DownloadReportCsvFromModal()
    {
        showExportMenu = false;

        if (string.IsNullOrEmpty(reportModalType))
        {
            return;
        }

        var sb = new StringBuilder();

        switch (reportModalType)
        {
            case "invoice":
                if (invoices == null || !invoices.Any())
                {
                    return;
                }

                sb.AppendLine("InvoiceNumber,Date,Customer,Status,DueDate,Total");

                foreach (var inv in invoices.OrderByDescending(i => i.InvoiceDate))
                {
                    var status = inv.IsOverdue && !string.Equals(inv.PaymentStatus, "Paid", StringComparison.OrdinalIgnoreCase)
                        ? "Overdue"
                        : (inv.PaymentStatus ?? "Pending");

                    var customerDisplay = string.IsNullOrEmpty(inv.CustomerCompany)
                        ? inv.CustomerName
                        : inv.CustomerCompany;

                    sb.AppendLine(string.Join(",", new[]
                    {
                        EscapeCsv(inv.InvoiceNumber ?? "N/A"),
                        EscapeCsv(inv.InvoiceDate.ToString("yyyy-MM-dd")),
                        EscapeCsv(customerDisplay ?? "Unknown"),
                        EscapeCsv(status),
                        EscapeCsv(inv.DueDate.ToString("yyyy-MM-dd")),
                        EscapeCsv((inv.TotalAmount ?? 0m).ToString("0.00", CultureInfo.InvariantCulture))
                    }));
                }
                break;

            case "financial":
                if (revenueData == null || !revenueData.Any())
                {
                    return;
                }

                sb.AppendLine("Month,Income,Expenses,NetProfit");

                foreach (var r in revenueData.OrderBy(x => x.Year).ThenBy(x => x.Month))
                {
                    var monthName = new DateTime(r.Year, r.Month, 1).ToString("yyyy-MM");
                    var profit = r.Income - r.Expense;

                    sb.AppendLine(string.Join(",", new[]
                    {
                        EscapeCsv(monthName),
                        EscapeCsv(r.Income.ToString("0.00", CultureInfo.InvariantCulture)),
                        EscapeCsv(r.Expense.ToString("0.00", CultureInfo.InvariantCulture)),
                        EscapeCsv(profit.ToString("0.00", CultureInfo.InvariantCulture))
                    }));
                }
                break;

            case "customer":
                if ((topCustomers == null || !topCustomers.Any()) && (customerSegments == null || !customerSegments.Any()))
                {
                    return;
                }

                if (topCustomers != null && topCustomers.Any())
                {
                    sb.AppendLine("Top Customers");
                    sb.AppendLine("Rank,Customer,TotalAmount,Transactions");

                    foreach (var c in topCustomers)
                    {
                        sb.AppendLine(string.Join(",", new[]
                        {
                            EscapeCsv(c.Rank.ToString(CultureInfo.InvariantCulture)),
                            EscapeCsv(c.Name),
                            EscapeCsv(c.Amount.ToString("0.00", CultureInfo.InvariantCulture)),
                            EscapeCsv(c.Transactions.ToString(CultureInfo.InvariantCulture))
                        }));
                    }

                    sb.AppendLine();
                }

                if (customerSegments != null && customerSegments.Any())
                {
                    sb.AppendLine("Customer Segments");
                    sb.AppendLine("Segment,CustomerCount,Percentage");

                    foreach (var s in customerSegments)
                    {
                        sb.AppendLine(string.Join(",", new[]
                        {
                            EscapeCsv(s.Name),
                            EscapeCsv(s.Count.ToString(CultureInfo.InvariantCulture)),
                            EscapeCsv(s.Percentage.ToString("0.00", CultureInfo.InvariantCulture))
                        }));
                    }
                }
                break;

            case "campaign":
                if (campaignPerformance == null)
                {
                    return;
                }

                sb.AppendLine("Metric,Value");
                sb.AppendLine(string.Join(",", new[] { "Email Open Rate", EscapeCsv(campaignPerformance.OpenRate.ToString("0.00", CultureInfo.InvariantCulture)) }));
                sb.AppendLine(string.Join(",", new[] { "Click-Through Rate", EscapeCsv(campaignPerformance.ClickRate.ToString("0.00", CultureInfo.InvariantCulture)) }));
                sb.AppendLine(string.Join(",", new[] { "Conversion Rate", EscapeCsv(campaignPerformance.ConversionRate.ToString("0.00", CultureInfo.InvariantCulture)) }));
                sb.AppendLine(string.Join(",", new[] { "ROI", EscapeCsv(campaignPerformance.ROI.ToString("0.00", CultureInfo.InvariantCulture)) }));
                break;

            case "sales":
                if (salesOpportunities == null && (salesOpportunityDetails == null || !salesOpportunityDetails.Any()))
                {
                    return;
                }

                if (salesOpportunities != null)
                {
                    sb.AppendLine("Sales Summary");
                    sb.AppendLine("TotalOpportunities,Active,Won,Lost,TotalPipelineValue,WinRate");

                    var totalOpps = salesOpportunityDetails?.Count ?? 0;

                    sb.AppendLine(string.Join(",", new[]
                    {
                        EscapeCsv(totalOpps.ToString(CultureInfo.InvariantCulture)),
                        EscapeCsv(salesOpportunities.Active.ToString(CultureInfo.InvariantCulture)),
                        EscapeCsv(salesOpportunities.Won.ToString(CultureInfo.InvariantCulture)),
                        EscapeCsv(salesOpportunities.Lost.ToString(CultureInfo.InvariantCulture)),
                        EscapeCsv(salesOpportunities.TotalPipelineValue.ToString("0.00", CultureInfo.InvariantCulture)),
                        EscapeCsv(salesOpportunities.WinRate.ToString("0.00", CultureInfo.InvariantCulture))
                    }));

                    sb.AppendLine();
                }

                if (salesOpportunityDetails != null && salesOpportunityDetails.Any())
                {
                    sb.AppendLine("Opportunity Details");
                    sb.AppendLine("Opportunity,Company,Stage,EstimatedRevenue,Probability,WeightedRevenue,Owner,EstimatedCloseDate");

                    foreach (var opp in salesOpportunityDetails)
                    {
                        sb.AppendLine(string.Join(",", new[]
                        {
                            EscapeCsv(opp.OpportunityName),
                            EscapeCsv(opp.CompanyName),
                            EscapeCsv(opp.StageName),
                            EscapeCsv(opp.DealValue.ToString("0.00", CultureInfo.InvariantCulture)),
                            EscapeCsv(opp.Probability.ToString(CultureInfo.InvariantCulture)),
                            EscapeCsv(opp.WeightedValue.ToString("0.00", CultureInfo.InvariantCulture)),
                            EscapeCsv(opp.OwnerName),
                            EscapeCsv(opp.ExpectedCloseDate?.ToString("yyyy-MM-dd", CultureInfo.InvariantCulture) ?? string.Empty)
                        }));
                    }
                }
                break;

            case "all":
                var hasAnyData = false;

                // Financial section
                if (revenueData != null && revenueData.Any())
                {
                    hasAnyData = true;
                    sb.AppendLine("Financial Performance");
                    sb.AppendLine("Month,Income,Expenses,NetProfit");

                    foreach (var r in revenueData.OrderBy(x => x.Year).ThenBy(x => x.Month))
                    {
                        var monthName = new DateTime(r.Year, r.Month, 1).ToString("yyyy-MM");
                        var profit = r.Income - r.Expense;

                        sb.AppendLine(string.Join(",", new[]
                        {
                            EscapeCsv(monthName),
                            EscapeCsv(r.Income.ToString("0.00", CultureInfo.InvariantCulture)),
                            EscapeCsv(r.Expense.ToString("0.00", CultureInfo.InvariantCulture)),
                            EscapeCsv(profit.ToString("0.00", CultureInfo.InvariantCulture))
                        }));
                    }

                    sb.AppendLine();
                }

                if (revenueSources != null && revenueSources.Any())
                {
                    hasAnyData = true;
                    sb.AppendLine("Revenue by Source");
                    sb.AppendLine("Source,Amount,Percentage");

                    foreach (var s in revenueSources)
                    {
                        sb.AppendLine(string.Join(",", new[]
                        {
                            EscapeCsv(s.Name ?? "Unknown"),
                            EscapeCsv(s.Amount.ToString("0.00", CultureInfo.InvariantCulture)),
                            EscapeCsv(s.Percentage.ToString("0.00", CultureInfo.InvariantCulture))
                        }));
                    }

                    sb.AppendLine();
                }

                // Campaign performance
                if (campaignPerformance != null)
                {
                    hasAnyData = true;
                    sb.AppendLine("Campaign Performance");
                    sb.AppendLine("Metric,Value");
                    sb.AppendLine(string.Join(",", new[] { "Email Open Rate", EscapeCsv(campaignPerformance.OpenRate.ToString("0.00", CultureInfo.InvariantCulture)) }));
                    sb.AppendLine(string.Join(",", new[] { "Click-Through Rate", EscapeCsv(campaignPerformance.ClickRate.ToString("0.00", CultureInfo.InvariantCulture)) }));
                    sb.AppendLine(string.Join(",", new[] { "Conversion Rate", EscapeCsv(campaignPerformance.ConversionRate.ToString("0.00", CultureInfo.InvariantCulture)) }));
                    sb.AppendLine(string.Join(",", new[] { "ROI", EscapeCsv(campaignPerformance.ROI.ToString("0.00", CultureInfo.InvariantCulture)) }));
                    sb.AppendLine();
                }

                // Sales pipeline
                if (salesOpportunities != null || (salesOpportunityDetails != null && salesOpportunityDetails.Any()))
                {
                    hasAnyData = true;

                    if (salesOpportunities != null)
                    {
                        sb.AppendLine("Sales Summary");
                        sb.AppendLine("TotalOpportunities,Active,Won,Lost,TotalPipelineValue,WinRate");

                        var totalOpps = salesOpportunityDetails?.Count ?? 0;

                        sb.AppendLine(string.Join(",", new[]
                        {
                            EscapeCsv(totalOpps.ToString(CultureInfo.InvariantCulture)),
                            EscapeCsv(salesOpportunities.Active.ToString(CultureInfo.InvariantCulture)),
                            EscapeCsv(salesOpportunities.Won.ToString(CultureInfo.InvariantCulture)),
                            EscapeCsv(salesOpportunities.Lost.ToString(CultureInfo.InvariantCulture)),
                            EscapeCsv(salesOpportunities.TotalPipelineValue.ToString("0.00", CultureInfo.InvariantCulture)),
                            EscapeCsv(salesOpportunities.WinRate.ToString("0.00", CultureInfo.InvariantCulture))
                        }));

                        sb.AppendLine();
                    }

                    if (salesOpportunityDetails != null && salesOpportunityDetails.Any())
                    {
                        sb.AppendLine("Opportunity Details");
                        sb.AppendLine("Opportunity,Company,Stage,EstimatedRevenue,Probability,WeightedRevenue,Owner,EstimatedCloseDate");

                        foreach (var opp in salesOpportunityDetails)
                        {
                            sb.AppendLine(string.Join(",", new[]
                            {
                                EscapeCsv(opp.OpportunityName),
                                EscapeCsv(opp.CompanyName),
                                EscapeCsv(opp.StageName),
                                EscapeCsv(opp.DealValue.ToString("0.00", CultureInfo.InvariantCulture)),
                                EscapeCsv(opp.Probability.ToString(CultureInfo.InvariantCulture)),
                                EscapeCsv(opp.WeightedValue.ToString("0.00", CultureInfo.InvariantCulture)),
                                EscapeCsv(opp.OwnerName),
                                EscapeCsv(opp.ExpectedCloseDate?.ToString("yyyy-MM-dd", CultureInfo.InvariantCulture) ?? string.Empty)
                            }));
                        }

                        sb.AppendLine();
                    }
                }

                // Customer analytics
                if ((topCustomers != null && topCustomers.Any()) || (customerSegments != null && customerSegments.Any()))
                {
                    hasAnyData = true;

                    if (topCustomers != null && topCustomers.Any())
                    {
                        sb.AppendLine("Top Customers");
                        sb.AppendLine("Rank,Customer,TotalAmount,Transactions");

                        foreach (var c in topCustomers)
                        {
                            sb.AppendLine(string.Join(",", new[]
                            {
                                EscapeCsv(c.Rank.ToString(CultureInfo.InvariantCulture)),
                                EscapeCsv(c.Name),
                                EscapeCsv(c.Amount.ToString("0.00", CultureInfo.InvariantCulture)),
                                EscapeCsv(c.Transactions.ToString(CultureInfo.InvariantCulture))
                            }));
                        }

                        sb.AppendLine();
                    }

                    if (customerSegments != null && customerSegments.Any())
                    {
                        sb.AppendLine("Customer Segments");
                        sb.AppendLine("Segment,CustomerCount,Percentage");

                        foreach (var s in customerSegments)
                        {
                            sb.AppendLine(string.Join(",", new[]
                            {
                                EscapeCsv(s.Name),
                                EscapeCsv(s.Count.ToString(CultureInfo.InvariantCulture)),
                                EscapeCsv(s.Percentage.ToString("0.00", CultureInfo.InvariantCulture))
                            }));
                        }

                        sb.AppendLine();
                    }
                }

                // Invoice summary
                if (invoices != null && invoices.Any())
                {
                    hasAnyData = true;

                    sb.AppendLine("Invoice Summary");
                    sb.AppendLine("InvoiceNumber,Date,Customer,Status,DueDate,Total");

                    foreach (var inv in invoices.OrderByDescending(i => i.InvoiceDate))
                    {
                        var status = inv.IsOverdue && !string.Equals(inv.PaymentStatus, "Paid", StringComparison.OrdinalIgnoreCase)
                            ? "Overdue"
                            : (inv.PaymentStatus ?? "Pending");

                        var customerDisplay = string.IsNullOrEmpty(inv.CustomerCompany)
                            ? inv.CustomerName
                            : inv.CustomerCompany;

                        sb.AppendLine(string.Join(",", new[]
                        {
                            EscapeCsv(inv.InvoiceNumber ?? "N/A"),
                            EscapeCsv(inv.InvoiceDate.ToString("yyyy-MM-dd")),
                            EscapeCsv(customerDisplay ?? "Unknown"),
                            EscapeCsv(status),
                            EscapeCsv(inv.DueDate.ToString("yyyy-MM-dd")),
                            EscapeCsv((inv.TotalAmount ?? 0m).ToString("0.00", CultureInfo.InvariantCulture))
                        }));
                    }
                }

                if (!hasAnyData)
                {
                    return;
                }

                break;

            default:
                return;
        }

        var fileName = $"MarFin_{reportModalType}_Report_{DateTime.Now:yyyyMMdd_HHmmss}.csv";
        await JS.InvokeVoidAsync("downloadCsv", fileName, sb.ToString());
    }

    private static string EscapeCsv(string? value)
    {
        if (string.IsNullOrEmpty(value))
            return string.Empty;

        if (value.Contains('"') || value.Contains(',') || value.Contains('\n') || value.Contains('\r'))
        {
            value = value.Replace("\"", "\"\"");
            return $"\"{value}\"";
        }

        return value;
    }

    private bool CanExportCsv()
    {
        if (string.IsNullOrEmpty(reportModalType))
        {
            return false;
        }

        switch (reportModalType)
        {
            case "invoice":
            case "financial":
            case "customer":
            case "campaign":
            case "sales":
            case "all":
                return true;
            default:
                return false;
        }
    }

    private async Task GenerateReport(string reportType)
    {
        try
        {
            pdfDownloadStatus = "Preparing PDF...";
            await InvokeAsync(StateHasChanged);
            await Task.Delay(100); // Give UI time to update

            byte[] pdfBytes = Array.Empty<byte>();

            try
            {
                pdfBytes = ReportPdfService.GenerateReportPdf(
                    reportType,
                    startDate,
                    endDate,
                    campaignPerformance,
                    revenueData,
                    topCustomers,
                    salesOpportunities,
                    customerSegments,
                    revenueSources,
                    invoices
                );
            }
            catch (Exception genEx)
            {
                Console.WriteLine($"[Reports] QuestPDF report generation failed: {genEx}");

                try
                {
                    var html = pdfExportService.GenerateReportHtml(
                        reportType,
                        startDate,
                        endDate,
                        campaignPerformance,
                        revenueData,
                        topCustomers,
                        salesOpportunities,
                        customerSegments,
                        revenueSources,
                        invoices
                    );

                    var htmlFileName = $"MarFin_{reportType}_Report_{DateTime.Now:yyyyMMdd_HHmmss}.html";

                    pdfDownloadStatus = "Opening HTML report...";
                    await InvokeAsync(StateHasChanged);

                    var htmlBytes = System.Text.Encoding.UTF8.GetBytes(html);
                    await SaveAndOpenPdfAsync(htmlFileName, htmlBytes);

                    pdfDownloadStatus = "Report opened in browser. Use Print > Save as PDF.";
                    await InvokeAsync(StateHasChanged);
                }
                catch (Exception htmlEx)
                {
                    errorMessage = $"Report generation failed: {htmlEx.Message}";
                    pdfDownloadStatus = $"Error: {htmlEx.Message}";
                    Console.WriteLine($"[Reports] HTML report generation failed: {htmlEx}");
                }

                return;
            }

            if (pdfBytes == null || pdfBytes.Length == 0)
            {
                errorMessage = "Report generation returned no data.";
                pdfDownloadStatus = "Error: No data generated";
                return;
            }

            var fileName = $"MarFin_{reportType}_Report_{DateTime.Now:yyyyMMdd_HHmmss}.pdf";

            pdfDownloadStatus = "Saving PDF...";
            await InvokeAsync(StateHasChanged);
            await Task.Delay(100);

            try
            {
                await SaveAndOpenPdfAsync(fileName, pdfBytes);

                pdfDownloadStatus = "PDF Downloaded!";
                await InvokeAsync(StateHasChanged);

                // Auto-close after 3 seconds
                pdfStatusTimer?.Dispose();
                pdfStatusTimer = new System.Threading.Timer(_ =>
                {
                    InvokeAsync(() =>
                    {
                        ClosePdfStatus();
                    });
                }, null, TimeSpan.FromSeconds(3), Timeout.InfiniteTimeSpan);
            }
            catch (Exception ex)
            {
                errorMessage = $"Failed to save or open PDF: {ex.Message}";
                pdfDownloadStatus = $"Error: Failed to open PDF - {ex.Message}";
                Console.WriteLine($"[Reports] Error saving/opening PDF: {ex}");
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Unexpected error: {ex.Message}";
            pdfDownloadStatus = $"Error: {ex.Message}";
            Console.WriteLine(ex);
        }
    }

    private async Task SaveAndOpenPdfAsync(string fileName, byte[] pdfBytes)
    {
        try
        {
            Console.WriteLine($"[Reports] Starting PDF save: {fileName}, {pdfBytes.Length} bytes");

            var directory = FileSystem.AppDataDirectory;
            var fullPath = Path.Combine(directory, fileName);

            var folder = Path.GetDirectoryName(fullPath);
            if (!string.IsNullOrEmpty(folder) && !Directory.Exists(folder))
            {
                Directory.CreateDirectory(folder);
            }

            await File.WriteAllBytesAsync(fullPath, pdfBytes);
            Console.WriteLine($"[Reports] PDF saved to: {fullPath}");

            await Launcher.OpenAsync(new OpenFileRequest
            {
                File = new ReadOnlyFile(fullPath)
            });

            Console.WriteLine("[Reports] OpenFileRequest sent to OS.");
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to save or open PDF: {ex.Message}";
            pdfDownloadStatus = $"Error: Failed to open PDF - {ex.Message}";
            Console.WriteLine($"[Reports] Error saving/opening PDF: {ex}");
            throw;
        }
    }

    private async Task SetFilterAndReload(string filter)
    {
        SetFilter(filter);
        await LoadReportData();
    }

    public void Dispose()
    {
        pdfStatusTimer?.Dispose();
    }

    private void ClosePdfStatus()
    {
        pdfDownloadStatus = string.Empty;
        pdfStatusTimer?.Dispose();
        pdfStatusTimer = null;
        StateHasChanged();
    }
}
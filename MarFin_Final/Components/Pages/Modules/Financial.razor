@page "/financial"
@inject NavigationManager Navigation
@inject AuthService AuthService
@inject InvoiceService InvoiceService
@inject CustomerService CustomerService
@inject IJSRuntime JS
@using MarFin_Final.Models

@using MarFin_Final.Database.Services

<div class="financial-container">
    <div class="financial-header">
        <div class="header-title">
            <h1>Financial Transactions</h1>
            <span class="transaction-count">@filteredInvoices.Count transactions</span>
        </div>
    </div>
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">
            @errorMessage
            <button class="alert-close" @onclick="() => errorMessage = string.Empty">×</button>
        </div>
    }
    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success">
            @successMessage
            <button class="alert-close" @onclick="() => successMessage = string.Empty">×</button>
        </div>
    }
    <!-- Financial Summary -->
    <div class="financial-summary">
        <h6>
            Financial Summary
            @if (!showSummaryCards)
            {
                <span class="text-primary ms-2" style="cursor: pointer;" @onclick="ToggleSummaryCards">view</span>
            }
            else
            {
                <span class="text-primary ms-2" style="cursor: pointer;" @onclick="ToggleSummaryCards">hide</span>
            }
        </h6>
        @if (showSummaryCards)
        {
            <div class="summary-cards">
                <div class="summary-card revenue">
                    <div class="card-icon"><i class="bi bi-cash-stack"></i></div>
                    <div class="card-content">
                        <h2>Php @((totalRevenue ?? 0m).ToString("N2"))</h2>
                        <p>Total Revenue</p>
                        <span class="card-badge positive"><i class="bi bi-graph-up"></i> +12.5%</span>
                    </div>
                </div>
                <div class="summary-card pending">
                    <div class="card-icon"><i class="bi bi-hourglass-split"></i></div>
                    <div class="card-content">
                        <h2>Php @((totalPending ?? 0m).ToString("N2"))</h2>
                        <p>Pending</p>
                        <span class="card-badge info"><i class="bi bi-file-earmark-text"></i> @pendingCount inv.</span>
                    </div>
                </div>
                <div class="summary-card overdue">
                    <div class="card-icon"><i class="bi bi-exclamation-triangle"></i></div>
                    <div class="card-content">
                        <h2>Php @((totalOverdue ?? 0m).ToString("N2"))</h2>
                        <p>Overdue</p>
                        <span class="card-badge warning"><i class="bi bi-clock-history"></i> @overdueCount inv.</span>
                    </div>
                </div>
            </div>
        }
    </div>
    <!-- Toolbar -->
    <div class="financial-toolbar">
        <button class="btn-primary" @onclick="ToggleInvoiceModal">
            <i class="bi bi-plus-lg"></i> New Invoice
        </button>
        <div class="toolbar-filters">
            <!-- Inside .toolbar-filters, after Export button -->
            @if (AuthService.IsAdmin())
            {
                <button class="btn-filter" @onclick='() => Navigation.NavigateTo("/archived-invoices")'>
                    <i class="bi bi-archive"></i> View Archived
                </button>
            }
            <div class="dropdown-filter">
                <button class="btn-filter" @onclick="ToggleDateFilter">
                    @selectedDateFilter <i class="bi bi-chevron-down"></i>
                </button>
                @if (showDateFilter)
                {
                    <div class="dropdown-menu show">
                        <button type="button" @onclick='() => ApplyDateFilter("This Month")'>This Month</button>
                        <button type="button" @onclick='() => ApplyDateFilter("Last Month")'>Last Month</button>
                        <button type="button" @onclick='() => ApplyDateFilter("This Year")'>This Year</button>
                        <button type="button" @onclick='() => ApplyDateFilter("All Time")'>All Time</button>
                    </div>
                }
            </div>
            <div class="dropdown-filter">
                <button class="btn-filter" @onclick="ToggleStatusFilter">
                    <i class="bi bi-funnel"></i> Filter by
                    @if (!string.IsNullOrEmpty(statusFilter))
                    {
                        <span class="filter-badge">@statusFilter</span>
                    }
                </button>
                @if (showStatusFilter)
                {
                    <div class="dropdown-menu show">
                        <button type="button" @onclick='() => ApplyStatusFilter("")'>All Statuses</button>
                        <button type="button" @onclick='() => ApplyStatusFilter("Draft")'>Draft</button>
                        <button type="button" @onclick='() => ApplyStatusFilter("Issued")'>Issued</button>
                        <button type="button" @onclick='() => ApplyStatusFilter("Paid")'>Paid</button>
                        <button type="button" @onclick='() => ApplyStatusFilter("Partial")'>Partial</button>
                        <button type="button" @onclick='() => ApplyStatusFilter("Overdue")'>Overdue</button>
                    </div>
                }
            </div>
            <div class="search-box">
                <i class="bi bi-search search-icon"></i>
                <input type="text"
                       placeholder="Search here..."
                       @bind="searchTerm"
                       @bind:event="oninput" />
            </div>
            <button class="btn-filter" disabled><i class="bi bi-download"></i> Export</button>
        </div>
    </div>
    <!-- Transactions Table -->
    @if (isLoading)
    {
        <div class="loading-state">
            <div class="spinner"></div>
            <p>Loading invoices...</p>
        </div>
    }
    else if (!filteredInvoices.Any())
    {
        <div class="empty-state text-center">
            <i class="bi bi-inbox fs-2 text-muted"></i>
            <p>No transactions found</p>
        </div>
    }
    else
    {
        <div class="transactions-table">
            <div class="table-header">
                <span>Invoice ID</span>
                <span>Customer</span>
                <span>Amount</span>
                <span>Date</span>
                <span>Status</span>
            </div>
            @foreach (var invoice in GetPaginatedInvoices())
            {
                <div class="table-row" @onclick="() => ViewInvoice(invoice)">
                    <span>@invoice.InvoiceNumber</span>
                    <span class="clickable text-primary"
                          @onclick="() => NavigateToCustomer(invoice.CustomerId)"
                          @onclick:stopPropagation>
                        @(string.IsNullOrEmpty(invoice.CustomerName) ? invoice.CustomerName : invoice.CustomerName)
                    </span>
                    <span>Php @((invoice.TotalAmount ?? 0m).ToString("N2"))</span>
                    <span>@invoice.InvoiceDate.ToString("MM/dd/yyyy")</span>
                    <span>
                        <span class="status-badge @invoice.StatusBadgeClass">
                            @(invoice.IsOverdue ? "Overdue" : invoice.PaymentStatus)
                        </span>
                    </span>
                </div>
            }
        </div>
        <!-- Pagination Controls -->
        <div class="pagination-section">
            <div class="pagination-info">
                <span>Showing <strong>@((currentPage - 1) * pageSize + 1)</strong> to <strong>@Math.Min(currentPage * pageSize, totalRecords)</strong> of <strong>@totalRecords</strong> invoices</span>
            </div>
            <div class="pagination-controls">
                <div class="page-size-selector">
                    <label>Rows per page:</label>
                    <select @bind="pageSize" @bind:after="ReloadWithNewPageSize">
                        <option value="5">5</option>
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                    </select>
                </div>
                <div class="pagination-buttons">
                    <button class="pagination-btn" @onclick="() => ChangePage(1)" disabled="@(currentPage == 1)">
                        <i class="bi bi-chevron-double-left"></i>
                    </button>
                    <button class="pagination-btn" @onclick="() => ChangePage(currentPage - 1)" disabled="@(currentPage == 1)">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(TotalPages, currentPage + 2); i++)
                    {
                        int pageNum = i;
                        <button class="@(currentPage == pageNum ? "pagination-btn active" : "pagination-btn")" @onclick="() => ChangePage(pageNum)">
                            @pageNum
                        </button>
                    }
                    <button class="pagination-btn" @onclick="() => ChangePage(currentPage + 1)" disabled="@(currentPage == TotalPages)">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                    <button class="pagination-btn" @onclick="() => ChangePage(TotalPages)" disabled="@(currentPage == TotalPages)">
                        <i class="bi bi-chevron-double-right"></i>
                    </button>
                </div>
            </div>
        </div>
    }
</div>

<!-- New/Edit Invoice Modal -->
@if (showInvoiceModal)
{
    <div class="modal-overlay" @onclick="ToggleInvoiceModal">
        <div class="modal-content invoice-modal" @onclick:stopPropagation>
            <div class="invoice-modal-header">
                <button class="btn-back" @onclick="ToggleInvoiceModal">
                    <i class="bi bi-arrow-left"></i> Back
                </button>
                <div class="modal-actions">
                    <button class="btn-cancel" @onclick="ToggleInvoiceModal">Cancel</button>
                    <button class="btn-secondary" @onclick="() => ShowSaveDraftConfirmation()" disabled="@isSaving">
                        @(isSaving ? "Saving..." : "Save Draft")
                    </button>
                    <button class="btn-primary" @onclick="() => ShowGenerateInvoiceConfirmation()" disabled="@isSaving">
                        @(isSaving ? "Generating..." : "Generate Invoice") <i class="bi bi-arrow-right"></i>
                    </button>
                </div>
            </div>
            <div class="invoice-modal-body">
                <div class="invoice-form-section">
                    <h3>Invoice Information</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Select Customer <span class="text-danger">*</span></label>
                            <div class="position-relative">
                                <input type="text"
                                       class="form-control"
                                       placeholder="Search customer..."
                                       @bind="customerSearchTerm"
                                       @oninput="HandleCustomerInput"
                                       autocomplete="off" />
                                @if (showCustomerDropdown && searchResults.Any())
                                {
                                    <div class="dropdown-menu show w-100" style="max-height: 300px; overflow-y: auto;">
                                        @foreach (var customer in searchResults)
                                        {
                                            var capturedCustomer = customer;
                                            <button type="button"
                                                    class="dropdown-item"
                                                    @onclick="() => SelectCustomer(capturedCustomer)">
                                                <strong>@(string.IsNullOrEmpty(customer.CompanyName) ? customer.FullName : customer.CompanyName)</strong>
                                                <br /><small class="text-muted">@customer.Email</small>
                                            </button>
                                        }
                                    </div>
                                }
                                @if (selectedCustomer != null && !showCustomerDropdown)
                                {
                                    <div class="selected-customer mt-2 p-2 border rounded bg-light">
                                        <i class="bi bi-check-circle-fill text-success"></i>
                                        <strong>@(string.IsNullOrEmpty(selectedCustomer.CompanyName) ? selectedCustomer.FullName : selectedCustomer.CompanyName)</strong>
                                        <small class="text-muted d-block">@selectedCustomer.Email</small>
                                        <button type="button" class="btn-close btn-sm float-end" @onclick="ClearCustomerSelection"></button>
                                    </div>
                                }
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Invoice Number</label>
                            <input type="text" class="form-control" @bind="newInvoice.InvoiceNumber" readonly />
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Invoice Date <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" @bind="newInvoice.InvoiceDate" />
                        </div>
                        <div class="form-group">
                            <label>Due Date <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" @bind="newInvoice.DueDate" />
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Payment Terms</label>
                            <select class="form-control" @bind="newInvoice.PaymentTerms">
                                <option value="Net 15">Net 15</option>
                                <option value="Net 30">Net 30</option>
                                <option value="Net 60">Net 60</option>
                                <option value="Due on Receipt">Due on Receipt</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Tax Rate (%)</label>
                            <input type="number" class="form-control"
                                   @bind="newInvoice.TaxRate"
                                   @bind:event="oninput"
                                   @onchange="CalculateTotals"
                                   step="0.01" />
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Discount Amount</label>
                            <input type="number" class="form-control"
                                   @bind="newInvoice.DiscountAmount"
                                   @bind:event="oninput"
                                   @onchange="CalculateTotals"
                                   step="0.01" placeholder="0.00" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notes / Payment Instructions</label>
                        <textarea class="form-control" rows="3" @bind="newInvoice.Notes"></textarea>
                    </div>
                </div>
                <div class="invoice-items-section">
                    <div class="section-header">
                        <h3>Line Items</h3>
                        <button class="btn-add-item" @onclick="AddLineItem">
                            <i class="bi bi-plus-lg"></i> Add Item
                        </button>
                    </div>
                    <div class="line-items-table">
                        <div class="items-table-header">
                            <span>Description</span>
                            <span>Qty</span>
                            <span>Unit Price</span>
                            <span>Amount</span>
                            <span></span>
                        </div>
                        @foreach (var item in newInvoice.LineItems)
                        {
                            <div class="items-table-row">
                                <input type="text" class="form-control" @bind="item.Description" placeholder="Description" />
                                <input type="number" class="form-control"
                                       @bind="item.Quantity"
                                       @bind:event="oninput"
                                       @onchange="CalculateTotals"
                                       step="0.01" min="0.01" />
                                <input type="number" class="form-control"
                                       @bind="item.UnitPrice"
                                       @bind:event="oninput"
                                       @onchange="CalculateTotals"
                                       step="0.01" min="0" />
                                <span class="item-amount">Php @(((item.Quantity ?? 0m) * (item.UnitPrice ?? 0m)).ToString("N2"))</span>
                                <button class="btn-remove" @onclick="() => RemoveLineItem(item)"
                                        disabled="@(newInvoice.LineItems.Count <= 1)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        }
                    </div>
                    <div class="invoice-summary">
                        <div class="summary-row"><span>Subtotal</span> <span>Php @((newInvoice.Subtotal ?? 0m).ToString("N2"))</span></div>
                        <div class="summary-row"><span>Tax (@(newInvoice.TaxRate ?? 0m)%)</span> <span>Php @((newInvoice.TaxAmount ?? 0m).ToString("N2"))</span></div>
                        <div class="summary-row"><span>Discount</span> <span>-Php @((newInvoice.DiscountAmount ?? 0m).ToString("N2"))</span></div>
                        <div class="summary-row total"><span>Total</span> <span>Php @((newInvoice.TotalAmount ?? 0m).ToString("N2"))</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<!-- View Invoice Modal -->
@if (showViewModal && selectedInvoice != null)
{
    <div class="modal-overlay" @onclick="CloseViewModal">
        <div class="modal-content view-invoice-modal" @onclick:stopPropagation>
            <div class="view-invoice-header">
                <button class="btn-back" @onclick="CloseViewModal">
                    <i class="bi bi-arrow-left"></i> Back
                </button>
                <div class="invoice-title-section">
                    <span>Invoice @selectedInvoice.InvoiceNumber</span>
                </div>
                <div class="invoice-actions">
                    <button class="btn-icon" title="Email"><i class="bi bi-envelope"></i></button>
                    <button class="btn-icon" title="Download PDF" @onclick="() => DownloadPdf(selectedInvoice!)">
                        <i class="bi bi-download"></i>
                    </button>
                    <button class="btn-icon" title="Print"><i class="bi bi-printer"></i></button>
                    <button class="btn-icon" title="Edit" @onclick="() => EditInvoice(selectedInvoice)">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn-icon btn-icon-archive btn-icon-warning" title="Archive" @onclick="() => ShowArchiveConfirmation(selectedInvoice.InvoiceId)">
                        <i class="bi bi-archive"></i>
                    </button>
                </div>
            </div>
            <!-- Add this below the invoice-actions -->
            @if (!string.IsNullOrEmpty(pdfDownloadStatus))
            {
                <div class="text-center mt-3">
                    <small class="@(pdfDownloadStatus.Contains("Downloaded") ? "text-success" : "text-info")">
                        <i class="bi @(pdfDownloadStatus.Contains("Downloaded") ? "bi-check-circle" : "bi-hourglass-split")"></i>
                        @pdfDownloadStatus
                    </small>
                </div>
            }
            <div class="view-invoice-body">
                <div class="invoice-preview">
                    <div class="invoice-preview-header">
                        <div class="company-info">
                            <div class="company-logo"><i class="bi bi-buildings"></i> <span>MarFin</span></div>
                            <p>123 Business Street<br />Makati, Manila Philippines<br />1200</p>
                            <p>contact@marfin.com<br />+63 912 345 6789</p>
                        </div>
                        <div class="invoice-badge">
                            <div class="badge-label">INVOICE</div>
                            <div class="badge-number">@selectedInvoice.InvoiceNumber</div>
                        </div>
                    </div>
                    <div class="invoice-preview-details">
                        <div class="bill-to">
                            <h4>Bill to:</h4>
                            <p>
                                <strong>@(string.IsNullOrEmpty(selectedInvoice.CustomerCompany) ? selectedInvoice.CustomerName : selectedInvoice.CustomerCompany)</strong><br />
                                @selectedInvoice.CustomerName<br />
                                @selectedInvoice.CustomerEmail
                            </p>
                        </div>
                        <div class="invoice-details">
                            <h4>Invoice Details:</h4>
                            <div class="detail-row"><span>Invoice Date:</span> <span>@selectedInvoice.InvoiceDate.ToString("MM/dd/yyyy")</span></div>
                            <div class="detail-row"><span>Due Date:</span> <span>@selectedInvoice.DueDate.ToString("MM/dd/yyyy")</span></div>
                            <div class="detail-row"><span>Payment Terms:</span> <span>@selectedInvoice.PaymentTerms</span></div>
                            <div class="detail-row">
                                <span>Status:</span>
                                <span class="status-badge @selectedInvoice.StatusBadgeClass">
                                    @(selectedInvoice.IsOverdue ? "Overdue" : selectedInvoice.PaymentStatus)
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="invoice-items-preview">
                        <table class="preview-table">
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th>Qty</th>
                                    <th>Unit Price</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in selectedInvoice.LineItems)
                                {
                                    <tr>
                                        <td>@item.Description</td>
                                        <td>@item.Quantity</td>
                                        <td>Php @((item.UnitPrice ?? 0m).ToString("N2"))</td>
                                        <td>Php @((item.Amount ?? 0m).ToString("N2"))</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                    <div class="invoice-totals">
                        <div class="totals-row"><span>Subtotal</span> <span>Php @((selectedInvoice.Subtotal ?? 0m).ToString("N2"))</span></div>
                        <div class="totals-row"><span>Tax (@(selectedInvoice.TaxRate ?? 0m)%)</span> <span>Php @((selectedInvoice.TaxAmount ?? 0m).ToString("N2"))</span></div>
                        <div class="totals-row total"><span>Total</span> <span>Php @((selectedInvoice.TotalAmount ?? 0m).ToString("N2"))</span></div>
                    </div>
                    <div class="payment-info">
                        <h4>PAYMENT INFORMATION:</h4>
                        <p>
                            Bank Name: BPI (Bank of the Philippine Islands)<br />
                            Account Number: 1234-5678-9012-3456<br />
                            Account Name: MarFin Business Account
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<!-- PDF Download Progress Modal -->
@if (!string.IsNullOrEmpty(pdfDownloadStatus))
{
    <div class="modal-overlay" @onclick="() => pdfDownloadStatus = string.Empty">
        <div class="modal-content confirm-modal text-center p-5" @onclick:stopPropagation>
            <div class="mb-4">
                @if (pdfDownloadStatus.Contains("Downloaded"))
                {
                    <i class="bi bi-check-circle-fill text-success" style="font-size: 64px;"></i>
                }
                else
                {
                    <div class="spinner" style="width: 60px; height: 60px; border-width: 5px; margin: 0 auto;"></div>
                }
            </div>
            <h3 class="@(pdfDownloadStatus.Contains("Downloaded") ? "text-success" : "text-info")">
                @pdfDownloadStatus
            </h3>
            @if (pdfDownloadStatus.Contains("Downloaded"))
            {
                <div class="text-center">
                    <p class="text-muted mt-3">Your invoice has been downloaded successfully.</p>

                    <button class="btn btn-primary mt-3"
                            @onclick="() => pdfDownloadStatus = string.Empty">
                        Close
                    </button>
                </div>
            }
        </div>
    </div>
}
<!-- Confirmation Modal -->
@if (showConfirmModal)
{
    <div class="modal-overlay p-3" @onclick="CloseConfirmModal">
        <div class="modal-content confirm-modal p-3" @onclick:stopPropagation>
            <div class="modal-header">
                <div class="modal-title">
                    <span class="user-icon info"><i class="bi bi-question-circle"></i></span>
                    <h2>@confirmTitle</h2>
                </div>
            </div>
            <div class="modal-body">
                <p>@confirmMessage</p>
                <div class="modal-footer gap-3">
                    <button class="btn-cancel" @onclick="CloseConfirmModal">Cancel</button>
                    <button class="btn-primary" @onclick="ConfirmInvoiceSave" disabled="@isSaving">
                        @if (isSaving)
                        {
                            <span class="spinner-small"></span>
                        }
                        Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>
}
@code {
    private List<Invoice> allInvoices = [];
    private List<Invoice> filteredInvoices = [];
    private List<Customer> searchResults = [];
    private Customer? selectedCustomer;
    private string searchTerm = "";
    private string customerSearchTerm = "";
    private string statusFilter = "";
    private string selectedDateFilter = "This Month";
    private bool showInvoiceModal = false;
    private bool showViewModal = false;
    private bool showStatusFilter = false;
    private bool showDateFilter = false;
    private bool showCustomerDropdown = false;
    private bool showConfirmModal = false;
    private bool showSummaryCards = false;

    private bool isLoading = true;
    private bool isSaving = false;
    private Invoice? selectedInvoice;
    private Invoice newInvoice = new();
    private string errorMessage = "";
    private string successMessage = "";
    private string confirmTitle = "";
    private string confirmMessage = "";
    private string pendingInvoiceAction = "";
    private int currentUserId = 1;

    private decimal? totalRevenue = 0;
    private decimal? totalPending = 0;
    private decimal? totalOverdue = 0;
    private int pendingCount = 0;
    private int overdueCount = 0;

    private string pdfDownloadStatus = "";
    private Timer? pdfStatusTimer;
    private int invoiceToArchive = 0;

    private int currentPage = 1;
    private int pageSize = 10;
    private int totalRecords = 0;
    private int TotalPages => (int)Math.Ceiling((double)totalRecords / pageSize);

    protected override async Task OnInitializedAsync()
    {
        if (AuthService?.CurrentUser == null)
        {
            Navigation.NavigateTo("/login", true);
            return;
        }

        await LoadInvoices();
        await ApplyQueryContext();
    }

    private async Task LoadInvoices()
    {
        try
        {
            isLoading = true;
            allInvoices = await InvoiceService.GetAllInvoicesAsync() ?? [];
            filteredInvoices = [.. allInvoices];
            ApplyFilters();
            CalculateSummary();
            totalRecords = filteredInvoices.Count;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading invoices: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ShowArchiveConfirmation(int invoiceId)
    {
        confirmTitle = "Archive Invoice";
        confirmMessage = "Are you sure you want to archive this invoice? It will be moved to archived items.";
        invoiceToArchive = invoiceId;
        pendingInvoiceAction = "archive";
        showConfirmModal = true;
    }

    private async Task ConfirmInvoiceSave()
    {
        if (pendingInvoiceAction == "archive")
        {
            await DeleteInvoice(invoiceToArchive);
            invoiceToArchive = 0;
        }
        else
        {
            string status = pendingInvoiceAction == "draft" ? "Draft" : "Issued";
            await SaveInvoice(status);
        }
        CloseConfirmModal();
    }

    private void CalculateSummary()
    {
        totalRevenue = allInvoices.Where(i => i.PaymentStatus == "Paid").Sum(i => i.TotalAmount ?? 0m);
        totalPending = allInvoices.Where(i => i.PaymentStatus is "Issued" or "Partial").Sum(i => i.TotalAmount ?? 0m);
        totalOverdue = allInvoices.Where(i => i.IsOverdue).Sum(i => i.TotalAmount ?? 0m);
        pendingCount = allInvoices.Count(i => i.PaymentStatus is "Issued" or "Partial");
        overdueCount = allInvoices.Count(i => i.IsOverdue);
    }

    private void ToggleSummaryCards()
    {
        showSummaryCards = !showSummaryCards;
    }

    private async Task ToggleInvoiceModal()
    {
        showInvoiceModal = !showInvoiceModal;
        if (showInvoiceModal)
        {
            // Reset form
            selectedCustomer = null;
            customerSearchTerm = "";
            searchResults.Clear();
            showCustomerDropdown = false;

            // Create new invoice with default values
            newInvoice = new Invoice
            {
                CreatedBy = currentUserId,
                InvoiceDate = DateTime.Today,
                DueDate = DateTime.Today.AddDays(30),
                PaymentTerms = "Net 30",
                TaxRate = 12.00m,
                PaymentStatus = "Draft",
                LineItems = [new InvoiceItem
            {
                Description = "",
                Quantity = 1m,
                UnitPrice = 0m,
                ItemOrder = 1
            }]
            };

            // Generate and show the invoice number immediately
            try
            {
                newInvoice.InvoiceNumber = await InvoiceService.GenerateInvoiceNumberAsync();
            }
            catch
            {
                newInvoice.InvoiceNumber = "INV-XXXX-XXX"; // fallback
            }

            StateHasChanged(); // Ensures the UI updates with the number
        }
        else
        {
            ResetInvoiceForm();
        }
    }

    private void ResetInvoiceForm()
    {
        newInvoice = new();
        selectedCustomer = null;
        customerSearchTerm = "";
        searchResults.Clear();
        showCustomerDropdown = false;
    }

    private Timer? _debounceTimer;

    private async Task HandleCustomerInput(ChangeEventArgs e)
    {
        customerSearchTerm = e.Value?.ToString() ?? "";
        _debounceTimer?.Dispose();

        if (string.IsNullOrWhiteSpace(customerSearchTerm) || customerSearchTerm.Length < 2)
        {
            showCustomerDropdown = false;
            searchResults.Clear();
            return;
        }

        _debounceTimer = new Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                try
                {
                    searchResults = await CustomerService.SearchCustomersAsync(customerSearchTerm, maxResults: 20);
                    showCustomerDropdown = searchResults.Any();
                    StateHasChanged();
                }
                catch (Exception ex)
                {
                    errorMessage = $"Error searching customers: {ex.Message}";
                    showCustomerDropdown = false;
                }
            });
        }, null, 300, Timeout.Infinite);
    }

    private void SelectCustomer(Customer customer)
    {
        selectedCustomer = customer;
        newInvoice.CustomerId = customer.CustomerId;
        customerSearchTerm = string.IsNullOrEmpty(customer.CompanyName)
            ? customer.FullName
            : customer.CompanyName;
        showCustomerDropdown = false;
        searchResults.Clear();
        StateHasChanged();
    }

    private void ClearCustomerSelection()
    {
        selectedCustomer = null;
        newInvoice.CustomerId = 0;
        customerSearchTerm = "";
        showCustomerDropdown = false;
    }

    private void AddLineItem()
    {
        var nextOrder = newInvoice.LineItems.Any() ? newInvoice.LineItems.Max(i => i.ItemOrder) + 1 : 1;
        newInvoice.LineItems.Add(new InvoiceItem { Description = "", Quantity = 1m, UnitPrice = 0m, ItemOrder = nextOrder });
    }

    private void RemoveLineItem(InvoiceItem item)
    {
        if (newInvoice.LineItems.Count > 1)
        {
            newInvoice.LineItems.Remove(item);
            CalculateTotals();
        }
    }

    private void CalculateTotals()
    {
        var subtotal = newInvoice.LineItems.Sum(i => (i.Quantity ?? 0m) * (i.UnitPrice ?? 0m));
        newInvoice.Subtotal = subtotal;
        newInvoice.TaxAmount = subtotal * ((newInvoice.TaxRate ?? 0m) / 100m);
        newInvoice.TotalAmount = subtotal + (newInvoice.TaxAmount ?? 0m) - (newInvoice.DiscountAmount ?? 0m);

        foreach (var item in newInvoice.LineItems)
        {
            item.Amount = (item.Quantity ?? 0m) * (item.UnitPrice ?? 0m);
        }
        StateHasChanged();
    }

    private void ShowSaveDraftConfirmation()
    {
        confirmTitle = "Save Invoice as Draft";
        confirmMessage = "Are you sure you want to save this invoice as a draft? You can edit it later before generating.";
        pendingInvoiceAction = "draft";
        showConfirmModal = true;
    }

    private void ShowGenerateInvoiceConfirmation()
    {
        confirmTitle = "Generate Invoice";
        confirmMessage = "Are you sure you want to generate this invoice? This will mark it as issued and send it to the customer.";
        pendingInvoiceAction = "issue";
        showConfirmModal = true;
    }

    private void CloseConfirmModal()
    {
        showConfirmModal = false;
        confirmTitle = "";
        confirmMessage = "";
        pendingInvoiceAction = "";
    }

    private async Task SaveInvoice(string status)
    {
        errorMessage = "";
        successMessage = "";

        if (selectedCustomer == null || newInvoice.CustomerId == 0)
        {
            errorMessage = "Please select a customer";
            return;
        }

        if (newInvoice.LineItems == null || !newInvoice.LineItems.Any())
        {
            errorMessage = "Please add at least one line item";
            return;
        }

        if (newInvoice.LineItems.All(i => string.IsNullOrWhiteSpace(i.Description)))
        {
            errorMessage = "Please add at least one valid line item with description";
            return;
        }

        newInvoice.LineItems = newInvoice.LineItems
            .Where(i => !string.IsNullOrWhiteSpace(i.Description))
            .ToList();

        if (!newInvoice.LineItems.Any())
        {
            errorMessage = "Please add at least one valid line item";
            return;
        }

        newInvoice.PaymentStatus = status;
        CalculateTotals();

        try
        {
            isSaving = true;

            bool success = newInvoice.InvoiceId > 0
                ? await InvoiceService.UpdateInvoiceAsync(newInvoice)
                : await InvoiceService.AddInvoiceAsync(newInvoice);

            if (success)
            {
                successMessage = status == "Draft"
                    ? "Invoice saved as draft successfully!"
                    : "Invoice generated and issued successfully!";

                showInvoiceModal = false;
                await LoadInvoices();
            }
            else
            {
                errorMessage = "Failed to save invoice. Please try again.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Database Error: {ex.Message}";
            Console.WriteLine(ex.ToString());
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task ViewInvoice(Invoice invoice)
    {
        selectedInvoice = await InvoiceService.GetInvoiceByIdAsync(invoice.InvoiceId);
        showViewModal = true;
    }

    private async Task EditInvoice(Invoice invoice)
    {
        newInvoice = await InvoiceService.GetInvoiceByIdAsync(invoice.InvoiceId) ?? new();
        selectedCustomer = await CustomerService.GetCustomerByIdAsync(newInvoice.CustomerId);
        customerSearchTerm = string.IsNullOrEmpty(selectedCustomer?.CompanyName)
            ? selectedCustomer?.FullName
            : selectedCustomer?.CompanyName;

        showViewModal = false;
        showInvoiceModal = true;
    }

    private async Task DeleteInvoice(int invoiceId)
    {
        try
        {
            if (await InvoiceService.ArchiveInvoiceAsync(invoiceId))
            {
                successMessage = "Invoice archived successfully!";
                CloseViewModal();
                await LoadInvoices();
            }
            else
            {
                errorMessage = "Failed to archive invoice.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
    }

    private void CloseViewModal()
    {
        showViewModal = false;
        selectedInvoice = null;
    }

    private void ApplyDateFilter(string filter)
    {
        selectedDateFilter = filter;
        showDateFilter = false;
        ApplyFilters();
    }

    private void ApplyStatusFilter(string status)
    {
        statusFilter = status;
        showStatusFilter = false;
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        filteredInvoices = [.. allInvoices];

        if (selectedDateFilter != "All Time")
        {
            var now = DateTime.Now;
            filteredInvoices = selectedDateFilter switch
            {
                "This Month" => filteredInvoices.Where(i => i.InvoiceDate.Month == now.Month && i.InvoiceDate.Year == now.Year).ToList(),
                "Last Month" => filteredInvoices.Where(i => i.InvoiceDate.Month == now.AddMonths(-1).Month && i.InvoiceDate.Year == now.AddMonths(-1).Year).ToList(),
                "This Year" => filteredInvoices.Where(i => i.InvoiceDate.Year == now.Year).ToList(),
                _ => filteredInvoices
            };
        }

        if (!string.IsNullOrEmpty(statusFilter))
        {
            filteredInvoices = statusFilter == "Overdue"
                ? filteredInvoices.Where(i => i.IsOverdue).ToList()
                : filteredInvoices.Where(i => i.PaymentStatus == statusFilter).ToList();
        }

        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            var term = searchTerm.ToLower();
            filteredInvoices = filteredInvoices.Where(i =>
                i.InvoiceNumber.Contains(term, StringComparison.OrdinalIgnoreCase) ||
                i.CustomerName.Contains(term, StringComparison.OrdinalIgnoreCase) ||
                (!string.IsNullOrEmpty(i.CustomerCompany) && i.CustomerCompany.Contains(term, StringComparison.OrdinalIgnoreCase))
            ).ToList();
        }

        currentPage = 1;
        totalRecords = filteredInvoices.Count;
    }

    private void ToggleStatusFilter()
    {
        showStatusFilter = !showStatusFilter;
        showDateFilter = false;
    }

    private void ToggleDateFilter()
    {
        showDateFilter = !showDateFilter;
        showStatusFilter = false;
    }

    private List<Invoice> GetPaginatedInvoices()
    {
        var skip = (currentPage - 1) * pageSize;
        return filteredInvoices.Skip(skip).Take(pageSize).ToList();
    }

    private void ChangePage(int page)
    {
        if (page >= 1 && page <= TotalPages)
        {
            currentPage = page;
            StateHasChanged();
        }
    }

    private async Task ReloadWithNewPageSize()
    {
        currentPage = 1;
        await Task.CompletedTask;
    }

    private void NavigateToCustomer(int customerId)
    {
        Navigation.NavigateTo($"/customer-details/{customerId}");
    }

    private async Task ApplyQueryContext()
    {
        try
        {
            var uri = new Uri(Navigation.Uri);
            var query = uri.Query;
            if (string.IsNullOrWhiteSpace(query))
            {
                return;
            }
            if (query.StartsWith("?"))
            {
                query = query.Substring(1);
            }

            var parameters = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
            foreach (var pair in query.Split('&', StringSplitOptions.RemoveEmptyEntries))
            {
                var parts = pair.Split('=', 2);
                if (parts.Length == 2)
                {
                    var key = Uri.UnescapeDataString(parts[0]);
                    var value = Uri.UnescapeDataString(parts[1]);
                    parameters[key] = value;
                }
            }

            if (parameters.TryGetValue("invoiceId", out var invoiceIdValue) &&
                int.TryParse(invoiceIdValue, out var invoiceId) &&
                invoiceId > 0)
            {
                selectedInvoice = await InvoiceService.GetInvoiceByIdAsync(invoiceId);
                if (selectedInvoice != null)
                {
                    showViewModal = true;
                }
                return;
            }

            if (parameters.TryGetValue("customerId", out var customerIdValue) &&
                int.TryParse(customerIdValue, out var customerId) &&
                customerId > 0)
            {
                var customer = await CustomerService.GetCustomerByIdAsync(customerId);
                if (customer != null)
                {
                    await ToggleInvoiceModal();
                    selectedCustomer = customer;
                    newInvoice.CustomerId = customer.CustomerId;
                    customerSearchTerm = string.IsNullOrEmpty(customer.CompanyName)
                        ? customer.FullName
                        : customer.CompanyName;
                }
            }
        }
        catch
        {
            // Ignore query parsing errors
        }
    }
    private async Task DownloadPdf(Invoice invoice)
    {
        try
        {
            pdfDownloadStatus = "Preparing PDF...";
            StateHasChanged();

            await Task.Delay(300); // Small delay for smooth UX

            pdfDownloadStatus = "Generating PDF...";
            StateHasChanged();

            var pdfBytes = PdfService.GenerateInvoicePdf(invoice);
            var fileName = $"Invoice_{invoice.InvoiceNumber}.pdf";

            pdfDownloadStatus = "Downloading PDF...";
            StateHasChanged();

            await JS.InvokeVoidAsync("downloadFile", fileName, Convert.ToBase64String(pdfBytes));

            pdfDownloadStatus = "PDF Downloaded!";

            // Auto close after 3 seconds
            pdfStatusTimer?.Dispose();
            pdfStatusTimer = new Timer(_ =>
            {
                InvokeAsync(() =>
                {
                    pdfDownloadStatus = "";
                    StateHasChanged();
                });
            }, null, 3000, Timeout.Infinite);
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to generate PDF: {ex.Message}";
            pdfDownloadStatus = "";
            Console.WriteLine(ex);
        }
    }
}
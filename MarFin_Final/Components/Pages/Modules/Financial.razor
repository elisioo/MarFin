@page "/financial"
@inject NavigationManager Navigation
@inject AuthService AuthService
@using MarFin_Final.Data
@using MarFin_Final.Database.Services
@using MarFin_Final.Models

<div class="financial-container">
    <div class="financial-header">
        <div class="header-title">
            <h1>Financial Transactions</h1>
            <span class="transaction-count">@filteredInvoices.Count transactions</span>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">
            @errorMessage
            <button class="alert-close" @onclick="() => errorMessage = string.Empty">×</button>
        </div>
    }
    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success">
            @successMessage
            <button class="alert-close" @onclick="() => successMessage = string.Empty">×</button>
        </div>
    }

    <!-- Financial Summary -->
    <div class="financial-summary">
        <h3>Financial Summary</h3>
        <div class="summary-cards">
            <div class="summary-card revenue">
                <div class="card-icon"><i class="bi bi-cash-stack"></i></div>
                <div class="card-content">
                    <h2>Php @totalRevenue.ToString("N2")</h2>
                    <p>Total Revenue</p>
                    <span class="card-badge positive"><i class="bi bi-graph-up"></i> +12.5%</span>
                </div>
            </div>
            <div class="summary-card pending">
                <div class="card-icon"><i class="bi bi-hourglass-split"></i></div>
                <div class="card-content">
                    <h2>Php @totalPending.ToString("N2")</h2>
                    <p>Pending</p>
                    <span class="card-badge info"><i class="bi bi-file-earmark-text"></i> @pendingCount inv.</span>
                </div>
            </div>
            <div class="summary-card overdue">
                <div class="card-icon"><i class="bi bi-exclamation-triangle"></i></div>
                <div class="card-content">
                    <h2>Php @totalOverdue.ToString("N2")</h2>
                    <p>Overdue</p>
                    <span class="card-badge warning"><i class="bi bi-clock-history"></i> @overdueCount inv.</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Toolbar -->
    <div class="financial-toolbar">
        <button class="btn-primary" @onclick="ToggleInvoiceModal">
            <i class="bi bi-plus-lg"></i> New Invoice
        </button>
        <div class="toolbar-filters">
            <div class="dropdown-filter">
                <button class="btn-filter" @onclick="ToggleDateFilter">
                    @selectedDateFilter <i class="bi bi-chevron-down"></i>
                </button>
                @if (showDateFilter)
                {
                    <div class="dropdown-menu show">
                        <button type="button" @onclick='() => ApplyDateFilter("This Month")'>This Month</button>
                        <button type="button" @onclick='() => ApplyDateFilter("Last Month")'>Last Month</button>
                        <button type="button" @onclick='() => ApplyDateFilter("This Year")'>This Year</button>
                        <button type="button" @onclick='() => ApplyDateFilter("All Time")'>All Time</button>
                    </div>
                }
            </div>

            <div class="dropdown-filter">
                <button class="btn-filter" @onclick="ToggleStatusFilter">
                    <i class="bi bi-funnel"></i> Filter by
                    @if (!string.IsNullOrEmpty(statusFilter))
                    {
                        <span class="filter-badge">@statusFilter</span>
                    }
                </button>
                @if (showStatusFilter)
                {
                    <div class="dropdown-menu show">
                        <button type="button" @onclick='() => ApplyStatusFilter("")'>All Statuses</button>
                        <button type="button" @onclick='() => ApplyStatusFilter("Draft")'>Draft</button>
                        <button type="button" @onclick='() => ApplyStatusFilter("Issued")'>Issued</button>
                        <button type="button" @onclick='() => ApplyStatusFilter("Paid")'>Paid</button>
                        <button type="button" @onclick='() => ApplyStatusFilter("Partial")'>Partial</button>
                        <button type="button" @onclick='() => ApplyStatusFilter("Overdue")'>Overdue</button>
                    </div>
                }
            </div>

            <div class="search-box">
                <i class="bi bi-search search-icon"></i>
                <input type="text"
                       placeholder="Search here..."
                       @bind="searchTerm"
                       @bind:event="oninput" />
            </div>

            <button class="btn-filter"><i class="bi bi-download"></i> Export</button>
        </div>
    </div>

    <!-- Transactions Table -->
    @if (isLoading)
    {
        <div class="loading-state">
            <div class="spinner"></div>
            <p>Loading invoices...</p>
        </div>
    }
    else if (!filteredInvoices.Any())
    {
        <div class="empty-state text-center">
            <i class="bi bi-inbox fs-2 text-muted"></i>
            <p>No transactions found</p>
        </div>
    }
    else
    {
        <div class="transactions-table">
            <div class="table-header">
                <span>Invoice ID</span>
                <span>Customer</span>
                <span>Amount</span>
                <span>Date</span>
                <span>Status</span>
            </div>
            @foreach (var invoice in filteredInvoices.Take(10))
            {
                <div class="table-row" @onclick="() => ViewInvoice(invoice)">
                    <span>@invoice.InvoiceNumber</span>
                    <span>@(string.IsNullOrEmpty(invoice.CustomerCompany) ? invoice.CustomerName : invoice.CustomerCompany)</span>
                    <span>Php @invoice.TotalAmount.ToString("N2")</span>
                    <span>@invoice.InvoiceDate.ToString("MM/dd/yyyy")</span>
                    <span>
                        <span class="status-badge @invoice.StatusBadgeClass">
                            @(invoice.IsOverdue ? "Overdue" : invoice.PaymentStatus)
                        </span>
                    </span>
                </div>
            }
        </div>
        <div class="table-footer">
            <span>Showing @Math.Min(filteredInvoices.Count, 10) of @filteredInvoices.Count invoices</span>
        </div>
    }
</div>

<!-- New/Edit Invoice Modal -->
@if (showInvoiceModal)
{
    <div class="modal-overlay" @onclick="ToggleInvoiceModal">
        <div class="modal-content invoice-modal" @onclick:stopPropagation>
            <div class="invoice-modal-header">
                <button class="btn-back" @onclick="ToggleInvoiceModal">
                    <i class="bi bi-arrow-left"></i> Back
                </button>
                <div class="modal-actions">
                    <button class="btn-cancel" @onclick="ToggleInvoiceModal">Cancel</button>
                    <button class="btn-secondary" @onclick="SaveDraft" disabled="@isSaving">
                        @(isSaving ? "Saving..." : "Save Draft")
                    </button>
                    <button class="btn-primary" @onclick="GenerateInvoice" disabled="@isSaving">
                        @(isSaving ? "Generating..." : "Generate Invoice") <i class="bi bi-arrow-right"></i>
                    </button>
                </div>
            </div>

            <div class="invoice-modal-body">
                <div class="invoice-form-section">
                    <h3>Invoice Information</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Select Customer <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" placeholder="Search customer..."
                                   @bind="customerSearchTerm"
                                   @bind:event="oninput" />
                            @if (showCustomerDropdown && searchResults.Any())
                            {
                                <div class="dropdown-menu show">
                                    @foreach (var customer in searchResults)
                                    {
                                        <button type="button" @onclick="() => SelectCustomer(customer)">
                                            <strong>@(string.IsNullOrEmpty(customer.CompanyName) ? customer.FullName : customer.CompanyName)</strong><br />
                                            <small>@customer.Email</small>
                                        </button>
                                    }  
                                </div>
                            }
                            @if (selectedCustomer != null)
                            {
                                <div class="selected-customer">
                                    <i class="bi bi-check-circle-fill"></i> @customerSearchTerm
                                </div>
                            }
                        </div>
                        <div class="form-group">
                            <label>Invoice Number</label>
                            <input type="text" class="form-control" @bind="newInvoice.InvoiceNumber" readonly />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Invoice Date <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" @bind="newInvoice.InvoiceDate" />
                        </div>
                        <div class="form-group">
                            <label>Due Date <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" @bind="newInvoice.DueDate" />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Payment Terms</label>
                            <select class="form-control" @bind="newInvoice.PaymentTerms">
                                <option value="Net 15">Net 15</option>
                                <option value="Net 30">Net 30</option>
                                <option value="Net 60">Net 60</option>
                                <option value="Due on Receipt">Due on Receipt</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Tax Rate (%)</label>
                            <input type="number" class="form-control"
                                   @bind="newInvoice.TaxRate"
                                   @bind:event="oninput"
                                   step="0.01" />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Discount Amount</label>
                            <input type="number" class="form-control"
                                   @bind="newInvoice.DiscountAmount"
                                   @bind:event="oninput"
                                   step="0.01" placeholder="0.00" />
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Notes / Payment Instructions</label>
                        <textarea class="form-control" rows="3" @bind="newInvoice.Notes"></textarea>
                    </div>
                </div>

                <div class="invoice-items-section">
                    <div class="section-header">
                        <h3>Line Items</h3>
                        <button class="btn-add-item" @onclick="AddLineItem">
                            <i class="bi bi-plus-lg"></i> Add Item
                        </button>
                    </div>

                    <div class="line-items-table">
                        <div class="items-table-header">
                            <span>Description</span>
                            <span>Qty</span>
                            <span>Unit Price</span>
                            <span>Amount</span>
                            <span></span>
                        </div>
                        @foreach (var item in newInvoice.LineItems)
                        {
                            <div class="items-table-row">
                                <input type="text" class="form-control" @bind="item.Description" placeholder="Description" />
                                <input type="number" class="form-control"
                                       @bind="item.Quantity"
                                       @bind:event="oninput"
                                       step="0.01" min="0.01" />
                                <input type="number" class="form-control"
                                       @bind="item.UnitPrice"
                                       @bind:event="oninput"
                                       step="0.01" min="0" />
                                <span class="item-amount">Php @((item.Quantity * item.UnitPrice).ToString("N2"))</span>
                                <button class="btn-remove" @onclick="() => RemoveLineItem(item)"
                                        disabled="@(newInvoice.LineItems.Count <= 1)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        }
                    </div>

                    <div class="invoice-summary">
                        <div class="summary-row"><span>Subtotal</span> <span>Php @newInvoice.Subtotal.ToString("N2")</span></div>
                        <div class="summary-row"><span>Tax (@newInvoice.TaxRate%)</span> <span>Php @newInvoice.TaxAmount.ToString("N2")</span></div>
                        <div class="summary-row"><span>Discount</span> <span>-Php @newInvoice.DiscountAmount.ToString("N2")</span></div>
                        <div class="summary-row total"><span>Total</span> <span>Php @newInvoice.TotalAmount.ToString("N2")</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<!-- View Invoice Modal -->
@if (showViewModal && selectedInvoice != null)
{
    <div class="modal-overlay" @onclick="CloseViewModal">
        <div class="modal-content view-invoice-modal" @onclick:stopPropagation>
            <div class="view-invoice-header">
                <button class="btn-back" @onclick="CloseViewModal">
                    <i class="bi bi-arrow-left"></i> Back
                </button>
                <div class="invoice-title-section">
                    <span>Invoice @selectedInvoice.InvoiceNumber</span>
                </div>
                <div class="invoice-actions">
                    <button class="btn-icon" title="Email"><i class="bi bi-envelope"></i></button>
                    <button class="btn-icon" title="Download"><i class="bi bi-download"></i></button>
                    <button class="btn-icon" title="Print"><i class="bi bi-printer"></i></button>
                    <button class="btn-icon" title="Edit" @onclick="() => EditInvoice(selectedInvoice)">
                        <i class="bi bi-pencil"></i>
                    </button>
                </div>
            </div>

            <div class="view-invoice-body">
                <div class="invoice-preview">
                    <div class="invoice-preview-header">
                        <div class="company-info">
                            <div class="company-logo"><i class="bi bi-buildings"></i> <span>MarFin</span></div>
                            <p>123 Business Street<br />Makati, Manila Philippines<br />1200</p>
                            <p>contact@marfin.com<br />+63 912 345 6789</p>
                        </div>
                        <div class="invoice-badge">
                            <div class="badge-label">INVOICE</div>
                            <div class="badge-number">@selectedInvoice.InvoiceNumber</div>
                        </div>
                    </div>

                    <div class="invoice-preview-details">
                        <div class="bill-to">
                            <h4>Bill to:</h4>
                            <p>
                                <strong>@(string.IsNullOrEmpty(selectedInvoice.CustomerCompany) ? selectedInvoice.CustomerName : selectedInvoice.CustomerCompany)</strong><br />
                                @selectedInvoice.CustomerName<br />
                                @selectedInvoice.CustomerEmail
                            </p>
                        </div>
                        <div class="invoice-details">
                            <h4>Invoice Details:</h4>
                            <div class="detail-row"><span>Invoice Date:</span> <span>@selectedInvoice.InvoiceDate:ToString("MM/dd/yyyy")</span></div>
                            <div class="detail-row"><span>Due Date:</span> <span>@selectedInvoice.DueDate:ToString("MM/dd/yyyy")</span></div>
                            <div class="detail-row"><span>Payment Terms:</span> <span>@selectedInvoice.PaymentTerms</span></div>
                            <div class="detail-row">
                                <span>Status:</span>
                                <span class="status-badge @selectedInvoice.StatusBadgeClass">
                                    @(selectedInvoice.IsOverdue ? "Overdue" : selectedInvoice.PaymentStatus)
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="invoice-items-preview">
                        <table class="preview-table">
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th>Qty</th>
                                    <th>Unit Price</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in selectedInvoice.LineItems)
                                {
                                    <tr>
                                        <td>@item.Description</td>
                                        <td>@item.Quantity</td>
                                        <td>Php @item.UnitPrice.ToString("N2")</td>
                                        <td>Php @item.Amount.ToString("N2")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <div class="invoice-totals">
                        <div class="totals-row"><span>Subtotal</span> <span>Php @selectedInvoice.Subtotal.ToString("N2")</span></div>
                        <div class="totals-row"><span>Tax (@selectedInvoice.TaxRate%)</span> <span>Php @selectedInvoice.TaxAmount.ToString("N2")</span></div>
                        <div class="totals-row total"><span>Total</span> <span>Php @selectedInvoice.TotalAmount.ToString("N2")</span></div>
                    </div>

                    <div class="payment-info">
                        <h4>PAYMENT INFORMATION:</h4>
                        <p>
                            Bank Name: BPI (Bank of the Philippine Islands)<br />
                            Account Number: 1234-5678-9012-3456<br />
                            Account Name: MarFin Business Account
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private readonly InvoiceService invoiceService = new();
    private readonly CustomerService customerService = new();

    private List<Invoice> allInvoices = new();
    private List<Invoice> filteredInvoices = new();
    private List<Customer> searchResults = new();
    private Customer? selectedCustomer;

    private string searchTerm = "";
    private string customerSearchTerm = "";
    private string statusFilter = "";
    private string selectedDateFilter = "This Month";

    private bool showInvoiceModal = false;
    private bool showViewModal = false;
    private bool showStatusFilter = false;
    private bool showDateFilter = false;
    private bool showCustomerDropdown = false;
    private bool isLoading = true;
    private bool isSaving = false;

    private Invoice? selectedInvoice;
    private Invoice newInvoice = new();

    private string errorMessage = "";
    private string successMessage = "";

    private int currentUserId = 1;

    private decimal totalRevenue = 0;
    private decimal totalPending = 0;
    private decimal totalOverdue = 0;
    private int pendingCount = 0;
    private int overdueCount = 0;

    protected override async Task OnInitializedAsync()
    {
        if (AuthService?.CurrentUser == null)
        {
            Navigation.NavigateTo("/login", true);
            return;
        }
        await LoadInvoices();
    }

    private async Task LoadInvoices()
    {
        try
        {
            isLoading = true;
            await Task.Run(() =>
            {
                allInvoices = invoiceService.GetAllInvoices() ?? new List<Invoice>();
            });

            filteredInvoices = new List<Invoice>(allInvoices);
            ApplyFilters();
            CalculateSummary();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading invoices: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void CalculateSummary()
    {
        totalRevenue = allInvoices.Where(i => i.PaymentStatus == "Paid").Sum(i => i.TotalAmount);
        totalPending = allInvoices.Where(i => i.PaymentStatus is "Issued" or "Partial").Sum(i => i.TotalAmount);
        totalOverdue = allInvoices.Where(i => i.IsOverdue).Sum(i => i.TotalAmount);
        pendingCount = allInvoices.Count(i => i.PaymentStatus is "Issued" or "Partial");
        overdueCount = allInvoices.Count(i => i.IsOverdue);
    }

    private void ToggleInvoiceModal()
    {
        showInvoiceModal = !showInvoiceModal;
        if (!showInvoiceModal)
        {
            ResetInvoiceForm();
        }
        else
        {
            newInvoice = new Invoice
            {
                CreatedBy = currentUserId,
                InvoiceNumber = invoiceService.GenerateInvoiceNumber(),
                InvoiceDate = DateTime.Now,
                DueDate = DateTime.Now.AddDays(30),
                PaymentTerms = "Net 30",
                TaxRate = 12.00m,
                PaymentStatus = "Draft",
                LineItems = new List<InvoiceItem> { new() { Description = "", Quantity = 1, UnitPrice = 0, ItemOrder = 1 } }
            };
            selectedCustomer = null;
            customerSearchTerm = "";
        }
    }

    private void ResetInvoiceForm()
    {
        newInvoice = new Invoice();
        selectedCustomer = null;
        customerSearchTerm = "";
        searchResults.Clear();
        showCustomerDropdown = false;
    }

    private async Task SearchCustomers()
    {
        if (string.IsNullOrWhiteSpace(customerSearchTerm))
        {
            searchResults.Clear();
            showCustomerDropdown = false;
            return;
        }

        searchResults = await customerService.SearchCustomersAsync(customerSearchTerm, 10);
        showCustomerDropdown = searchResults.Any();
    }

    private void SelectCustomer(Customer customer)
    {
        selectedCustomer = customer;
        newInvoice.CustomerId = customer.CustomerId;
        customerSearchTerm = string.IsNullOrEmpty(customer.CompanyName) ? customer.FullName : customer.CompanyName;
        showCustomerDropdown = false;
    }

    private void AddLineItem()
    {
        var nextOrder = newInvoice.LineItems.Any() ? newInvoice.LineItems.Max(i => i.ItemOrder) + 1 : 1;
        newInvoice.LineItems.Add(new InvoiceItem { Description = "", Quantity = 1, UnitPrice = 0, ItemOrder = nextOrder });
    }

    private void RemoveLineItem(InvoiceItem item)
    {
        if (newInvoice.LineItems.Count > 1)
        {
            newInvoice.LineItems.Remove(item);
            CalculateTotals();
        }
    }

    private void CalculateTotals()
    {
        newInvoice.Subtotal = newInvoice.LineItems.Sum(i => i.Quantity * i.UnitPrice);
        newInvoice.TaxAmount = newInvoice.Subtotal * (newInvoice.TaxRate / 100m);
        newInvoice.TotalAmount = newInvoice.Subtotal + newInvoice.TaxAmount - newInvoice.DiscountAmount;

        foreach (var item in newInvoice.LineItems)
        {
            item.Amount = item.Quantity * item.UnitPrice;
        }
        StateHasChanged();
    }

    private async Task SaveDraft() => await SaveInvoice("Draft");
    private async Task GenerateInvoice() => await SaveInvoice("Issued");

    private async Task SaveInvoice(string status)
    {
        if (newInvoice.CustomerId == 0)
        {
            errorMessage = "Please select a customer";
            return;
        }
        if (newInvoice.LineItems.All(i => string.IsNullOrWhiteSpace(i.Description)))
        {
            errorMessage = "Please add at least one valid line item";
            return;
        }

        newInvoice.PaymentStatus = status;
        CalculateTotals();

        try
        {
            isSaving = true;

            bool success = newInvoice.InvoiceId > 0
                ? invoiceService.UpdateInvoice(newInvoice)
                : invoiceService.AddInvoice(newInvoice);

            if (success)
            {
                successMessage = status == "Draft" ? "Invoice saved as draft!" : "Invoice generated successfully!";
                ToggleInvoiceModal();
                await LoadInvoices();
            }
            else
            {
                errorMessage = "Failed to save invoice.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private void ViewInvoice(Invoice invoice)
    {
        selectedInvoice = invoiceService.GetInvoiceById(invoice.InvoiceId);
        showViewModal = true;
    }

    private void EditInvoice(Invoice invoice)
    {
        newInvoice = invoiceService.GetInvoiceById(invoice.InvoiceId) ?? new Invoice();
        selectedCustomer = customerService.GetCustomerById(newInvoice.CustomerId);
        customerSearchTerm = string.IsNullOrEmpty(selectedCustomer?.CompanyName) ? selectedCustomer?.FullName : selectedCustomer?.CompanyName;
        showViewModal = false;
        showInvoiceModal = true;
    }

    private void CloseViewModal()
    {
        showViewModal = false;
        selectedInvoice = null;
    }

    private void SearchInvoices() => ApplyFilters();

    private void ApplyDateFilter(string filter)
    {
        selectedDateFilter = filter;
        showDateFilter = false;
        ApplyFilters();
    }

    private void ApplyStatusFilter(string status)
    {
        statusFilter = status;
        showStatusFilter = false;
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        filteredInvoices = new List<Invoice>(allInvoices);

        if (selectedDateFilter != "All Time")
        {
            var now = DateTime.Now;
            filteredInvoices = selectedDateFilter switch
            {
                "This Month" => filteredInvoices.Where(i => i.InvoiceDate.Month == now.Month && i.InvoiceDate.Year == now.Year).ToList(),
                "Last Month" => filteredInvoices.Where(i => i.InvoiceDate.Month == now.AddMonths(-1).Month && i.InvoiceDate.Year == now.AddMonths(-1).Year).ToList(),
                "This Year" => filteredInvoices.Where(i => i.InvoiceDate.Year == now.Year).ToList(),
                _ => filteredInvoices
            };
        }

        if (!string.IsNullOrEmpty(statusFilter))
        {
            filteredInvoices = statusFilter == "Overdue"
                ? filteredInvoices.Where(i => i.IsOverdue).ToList()
                : filteredInvoices.Where(i => i.PaymentStatus == statusFilter).ToList();
        }

        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            var term = searchTerm.ToLower();
            filteredInvoices = filteredInvoices.Where(i =>
                i.InvoiceNumber.Contains(term, StringComparison.OrdinalIgnoreCase) ||
                i.CustomerName.Contains(term, StringComparison.OrdinalIgnoreCase) ||
                (!string.IsNullOrEmpty(i.CustomerCompany) && i.CustomerCompany.Contains(term, StringComparison.OrdinalIgnoreCase))
            ).ToList();
        }
    }

    private void ToggleStatusFilter()
    {
        showStatusFilter = !showStatusFilter;
        showDateFilter = false;
    }

    private void ToggleDateFilter()
    {
        showDateFilter = !showDateFilter;
        showStatusFilter = false;
    }
}
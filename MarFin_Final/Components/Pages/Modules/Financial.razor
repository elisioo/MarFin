@page "/financial"
@using MarFin.Models
@using MarFin.Services
@using MarFin_Final.Data
@using MarFin_Final.Models
@inject InvoiceService InvoiceService
@inject NavigationManager NavigationManager
@inject CustomerService CustomerService

<div class="financial-container">
    <!-- Existing header and content... -->
    <div class="financial-header">
        <div class="header-title">
            <h1>Financial Transactions</h1>
            <span class="transaction-count">@totalCount transactions</span>
            @if (hasMoreRecords)
            {
                <span class="warning-badge">
                    <i class="bi bi-exclamation-circle"></i> Showing @maxRecords of @totalCount records
                </span>
            }
        </div>
    </div>

    <!-- Financial Summary -->
    <div class="financial-summary">
        <h3>Financial Summary</h3>
        <div class="summary-cards">
            <div class="summary-card revenue">
                <div class="card-icon">
                    <i class="bi bi-cash-stack"></i>
                </div>
                <div class="card-content">
                    <h2>Php @summary.TotalRevenue.ToString("N2")</h2>
                    <p>Total Revenue</p>
                    <span class="card-badge positive">
                        <i class="bi bi-graph-up"></i> +@summary.RevenueChangePercent.ToString("N1")%
                    </span>
                </div>
            </div>

            <div class="summary-card pending">
                <div class="card-icon">
                    <i class="bi bi-hourglass-split"></i>
                </div>
                <div class="card-content">
                    <h2>Php @summary.TotalPending.ToString("N2")</h2>
                    <p>Pending</p>
                    <span class="card-badge info">
                        <i class="bi bi-file-earmark-text"></i> @summary.PendingInvoicesCount inv.
                    </span>
                </div>
            </div>

            <div class="summary-card overdue">
                <div class="card-icon">
                    <i class="bi bi-exclamation-triangle"></i>
                </div>
                <div class="card-content">
                    <h2>Php @summary.TotalOverdue.ToString("N2")</h2>
                    <p>Overdue</p>
                    <span class="card-badge warning">
                        <i class="bi bi-clock-history"></i> @summary.OverdueInvoicesCount inv.
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Toolbar -->
    <div class="financial-toolbar">
        <button class="btn-primary" @onclick="ToggleInvoiceModal">
            <i class="bi bi-plus-lg"></i> New Invoice
        </button>

        <div class="toolbar-filters">
            <div class="dropdown-filter">
                <select class="btn-filter" @onchange="OnDateFilterChange">
                    <option value="this_month">This Month</option>
                    <option value="last_month">Last Month</option>
                    <option value="this_quarter">This Quarter</option>
                    <option value="this_year">This Year</option>
                    <option value="all">All Time</option>
                </select>
            </div>

            <div class="dropdown-filter">
                <select class="btn-filter" @onchange="OnStatusFilterChange">
                    <option value="">All Status</option>
                    <option value="Draft">Draft</option>
                    <option value="Issued">Issued</option>
                    <option value="Partial">Partial</option>
                    <option value="Paid">Paid</option>
                    <option value="Overdue">Overdue</option>
                    <option value="Void">Void</option>
                </select>
            </div>

            <div class="dropdown-filter">
                <select class="btn-filter" @onchange="OnSortChange">
                    <option value="invoice_date_desc">Date (Newest)</option>
                    <option value="invoice_date_asc">Date (Oldest)</option>
                    <option value="amount_desc">Amount (High-Low)</option>
                    <option value="amount_asc">Amount (Low-High)</option>
                    <option value="customer_asc">Customer (A-Z)</option>
                    <option value="invoice_number_asc">Invoice # (A-Z)</option>
                </select>
            </div>

            <div class="search-box">
                <i class="bi bi-search search-icon"></i>
                <input type="text"
                       placeholder="Search invoices, customers..."
                       @bind="searchTerm"
                       @bind:event="oninput"
                       @onkeyup="OnSearchKeyUp" />
            </div>

            <button class="btn-filter" @onclick="ExportData">
                <i class="bi bi-download"></i> Export
            </button>
        </div>
    </div>

    @if (hasMoreRecords)
    {
        <div class="info-banner">
            <i class="bi bi-info-circle"></i>
            <span>Displaying @maxRecords out of @totalCount total records to optimize performance.</span>
            <button class="btn-link" @onclick="LoadMoreRecords">Load up to 1000 records</button>
        </div>
    }

    <!-- Transactions Table -->
    @if (isLoading)
    {
        <div class="loading-state">
            <div class="spinner"></div>
            <p>Loading invoices...</p>
        </div>
    }
    else if (invoices.Any())
    {
        <div class="transactions-table">
            <div class="table-header">
                <span>Invoice ID</span>
                <span>Customer</span>
                <span>Amount</span>
                <span>Date</span>
                <span>Status</span>
            </div>

            @foreach (var invoice in invoices)
            {
                <div class="table-row @(invoice.IsOverdue ? "overdue-row" : "")"
                     @onclick="() => ViewInvoice(invoice.InvoiceId)">
                    <span class="invoice-id">@invoice.InvoiceNumber</span>
                    <span class="customer-info">
                        <strong>@(string.IsNullOrEmpty(invoice.CustomerCompany) ? invoice.CustomerName : invoice.CustomerCompany)</strong>
                        @if (!string.IsNullOrEmpty(invoice.CustomerCompany))
                        {
                            <small>@invoice.CustomerName</small>
                        }
                    </span>
                    <span class="amount">Php @invoice.TotalAmount.ToString("N2")</span>
                    <span>@invoice.InvoiceDate.ToString("MM/dd/yyyy")</span>
                    <span>
                        <span class="status-badge status-@invoice.PaymentStatus.ToLower()">
                            @invoice.PaymentStatus
                        </span>
                    </span>
                </div>
            }
        </div>

        <!-- Pagination -->
        <div class="table-footer">
            <div class="pagination-info">
                <span>Showing @((currentPage - 1) * pageSize + 1)–@Math.Min(currentPage * pageSize, totalCount) of @totalCount</span>
                <select class="page-size-selector" @onchange="OnPageSizeChange">
                    <option value="10" selected="@(pageSize == 10)">10 per page</option>
                    <option value="25" selected="@(pageSize == 25)">25 per page</option>
                    <option value="50" selected="@(pageSize == 50)">50 per page</option>
                    <option value="100" selected="@(pageSize == 100)">100 per page</option>
                </select>
            </div>

            <div class="pagination-controls">
                <button class="btn-pagination"
                        @onclick="() => GoToPage(1)"
                        disabled="@(currentPage == 1)">
                    <i class="bi bi-chevron-double-left"></i>
                </button>
                <button class="btn-pagination"
                        @onclick="() => GoToPage(currentPage - 1)"
                        disabled="@(currentPage == 1)">
                    <i class="bi bi-chevron-left"></i>
                </button>

                @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                {
                    var pageNumber = i;
                    <button class="btn-pagination @(pageNumber == currentPage ? "active" : "")"
                            @onclick="() => GoToPage(pageNumber)">
                        @pageNumber
                    </button>
                }

                <button class="btn-pagination"
                        @onclick="() => GoToPage(currentPage + 1)"
                        disabled="@(currentPage >= totalPages)">
                    <i class="bi bi-chevron-right"></i>
                </button>
                <button class="btn-pagination"
                        @onclick="() => GoToPage(totalPages)"
                        disabled="@(currentPage >= totalPages)">
                    <i class="bi bi-chevron-double-right"></i>
                </button>
            </div>
        </div>
    }
    else
    {
        <div class="empty-state">
            <i class="bi bi-inbox fs-2 text-muted"></i>
            <p>No invoices found</p>
            @if (!string.IsNullOrEmpty(searchTerm) || !string.IsNullOrEmpty(selectedStatus))
            {
                <button class="btn-secondary" @onclick="ClearFilters">Clear Filters</button>
            }
        </div>
    }
</div>

@* New/Edit Invoice Modal *@
@if (showInvoiceModal)
{
    <div class="modal-overlay" @onclick="ToggleInvoiceModal">
        <div class="modal-content invoice-modal" @onclick:stopPropagation>
            <div class="invoice-modal-header">
                <button class="btn-back" @onclick="ToggleInvoiceModal">
                    <i class="bi bi-arrow-left"></i> Back
                </button>
                <div class="modal-actions">
                    <button class="btn-cancel" @onclick="ToggleInvoiceModal">Cancel</button>
                    <button class="btn-secondary" @onclick="SaveDraft">Save Draft</button>
                    <button class="btn-primary" @onclick="GenerateInvoice">
                        Generate Invoice <i class="bi bi-arrow-right"></i>
                    </button>
                </div>
            </div>

            <div class="invoice-modal-body">
                <div class="invoice-form-section">
                    <h3>Invoice Information</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Select Customer</label>
                            <div class="customer-search-container" style="position: relative;">
                                <label>Customer *</label>
                                <input type="text"
                                       class="form-control"
                                       placeholder="Type customer name, company, email..."
                                       value="@customerSearchTerm"
                                       @oninput="OnCustomerSearch"
                                       @onfocus="() => showCustomerDropdown = true"
                                       autocomplete="off" />

                                @if (showCustomerDropdown && !string.IsNullOrWhiteSpace(customerSearchTerm))
                                {
                                    <div class="customer-dropdown" style="position: absolute; top: 100%; left: 0; right: 0;
                     max-height: 300px; overflow-y: auto; background: white; border: 1px solid #ccc;
                     border-top: none; z-index: 1000; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                                        @if (!searchedCustomers.Any())
                                        {
                                            <div class="dropdown-item text-muted p-3">No customers found</div>
                                        }
                                        else
                                        {
                                            @foreach (var cust in searchedCustomers)
                                            {
                                                <div class="dropdown-item"
                                                     style="padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #eee;"
                                                     @onclick="() => SelectCustomer(cust)"
                                                     @onclick:stopPropagation>
                                                    <strong>
                                                        @(string.IsNullOrEmpty(cust.CompanyName) ?
                                                                                                $"{cust.FirstName} {cust.LastName}" :
                                                                                                cust.CompanyName)
                                                    </strong>
                                                    @if (!string.IsNullOrEmpty(cust.CompanyName))
                                                    {
                                                        <br />
                                    
                                                        <small class="text-muted">@cust.FirstName @cust.LastName</small>
                                                    }
                                                    <br /><small class="text-muted">@cust.Email</small>
                                                </div>
                                            }
                                        }
                                    </div>
                                }
                            </div>

                            @if (newInvoice.CustomerId > 0 && selectedCustomer != null)
                            {
                                <div class="selected-customer-preview mt-2 p-2 bg-light rounded">
                                    Selected: <strong>
                                        @(string.IsNullOrEmpty(selectedCustomer.CompanyName)
                                                                        ? $"{selectedCustomer.FirstName} {selectedCustomer.LastName}"
                                                                        : selectedCustomer.CompanyName)
                                    </strong>
                                    <button type="button" class="btn btn-sm btn-outline-danger ms-3" @onclick="ClearCustomer">
                                        Clear
                                    </button>
                                </div>
                            }
                        </div>
                        <div class="form-group">
                            <label>Invoice Number</label>
                            <input type="text" class="form-control" value="@nextInvoiceNumber" readonly />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Invoice Date*</label>
                            <input type="date" class="form-control" @bind="newInvoice.InvoiceDate" />
                        </div>
                        <div class="form-group">
                            <label>Due Date*</label>
                            <input type="date" class="form-control" @bind="newInvoice.DueDate" />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Payment Terms</label>
                            <select class="form-control" @bind="newInvoice.PaymentTerms">
                                <option value="Net 15">Net 15</option>
                                <option value="Net 30">Net 30</option>
                                <option value="Net 60">Net 60</option>
                                <option value="Due on Receipt">Due on Receipt</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Tax Rate (%)</label>
                            <input type="number" step="0.01" class="form-control" @bind="newInvoice.TaxRate" />
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Notes / Payment Instructions</label>
                        <textarea class="form-control" rows="3" @bind="newInvoice.Notes"></textarea>
                    </div>
                </div>

                <div class="invoice-items-section">
                    <div class="section-header">
                        <h3>Line Items</h3>
                        <button class="btn-add-item" @onclick="AddLineItem">
                            <i class="bi bi-plus-lg"></i> Add Item
                        </button>
                    </div>

                    <div class="line-items-table">
                        <div class="items-table-header">
                            <span>Description</span>
                            <span>Qty</span>
                            <span>Unit Price</span>
                            <span>Amount</span>
                            <span>Remove</span>
                        </div>
                        @foreach (var item in newInvoice.Items)
                        {
                            <div class="items-table-row">
                                <input type="text" class="form-control" @bind="item.Description" />
                                <input type="number" class="form-control" @bind="item.Quantity" @oninput="CalculateTotals" />
                                <input type="number" step="0.01" class="form-control" @bind="item.UnitPrice" @oninput="CalculateTotals" />
                                <span class="item-amount">Php @((item.Quantity * item.UnitPrice).ToString("N2"))</span>
                                <button class="btn-remove" @onclick="() => RemoveLineItem(item)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        }
                    </div>

                    <div class="invoice-summary">
                        <div class="summary-row">
                            <span>Subtotal</span>
                            <span>Php @calculatedSubtotal.ToString("N2")</span>
                        </div>
                        <div class="summary-row">
                            <span>Tax (@newInvoice.TaxRate%)</span>
                            <span>Php @calculatedTax.ToString("N2")</span>
                        </div>
                        <div class="summary-row">
                            <span>Discount</span>
                            <input type="number" step="0.01" class="form-control-inline" @bind="newInvoice.DiscountAmount" @oninput="CalculateTotals" />
                        </div>
                        <div class="summary-row total">
                            <span>Total</span>
                            <span>Php @calculatedTotal.ToString("N2")</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@* View Invoice Modal *@
@if (showViewModal && selectedInvoice != null)
{
    <div class="modal-overlay" @onclick="CloseViewModal">
        <div class="modal-content view-invoice-modal" @onclick:stopPropagation>
            <div class="view-invoice-header">
                <button class="btn-back" @onclick="CloseViewModal">
                    <i class="bi bi-arrow-left"></i> Back
                </button>
                <div class="invoice-title-section">
                    <span>Invoice @selectedInvoice.InvoiceNumber</span>
                </div>
                <div class="invoice-actions">
                    <button class="btn-icon" title="Email" @onclick="EmailInvoice">
                        <i class="bi bi-envelope"></i>
                    </button>
                    <button class="btn-icon" title="Download" @onclick="DownloadInvoice">
                        <i class="bi bi-download"></i>
                    </button>
                    <button class="btn-icon" title="Print" @onclick="PrintInvoice">
                        <i class="bi bi-printer"></i>
                    </button>
                    <button class="btn-icon" title="Edit">
                        <i class="bi bi-pencil"></i>
                    </button>
                </div>
            </div>

            <div class="view-invoice-body">
                <div class="invoice-preview">
                    <div class="invoice-preview-header">
                        <div class="company-info">
                            <div class="company-logo">
                                <i class="bi bi-buildings"></i>
                                <span>MarFin</span>
                            </div>
                            <p>
                                123 Business Street<br />
                                Matina, Davao Philippines<br />
                                8000
                            </p>
                            <p>
                                contact@marfin.com<br />
                                +63 912 345 6789
                            </p>
                        </div>
                        <div class="invoice-badge">
                            <div class="badge-label">INVOICE</div>
                            <div class="badge-number">@selectedInvoice.InvoiceNumber</div>
                        </div>
                    </div>

                    <div class="invoice-preview-details">
                        <div class="bill-to">
                            <h4>Bill to:</h4>
                            <p>
                                <strong>@(string.IsNullOrEmpty(selectedInvoice.CustomerCompany) ? selectedInvoice.CustomerName : selectedInvoice.CustomerCompany)</strong><br />
                                @if (!string.IsNullOrEmpty(selectedInvoice.CustomerCompany))
                                {
                                    @selectedInvoice.CustomerName
                            
                                    <br />
                                }
                            </p>
                        </div>
                        <div class="invoice-details">
                            <h4>Invoice Details:</h4>
                            <div class="detail-row">
                                <span>Invoice Date:</span>
                                <span>@selectedInvoice.InvoiceDate.ToString("MM/dd/yyyy")</span>
                            </div>
                            <div class="detail-row">
                                <span>Due Date:</span>
                                <span>@selectedInvoice.DueDate.ToString("MM/dd/yyyy")</span>
                            </div>
                            <div class="detail-row">
                                <span>Payment Terms:</span>
                                <span>@selectedInvoice.PaymentTerms</span>
                            </div>
                            <div class="detail-row">
                                <span>Status:</span>
                                <span class="status-badge status-@(selectedInvoice.PaymentStatus?.ToLower() ?? "unknown")">
                                    @selectedInvoice.PaymentStatus
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="invoice-items-preview">
                        <table class="preview-table">
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th>Qty</th>
                                    <th>Unit Price</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (selectedInvoice.Items != null)
                                {
                                    @foreach (var item in selectedInvoice.Items)
                                    {
                                        <tr>
                                            <td>@item.Description</td>
                                            <td>@item.Quantity</td>
                                            <td>Php @item.UnitPrice.ToString("N2")</td>
                                            <td>Php @item.Amount.ToString("N2")</td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>

                    <div class="invoice-totals">
                        <div class="totals-row">
                            <span>Subtotal</span>
                            <span>Php @selectedInvoice.Subtotal.ToString("N2")</span>
                        </div>
                        <div class="totals-row">
                            <span>Tax (@selectedInvoice.TaxRate%)</span>
                            <span>Php @selectedInvoice.TaxAmount.ToString("N2")</span>
                        </div>
                        @if (selectedInvoice.DiscountAmount > 0)
                        {
                            <div class="totals-row">
                                <span>Discount</span>
                                <span>-Php @selectedInvoice.DiscountAmount?.ToString("N2")</span>
                            </div>
                        }
                        <div class="totals-row total">
                            <span>Total</span>
                            <span>Php @selectedInvoice.TotalAmount.ToString("N2")</span>
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(selectedInvoice.Notes))
                    {
                        <div class="invoice-notes">
                            <h4>Notes:</h4>
                            <p>@selectedInvoice.Notes</p>
                        </div>
                    }

                    <div class="payment-info">
                        <h4>PAYMENT INFORMATION:</h4>
                        <p>
                            Bank Name: BPI (Bank of the Philippine Islands)<br />
                            Account Number: 1234-5678-9012-3456<br />
                            Account Name: MarFin Business Account
                        </p>
                    </div>
                </div>

                <div class="sidebar-actions">
                    <button class="btn-icon-large" title="Mark as Paid" @onclick='() => UpdateStatus(selectedInvoice.InvoiceId, "Paid")'>
                        <i class="bi bi-check-circle"></i>
                    </button>
                    <button class="btn-icon-large" title="Send Reminder">
                        <i class="bi bi-bell"></i>
                    </button>
                    <button class="btn-icon-large" title="Delete" @onclick="() => ShowDeleteConfirmation(selectedInvoice.InvoiceId)">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@* Delete Confirmation Modal *@
@if (showDeleteConfirmation)
{
    <div class="modal-overlay" @onclick="CancelDelete">
        <div class="modal-content confirmation-modal" @onclick:stopPropagation>
            <div class="confirmation-header">
                <i class="bi bi-exclamation-triangle text-warning"></i>
                <h3>Delete Invoice</h3>
            </div>
            <div class="confirmation-body">
                <p>Are you sure you want to delete this invoice? This action cannot be undone.</p>
            </div>
            <div class="confirmation-footer">
                <button class="btn-secondary" @onclick="CancelDelete">Cancel</button>
                <button class="btn-danger" @onclick="ConfirmDelete">Delete</button>
            </div>
        </div>
    </div>
}
@* Error Modal *@
@if (showErrorModal)
{
    <div class="modal-overlay" @onclick="CloseErrorModal">
        <div class="modal-content error-modal" @onclick:stopPropagation>
            <div class="error-modal-header">
                <div class="error-icon">
                    <i class="bi bi-exclamation-triangle"></i>
                </div>
                <h3>@errorTitle</h3>
            </div>
            <div class="error-modal-body">
                <p class="error-message">@errorMessage</p>
                @if (!string.IsNullOrEmpty(errorCode))
                {
                    <p class="error-code">Error Code: @errorCode</p>
                }
                @if (!string.IsNullOrEmpty(errorDetails))
                {
                    <details class="error-details">
                        <summary>Technical Details</summary>
                        <pre>@errorDetails</pre>
                    </details>
                }
            </div>
            <div class="error-modal-footer">
                <button class="btn-primary" @onclick="CloseErrorModal">
                    OK
                </button>
                @if (errorCode == "DB_CONNECTION_ERROR")
                {
                    <button class="btn-secondary" @onclick="TestDatabaseConnection">
                        Test Connection
                    </button>
                }
            </div>
        </div>
    </div>
}

@* Success Toast *@
@if (showSuccessToast)
{
    <div class="toast-container">
        <div class="toast success">
            <i class="bi bi-check-circle"></i>
            <span>@successMessage</span>
        </div>
    </div>
}

@code {
    private List<Customer> customers = new();
    private List<InvoiceListItem> invoices = new();
    private FinancialSummary summary = new();
    private Invoice? selectedInvoice = null;

    private string searchTerm = "";
    private string selectedStatus = "";
    private string selectedDateRange = "this_month";
    private string sortBy = "invoice_date";
    private string sortOrder = "desc";

    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages = 0;
    private int totalCount = 0;
    private int maxRecords = 200;
    private bool hasMoreRecords = false;

    private bool isLoading = true;
    private bool showInvoiceModal = false;
    private bool showViewModal = false;
    private bool showDeleteConfirmation = false;
    private bool showErrorModal = false;
    private bool showSuccessToast = false;

    private int invoiceToDelete = 0;

    private CreateInvoiceRequest newInvoice = new();
    private string nextInvoiceNumber = "";
    private decimal calculatedSubtotal = 0;
    private decimal calculatedTax = 0;
    private decimal calculatedTotal = 0;

    private string errorTitle = "";
    private string errorMessage = "";
    private string errorCode = "";
    private string errorDetails = "";
    private string successMessage = "";

    private string statusFilter = string.Empty;

    private System.Threading.Timer? searchDebounceTimer;
    private System.Threading.Timer? successToastTimer;

    private string customerSearchTerm = "";
    private List<Customer> searchedCustomers = new();
    private Customer? selectedCustomer = null;
    private bool showCustomerDropdown = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadInvoicesWithErrorHandling();
        await LoadNextInvoiceNumberWithErrorHandling();
   
    }
    // Call this when user types
    private async Task OnCustomerSearch(ChangeEventArgs e)
    {
        customerSearchTerm = e.Value?.ToString() ?? "";

        // Reset if too short
        if (string.IsNullOrWhiteSpace(customerSearchTerm) || customerSearchTerm.Length < 2)
        {
            searchedCustomers.Clear();
            showCustomerDropdown = false;
            StateHasChanged();
            return;
        }

        searchDebounceTimer?.Dispose();

        searchDebounceTimer = new Timer(async _ =>
        {
            try
            {
                var results = await CustomerService.SearchCustomersAsync(customerSearchTerm.Trim(), 50);

                await InvokeAsync(() =>
                {
                    searchedCustomers = results;
                    showCustomerDropdown = true;
                    StateHasChanged();
                });
            }
            catch (Exception ex)
            {
                Console.WriteLine("Customer search error: " + ex.Message);
            }
        }, null, 300, Timeout.Infinite);
    }

    // Select customer
    private void SelectCustomer(Customer customer)
    {
        selectedCustomer = customer;
        newInvoice.CustomerId = customer.CustomerId;
        customerSearchTerm = string.IsNullOrEmpty(customer.CompanyName)
            ? $"{customer.FirstName} {customer.LastName}"
            : customer.CompanyName;
        showCustomerDropdown = false;
    }

    // Clear selection
    private void ClearCustomer()
    {
        newInvoice.CustomerId = 0;
        selectedCustomer = null;
        customerSearchTerm = "";
        searchedCustomers.Clear();
        showCustomerDropdown = false;
    }

    // Hide dropdown when clicking outside
    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            // Optional: Add JS to close on outside click
        }
    }


    private async Task LoadInvoicesWithErrorHandling()
    {
        try
        {
            await LoadInvoices();
        }
        catch (ServiceException ex)
        {
            ShowError("Failed to Load Invoices", ex.UserFriendlyMessage, ex.ErrorCode, ex.Message);
        }
        catch (Exception ex)
        {
            ShowError("Unexpected Error", "An unexpected error occurred while loading invoices.", "UNKNOWN_ERROR", ex.Message);
        }
    }

    private async Task LoadInvoices()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            var filter = new InvoiceFilterRequest
            {
                SearchTerm = string.IsNullOrWhiteSpace(searchTerm) ? null : searchTerm,
                PaymentStatus = string.IsNullOrWhiteSpace(selectedStatus) ? null : selectedStatus,
                StartDate = GetStartDate(),
                EndDate = GetEndDate(),
                SortBy = sortBy,
                SortOrder = sortOrder,
                Page = currentPage,
                PageSize = pageSize,
                MaxRecords = maxRecords
            };

            var response = await InvoiceService.GetInvoicesAsync(filter);

            invoices = response.Invoices ?? new List<InvoiceListItem>();
            totalCount = response.TotalCount;
            totalPages = response.TotalPages;
            hasMoreRecords = response.HasMore;
            summary = response.Summary ?? new FinancialSummary();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private DateTime? GetStartDate()
    {
        return selectedDateRange switch
        {
            "this_month" => new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1),
            "last_month" => new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1).AddMonths(-1),
            "this_quarter" => new DateTime(DateTime.Now.Year, ((DateTime.Now.Month - 1) / 3) * 3 + 1, 1),
            "this_year" => new DateTime(DateTime.Now.Year, 1, 1),
            _ => null
        };
    }

    private DateTime? GetEndDate()
    {
        return selectedDateRange switch
        {
            "this_month" => new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1).AddMonths(1).AddDays(-1),
            "last_month" => new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1).AddDays(-1),
            "this_quarter" => new DateTime(DateTime.Now.Year, ((DateTime.Now.Month - 1) / 3) * 3 + 1, 1).AddMonths(3).AddDays(-1),
            "this_year" => new DateTime(DateTime.Now.Year, 12, 31),
            _ => null
        };
    }
    private async Task OnSearchKeyUp(KeyboardEventArgs e)
    {
        searchDebounceTimer?.Dispose();
        searchDebounceTimer = new System.Threading.Timer(async _ =>
        {
            currentPage = 1;
            await InvokeAsync(async () => await LoadInvoicesWithErrorHandling());
        }, null, 500, Timeout.Infinite);
    }

    private async Task OnDateFilterChange(ChangeEventArgs e)
    {
        selectedDateRange = e.Value?.ToString() ?? "this_month";
        currentPage = 1;
        await LoadInvoicesWithErrorHandling();
    }

    private async Task OnStatusFilterChange(ChangeEventArgs e)
    {
        selectedStatus = e.Value?.ToString() ?? "";
        currentPage = 1;
        await LoadInvoicesWithErrorHandling();
    }

    private async Task OnSortChange(ChangeEventArgs e)
    {
        var sortValue = e.Value?.ToString() ?? "invoice_date_desc";
        var parts = sortValue.Split('_');

        if (parts.Length >= 2)
        {
            sortOrder = parts[^1];
            sortBy = string.Join("_", parts.Take(parts.Length - 1));
        }

        currentPage = 1;
        await LoadInvoicesWithErrorHandling();
    }

    private async Task OnPageSizeChange(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int newSize))
        {
            pageSize = newSize;
            currentPage = 1;
            await LoadInvoicesWithErrorHandling();
        }
    }

    private async Task GoToPage(int page)
    {
        if (page >= 1 && page <= totalPages)
        {
            currentPage = page;
            await LoadInvoicesWithErrorHandling();
        }
    }

    private async Task LoadMoreRecords()
    {
        maxRecords = 1000;
        currentPage = 1;
        await LoadInvoicesWithErrorHandling();
    }

    private async Task ClearFilters()
    {
        searchTerm = "";
        selectedStatus = "";
        selectedDateRange = "this_month";
        currentPage = 1;
        await LoadInvoicesWithErrorHandling();
    }

    private async Task ViewInvoice(int invoiceId)
    {
        try
        {
            selectedInvoice = await InvoiceService.GetInvoiceByIdAsync(invoiceId);
            if (selectedInvoice != null)
            {
                showViewModal = true;
            }
            else
            {
                ShowError("Invoice Not Found", "The requested invoice could not be found.", "NOT_FOUND");
            }
        }
        catch (ServiceException ex)
        {
            ShowError("Failed to Load Invoice", ex.UserFriendlyMessage, ex.ErrorCode, ex.Message);
        }
        catch (Exception ex)
        {
            ShowError("Unexpected Error", "Failed to load invoice details.", "UNKNOWN_ERROR", ex.Message);
        }
    }

    private void CloseViewModal()
    {
        showViewModal = false;
        selectedInvoice = null;
    }

    private void ToggleInvoiceModal()
    {
        showInvoiceModal = !showInvoiceModal;
        if (showInvoiceModal)
        {
            newInvoice = new CreateInvoiceRequest
            {
                InvoiceDate = DateTime.Now,
                DueDate = DateTime.Now.AddDays(30),
                PaymentTerms = "Net 30",
                TaxRate = 12.00m,
                DiscountAmount = 0m,  
                Items = new List<InvoiceItemRequest>
            {
                new InvoiceItemRequest { Description = "", Quantity = 1, UnitPrice = 0 }
            }
            };
            CalculateTotals();
            LoadNextInvoiceNumberWithErrorHandling();
        }
    }

    private async Task LoadNextInvoiceNumberWithErrorHandling()
    {
        try
        {
            nextInvoiceNumber = await InvoiceService.GenerateInvoiceNumberAsync();
        }
        catch (ServiceException ex)
        {
            ShowError("Failed to Generate Invoice Number", ex.UserFriendlyMessage, ex.ErrorCode, ex.Message);
            nextInvoiceNumber = $"INV-{DateTime.Now.Year}-???";
        }
        catch (Exception ex)
        {
            ShowError("Unexpected Error", "Failed to generate invoice number.", "UNKNOWN_ERROR", ex.Message);
            nextInvoiceNumber = $"INV-{DateTime.Now.Year}-???";
        }
    }

    private void AddLineItem()
    {
        newInvoice.Items.Add(new InvoiceItemRequest { Description = "", Quantity = 1, UnitPrice = 0 });
        CalculateTotals();
    }

    private void RemoveLineItem(InvoiceItemRequest item)
    {
        if (newInvoice.Items.Count > 1)
        {
            newInvoice.Items.Remove(item);
            CalculateTotals();
        }
    }

    private void CalculateTotals()
    {
        calculatedSubtotal = newInvoice.Items.Sum(i => i.Quantity * i.UnitPrice);
        calculatedTax = calculatedSubtotal * (newInvoice.TaxRate / 100m);
        calculatedTotal = calculatedSubtotal + calculatedTax - newInvoice.DiscountAmount; // ← now safe
        StateHasChanged();
    }
    private async Task SaveDraft()
    {
        await GenerateInvoice();
    }

    private async Task GenerateInvoice()
    {
        if (newInvoice.CustomerId == 0)
        {
            ShowError("Validation Error", "Please select a customer before creating an invoice.", "VALIDATION_ERROR");
            return;
        }

        if (!newInvoice.Items.Any(i => !string.IsNullOrEmpty(i.Description)))
        {
            ShowError("Validation Error", "Please add at least one item with a description.", "VALIDATION_ERROR");
            return;
        }

        try
        {
            // TODO: Get actual user ID from auth service
            var invoiceId = await InvoiceService.CreateInvoiceAsync(newInvoice, 1);

            showInvoiceModal = false;
            ShowSuccess($"Invoice created successfully! Invoice #{nextInvoiceNumber}");
            await LoadInvoicesWithErrorHandling();
            await LoadNextInvoiceNumberWithErrorHandling();
        }
        catch (ServiceException ex)
        {
            ShowError("Failed to Create Invoice", ex.UserFriendlyMessage, ex.ErrorCode, ex.Message);
        }
        catch (Exception ex)
        {
            ShowError("Unexpected Error", "Failed to create invoice. Please try again.", "UNKNOWN_ERROR", ex.Message);
        }
    }

    private async Task UpdateStatus(int invoiceId, string status)
    {
        try
        {
            await InvoiceService.UpdateInvoiceStatusAsync(new UpdateInvoiceStatusRequest
            {
                InvoiceId = invoiceId,
                PaymentStatus = status
            });

            ShowSuccess($"Invoice status updated to '{status}' successfully!");
            CloseViewModal();
            await LoadInvoicesWithErrorHandling();
        }
        catch (ServiceException ex)
        {
            ShowError("Failed to Update Status", ex.UserFriendlyMessage, ex.ErrorCode, ex.Message);
        }
        catch (Exception ex)
        {
            ShowError("Unexpected Error", "Failed to update invoice status.", "UNKNOWN_ERROR", ex.Message);
        }
    }

    private void ShowDeleteConfirmation(int invoiceId)
    {
        invoiceToDelete = invoiceId;
        showDeleteConfirmation = true;
    }

    private void CancelDelete()
    {
        showDeleteConfirmation = false;
        invoiceToDelete = 0;
    }

    private async Task ConfirmDelete()
    {
        if (invoiceToDelete > 0)
        {
            try
            {
                await InvoiceService.DeleteInvoiceAsync(invoiceToDelete, 1); // TODO: Get actual user ID

                showDeleteConfirmation = false;
                invoiceToDelete = 0;
                ShowSuccess("Invoice deleted successfully!");
                CloseViewModal();
                await LoadInvoicesWithErrorHandling();
            }
            catch (ServiceException ex)
            {
                ShowError("Failed to Delete Invoice", ex.UserFriendlyMessage, ex.ErrorCode, ex.Message);
            }
            catch (Exception ex)
            {
                ShowError("Unexpected Error", "Failed to delete invoice.", "UNKNOWN_ERROR", ex.Message);
            }
        }
    }

    private async Task TestDatabaseConnection()
    {
        try
        {
            var isConnected = await InvoiceService.TestConnectionAsync();
            if (isConnected)
            {
                ShowSuccess("Database connection successful!");
                CloseErrorModal();
            }
        }
        catch (ServiceException ex)
        {
            ShowError("Connection Test Failed", ex.UserFriendlyMessage, ex.ErrorCode, ex.Message);
        }
        catch (Exception ex)
        {
            ShowError("Connection Test Failed", "Unable to connect to the database.", "DB_CONNECTION_ERROR", ex.Message);
        }
    }

    private void ShowError(string title, string message, string code = "", string details = "")
    {
        errorTitle = title;
        errorMessage = message;
        errorCode = code;
        errorDetails = details;
        showErrorModal = true;
        StateHasChanged();
    }

    private void CloseErrorModal()
    {
        showErrorModal = false;
        errorTitle = "";
        errorMessage = "";
        errorCode = "";
        errorDetails = "";
        StateHasChanged();
    }

    private void ShowSuccess(string message)
    {
        successMessage = message;
        showSuccessToast = true;
        StateHasChanged();

        // Auto-hide after 3 seconds
        successToastTimer?.Dispose();
        successToastTimer = new System.Threading.Timer(_ =>
        {
            showSuccessToast = false;
            InvokeAsync(StateHasChanged);
        }, null, 3000, Timeout.Infinite);
    }

    private void EmailInvoice()
    {
        ShowError("Feature Not Available", "Email functionality is not yet implemented.", "NOT_IMPLEMENTED");
    }

    private void DownloadInvoice()
    {
        ShowError("Feature Not Available", "PDF download is not yet implemented.", "NOT_IMPLEMENTED");
    }

    private void PrintInvoice()
    {
        ShowError("Feature Not Available", "Print functionality is not yet implemented.", "NOT_IMPLEMENTED");
    }

    private async Task ExportData()
    {
        ShowError("Feature Not Available", "Export functionality is not yet implemented.", "NOT_IMPLEMENTED");
    }

    public void Dispose()
    {
        searchDebounceTimer?.Dispose();
        successToastTimer?.Dispose();
    }
}
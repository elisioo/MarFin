@page "/documents"
@using MarFin_Final.Models
@inject AppDocumentService AppDocumentService
@inject IJSRuntime JS
@implements IDisposable

<div class="documents-container">
    <div class="documents-header">
        <div class="header-title">
            <h1>Document Management</h1>
        </div>
        <button class="btn-primary" @onclick="OpenFileInput">
            <i class="bi bi-plus-lg"></i> Upload Document
        </button>
    </div>

    <!-- Category Filters -->
    <div class="category-filters">
        <button class="category-btn @(selectedCategory == "all" ? "active" : "")"
                @onclick='() => SetCategory("all")'>
            All
        </button>
        <button class="category-btn @(selectedCategory == "contracts" ? "active" : "")"
                @onclick='() => SetCategory("contracts")'>
            Contracts
        </button>
        <button class="category-btn @(selectedCategory == "invoices" ? "active" : "")"
                @onclick='() => SetCategory("invoices")'>
            Invoices
        </button>
        <button class="category-btn @(selectedCategory == "proposals" ? "active" : "")"
                @onclick='() => SetCategory("proposals")'>
            Proposals
        </button>
        <button class="category-btn @(selectedCategory == "other" ? "active" : "")"
                @onclick='() => SetCategory("other")'>
            Other
        </button>
    </div>

    <!-- Toolbar -->
    <div class="documents-toolbar">
        <div class="search-box">
            <i class="bi bi-search search-icon"></i>
            <input type="text"
                   placeholder="Search documents..."
                   @bind="searchTerm"
                   @bind:event="oninput"
                   @onkeyup="OnSearchKeyUp" />
        </div>
        <button class="btn-filter">
            <i class="bi bi-funnel"></i> Filter
        </button>
        <div class="dropdown-filter">
            <button class="btn-filter">
                Sort: Date <i class="bi bi-chevron-down"></i>
            </button>
        </div>
    </div>

    <!-- Documents Table -->
    <div class="documents-table">
        <div class="table-header">
            <span>Name</span>
            <span>Type</span>
            <span>Customer</span>
            <span>Date</span>
            <span>Size</span>
            <span></span>
        </div>

        @if (documents == null)
        {
            <div class="table-row"><span>Loading documents...</span></div>
        }
        else if (!documents.Any())
        {
            <div class="table-row"><span>No documents found.</span></div>
        }
        else
        {
            @foreach (var doc in documents)
            {
                <div class="table-row">
                    <div class="document-name">
                        <i class="bi @GetDocumentIcon(doc.DocumentName) document-icon"></i>
                        <span>@doc.DocumentName</span>
                    </div>
                    <span>@MapDisplayType(doc.DocumentType)</span>
                    <span>@doc.CustomerDisplayName</span>
                    <span>@doc.FormattedUploadDate</span>
                    <span>@doc.FormattedFileSize</span>
                    <div class="action-buttons">
                        <button class="action-btn" title="View" @onclick="() => ViewDocument(doc.DocumentId)">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="action-btn" title="Download" @onclick="() => DownloadDocument(doc.DocumentId)">
                            <i class="bi bi-download"></i>
                        </button>
                        <button class="action-btn delete" title="Delete" @onclick="() => DeleteDocument(doc.DocumentId)">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            }
        }
    </div>


<div class="upload-zone @(isDragging ? "dragging" : "")"
     @ondragover="HandleDragOver"
     @ondragleave="HandleDragLeave"
     @ondrop="HandleDrop"
     @ondrop:preventDefault="true"
     @ondragover:preventDefault="true">

    <!-- Hidden InputFile - this is what actually handles file selection -->
    <InputFile OnChange="@OnFileSelected" multiple accept=".pdf,.docx,.xlsx,.png,.jpg,.jpeg" />

    <div class="upload-content">
        <i class="bi bi-cloud-upload upload-icon"></i>
        <p class="upload-text">Drop files here or <span style="text-decoration: underline; color: #0A1828;">click to browse</span></p>
        <p class="upload-hint">Supported: PDF, DOCX, XLSX, PNG, JPG • Max 10MB per file</p>
    </div>
</div>

    <!-- Pagination (Static for now - can be enhanced later) -->
    <div class="pagination">
        <span class="pagination-info">Showing @documents?.Count ?? 0 documents</span>
        <div class="pagination-controls">
            <!-- Add real pagination later if needed -->
            <button class="page-btn" disabled><i class="bi bi-chevron-left"></i></button>
            <button class="page-btn active">1</button>
            <button class="page-btn"><i class="bi bi-chevron-right"></i></button>
        </div>
    </div>
</div>

@code {
    private List<AppDocument> documents = new();
    private string searchTerm = "";
    private string selectedCategory = "all";
    private bool isDragging = false;
    private Timer? searchTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadDocuments();
    }

    private async Task LoadDocuments()
    {
        string? categoryFilter = selectedCategory == "all" ? null : selectedCategory;
        documents = await AppDocumentService.GetDocumentsAsync(searchTerm.Trim(), categoryFilter);
        StateHasChanged();
    }

    private void SetCategory(string category)
    {
        selectedCategory = category;
        _ = LoadDocuments();
    }

    private async Task OnSearchKeyUp(KeyboardEventArgs e)
    {
        searchTimer?.Dispose();
        searchTimer = new Timer(async _ =>
        {
            await InvokeAsync(async () => await LoadDocuments());
        }, null, 500, Timeout.Infinite);
    }

    private void OpenFileInput()
    {
        JS.InvokeVoidAsync("document.getElementById('fileInput').click()");
    }

    private async Task OnFileSelected(InputFileChangeEventArgs e)
    {
        var files = e.GetMultipleFiles(10); // Max 10 files

        foreach (var file in files)
        {
            if (file.Size > 10_000_000) // 10MB limit
            {
                await JS.InvokeVoidAsync("alert", $"File '{file.Name}' exceeds 10MB limit.");
                continue;
            }

            var newDoc = new AppDocument
            {
                DocumentType = MapTypeFromFileName(file.Name),
                UploadedBy = 1, // Replace with AuthenticationStateProvider to get current user ID
                CustomerId = null // Later: add modal to select customer
            };

            using var stream = file.OpenReadStream(maxAllowedSize: 10_000_000);
            var success = await AppDocumentService.UploadDocumentAsync(newDoc, stream, file.Name);

            if (success)
            {
                await JS.InvokeVoidAsync("alert", $"Uploaded: {file.Name}");
            }
        }

        await LoadDocuments();
    }



        private void HandleDragOver(DragEventArgs args)
        {
            isDragging = true;
        }

        private void HandleDragLeave(DragEventArgs args)
        {
            isDragging = false;
        }

        private async Task HandleDrop(DragEventArgs args)
        {
            isDragging = false;
        }

    private async Task ViewDocument(int id)
    {
        var doc = await AppDocumentService.GetDocumentByIdAsync(id);
        if (doc != null)
        {
            await JS.InvokeVoidAsync("open", doc.FilePath, "_blank");
        }
    }

    private async Task DownloadDocument(int id)
    {
        var doc = await AppDocumentService.GetDocumentByIdAsync(id);
        if (doc != null)
        {
            // Force download by adding query param or using NavigationManager with JS
            await JS.InvokeVoidAsync("window.location.href", $"{doc.FilePath}?download=1");
        }
    }

    private async Task DeleteDocument(int id)
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", "Are you sure you want to delete this document?");
        if (confirmed)
        {
            await AppDocumentService.DeleteDocumentAsync(id);
            await LoadDocuments();
        }
    }

    private string GetDocumentIcon(string fileName)
    {
        var ext = Path.GetExtension(fileName)?.ToLowerInvariant() ?? "";
        return ext switch
        {
            ".pdf" => "bi-file-pdf",
            ".docx" or ".doc" => "bi-file-word",
            ".xlsx" or ".xls" => "bi-file-excel",
            ".png" or ".jpg" or ".jpeg" => "bi-file-image",
            _ => "bi-file-earmark"
        };
    }

    private string MapDisplayType(string dbType) => dbType switch
    {
        "Contract" => "Contract",
        "Agreement" => "Agreement",
        "Invoice" => "Invoice",
        "Proposal" => "Proposal",
        "Report" => "Report",
        "Other" => "Other",
        _ => "Other"
    };

    private string MapTypeFromFileName(string fileName)
    {
        var lower = fileName.ToLowerInvariant();
        if (lower.Contains("contract") || lower.Contains("agreement")) return "Contract";
        if (lower.Contains("invoice") || lower.Contains("inv-")) return "Invoice";
        if (lower.Contains("proposal") || lower.Contains("quote")) return "Proposal";
        if (lower.Contains("report")) return "Report";
        return "Other";
    }

    public void Dispose()
    {
        searchTimer?.Dispose();
    }
}
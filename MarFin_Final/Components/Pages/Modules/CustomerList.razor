@page "/customers"
@inject NavigationManager Navigation
@inject AuthService AuthService
@inject CustomerService CustomerService
@inject CustomerSegmentService CustomerSegmentService
@inject IJSRuntime JS
@using MarFin_Final.Data
@using MarFin_Final.Database.Services
@using MarFin_Final.Models
@using MarFin_Final.Helpers

<AuthorizeRoute RequiredPermission="@RolePermissions.Permissions.ViewCustomers">
    <div class="customers-container" @onclick="CloseDropdowns">
        <div class="customers-header">
            <div class="header-title">
                <h1>@(showArchivedView ? "Archived Customers" : "Customers")</h1>
                <span class="record-count">@customersResult.TotalCount records</span>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(errorMessage) && !showModal)
        {
            <div class="alert alert-danger">
                @errorMessage
                <button class="alert-close" @onclick="() => errorMessage = string.Empty">×</button>
            </div>
        }
        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="alert alert-success">
                @successMessage
                <button class="alert-close" @onclick="() => successMessage = string.Empty">×</button>
            </div>
        }

        <div class="customers-toolbar">
            @if (!showArchivedView)
            {
                @if (AuthService.IsAdmin() || AuthService.IsMarketing())
                {
                    <button class="btn-primary" @onclick="OpenAddModal">
                        <span><i class="bi bi-plus-lg"></i></span> New Customer
                    </button>

                    
                }
                else
                {
                    <div></div>
                }
            }
            else
            {
                <div></div>
            }
            <div class="toolbar-right">
                @if (AuthService.IsAdmin() || AuthService.IsMarketing())
                {
                    <button class="@(showArchivedView ? "btn-primary" : "btn-secondary")" @onclick="ToggleArchivedView">
                        <span><i class="bi bi-@(showArchivedView ? "arrow-left" : "archive")"></i></span>
                        @(showArchivedView ? "Back to Active Customers" : "View Archived")
                    </button>
                }

                @if (!showArchivedView && (!string.IsNullOrEmpty(statusFilter) || !string.IsNullOrEmpty(searchTerm)))
                {
                    <button class="btn-secondary" @onclick="ClearFilters" title="Clear all filters">
                        <span><i class="bi bi-x-circle"></i></span>
                        Clear Filters
                    </button>
                }

                @if (AuthService.IsAdmin() || AuthService.IsMarketing())
                {
                    @if (filteredCustomers.Any())
                    {
                        <button class="btn-secondary" @onclick="ShowExportCsvConfirmation">
                            <span><i class="bi bi-file-earmark-spreadsheet"></i></span>
                            Export CSV
                        </button>
                    }
                }

                <div class="filter-group" @onclick:stopPropagation>
                    <button class="btn-secondary" @onclick="ToggleStatusFilter" @onclick:stopPropagation>
                        <span><i class="bi bi-funnel"></i></span>
                        Filter by
                        @if (!string.IsNullOrEmpty(statusFilter))
                        {
                            <span class="filter-badge">@statusFilter</span>
                        }
                    </button>
                    @if (showStatusFilter)
                    {
                        <div class="dropdown-menu show" @onclick:stopPropagation>
                            <button type="button" class="@(string.IsNullOrEmpty(statusFilter) ? "active" : "")"
                                    @onclick="() => ApplyStatusFilter(string.Empty)">
                                All Statuses
                            </button>
                            <button type="button" class="@(statusFilter == "Lead" ? "active" : "")"
                                    @onclick='() => ApplyStatusFilter("Lead")'>
                                Lead
                            </button>
                            <button type="button" class="@(statusFilter == "Active" ? "active" : "")"
                                    @onclick='() => ApplyStatusFilter("Active")'>
                                Active
                            </button>
                            <button type="button" class="@(statusFilter == "Inactive" ? "active" : "")"
                                    @onclick='() => ApplyStatusFilter("Inactive")'>
                                Inactive
                            </button>
                            <button type="button" class="@(statusFilter == "Dormant" ? "active" : "")"
                                    @onclick='() => ApplyStatusFilter("Dormant")'>
                                Dormant
                            </button>
                        </div>
                    }
                </div>

                <div class="search-box">
                    <span class="search-icon"><i class="bi bi-search"></i></span>
                    <input type="text"
                           placeholder="Search customers..."
                           maxlength="200"
                           @bind="searchTerm"
                           @bind:event="oninput"
                           @onkeyup="SearchCustomers" />

                    @if (!string.IsNullOrEmpty(searchTerm))
                    {
                        <button class="search-clear" @onclick="ClearSearch">×</button>
                    }
                </div>
            </div>
            </div>
        </div>

        @if (isLoading)
        {
            <div class="loading-state">
                <div class="spinner"></div>
                <p>Loading customers...</p>
            </div>
        }
        else if (!filteredCustomers.Any())
        {
            <div class="empty-state">
                <i class="bi bi-inbox"></i>
                <p>@(string.IsNullOrEmpty(searchTerm) && string.IsNullOrEmpty(statusFilter) ? "No customers found" : $"No customers match your search criteria")</p>
                @if (!string.IsNullOrEmpty(searchTerm) || !string.IsNullOrEmpty(statusFilter))
                {
                    <button class="btn-secondary" @onclick="ClearFilters">Clear Filters</button>
                }
            </div>
        }
        else
        {
            <div class="modern-table-container">
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th>Customer Name</th>
                            <th>Company</th>
                            <th>Segment</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Status</th>
                            <th>Total Revenue</th>
                            <th>Created Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var customer in filteredCustomers.OrderByDescending(c => c.CreatedDate))
                        {
                            <tr>
                                <td>
                                    <div class="customer-name-cell">
                                        <span class="customer-avatar">@GetCustomerInitials(customer)</span>
                                        <span class="customer-name">@customer.FullName</span>
                                    </div>
                                </td>
                                <td>@(string.IsNullOrEmpty(customer.CompanyName) ? "—" : customer.CompanyName)</td>
                                <td>@(string.IsNullOrEmpty(customer.CustomerSegment) ? "—" : customer.CustomerSegment)</td>
                                <td>
                                    @if (string.IsNullOrWhiteSpace(customer.Email))
                                    {
                                        <span class="text-muted">—</span>
                                    }
                                    else
                                    {
                                        <a href="mailto:@customer.Email" class="email-link">@customer.Email</a>
                                    }
                                </td>
                                <td>@(string.IsNullOrEmpty(customer.Phone) ? "—" : customer.Phone)</td>
                                <td>
                                    <span class="status-badge status-@((customer.CustomerStatus ?? "Unknown").ToLower())">
                                        @(string.IsNullOrWhiteSpace(customer.CustomerStatus) ? "Unknown" : customer.CustomerStatus)
                                    </span>
                                </td>
                                <td>
                                    <span class="revenue-badge">₱@customer.TotalRevenue.ToString("N0")</span>
                                </td>
                                <td>@customer.CreatedDate.ToString("MMM dd, yyyy")</td>
                                <td>
                                    <div class="action-buttons">
                                        @if (showArchivedView)
                                        {
                                            @if (AuthService.IsAdmin() || AuthService.IsMarketing())
                                            {
                                                <button class="btn-icon btn-icon-success" @onclick="() => RestoreCustomer(customer)" title="Restore">
                                                    <i class="bi bi-arrow-counterclockwise"></i>
                                                </button>
                                            }
                                        }
                                        else
                                        {
                                            <button class="btn-icon" @onclick="() => NavigateToDetails(customer.CustomerId)" title="View Details">
                                                <i class="bi bi-eye"></i>
                                            </button>

                                            @if (AuthService.IsAdmin() || AuthService.IsMarketing())
                                            {
                                                <button class="btn-icon" @onclick="() => OpenEditModal(customer)" title="Edit">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="btn-icon btn-icon-warning" @onclick="() => ConfirmArchive(customer)" title="Archive">
                                                    <i class="bi bi-archive"></i>
                                                </button>
                                            }
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }

        @if (customersResult.TotalPages > 1)
        {
            <div class="pagination">
                <div class="pagination-left">
                    <span class="pagination-info">
                        Showing @(DisplayStart)–@(DisplayEnd) of @customersResult.TotalCount
                    </span>

                    <div class="rows-per-page">
                        <span>Rows per page:</span>
                        <select @bind="pageSize" @bind:event="onchange">
                            <option value="5">5</option>
                            <option value="10">10</option>
                            <option value="15">15</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                        </select>
                    </div>
                </div>

                <div class="pagination-controls">
                    <button class="page-btn" @onclick="PrevPage" disabled="@(!customersResult.HasPrevious)">
                        <i class="bi bi-chevron-left"></i>
                    </button>

                    @if (customersResult.TotalPages <= 7)
                    {
                        @for (int i = 1; i <= customersResult.TotalPages; i++)
                        {
                            var pageNum = i;
                            <button class="page-btn @(currentPage == pageNum ? "active" : "")"
                                    @onclick="() => GoToPage(pageNum)">
                                @pageNum
                            </button>
                        }
                    }
                    else
                    {
                        @if (currentPage > 4)
                        {
                            <button class="page-btn" @onclick="() => GoToPage(1)">1</button>
                            <span class="page-dots">...</span>
                        }
                        else
                        {
                            for (int i = 1; i <= 3; i++)
                            {
                                var pageNum = i;
                                <button class="page-btn @(currentPage == pageNum ? "active" : "")"
                                        @onclick="() => GoToPage(pageNum)">
                                    @pageNum
                                </button>
                            }
                        }

                        @for (int i = Math.Max(2, currentPage - 1); i <= Math.Min(customersResult.TotalPages - 1, currentPage + 1); i++)
                        {
                            var pageNum = i;
                            <button class="page-btn @(currentPage == pageNum ? "active" : "")"
                                    @onclick="() => GoToPage(pageNum)">
                                @pageNum
                            </button>
                        }

                        @if (currentPage < customersResult.TotalPages - 3)
                        {
                            <span class="page-dots">...</span>
                            <button class="page-btn" @onclick="() => GoToPage(customersResult.TotalPages)">
                                @customersResult.TotalPages
                            </button>
                        }
                        else
                        {
                            for (int i = Math.Max(customersResult.TotalPages - 2, 2); i <= customersResult.TotalPages; i++)
                            {
                                var pageNum = i;
                                <button class="page-btn @(currentPage == pageNum ? "active" : "")"
                                        @onclick="() => GoToPage(pageNum)">
                                    @pageNum
                                </button>
                            }
                        }
                    }

                    <button class="page-btn" @onclick="NextPage" disabled="@(!customersResult.HasNext)">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            </div>
        }
  
    

    @* Add/Edit Customer Modal *@
    @if (showModal)
    {
        <div class="modal-overlay" @onclick="CloseModal">
            <div class="modal-content" @onclick:stopPropagation>
                <div class="modal-header">
                    <div class="modal-title">
                        <span class="user-icon"><i class="bi bi-person"></i></span>
                        <h2>@(isEditMode ? "Edit Customer" : "New Customer")</h2>
                    </div>
                    <div class="modal-actions">
                        <button class="btn-cancel" @onclick="CloseModal">Cancel</button>
                        <button class="btn-save" @onclick="ShowSaveConfirmation" disabled="@isSaving">
                            @if (isSaving)
                            {
                                <span class="spinner-small"></span>
                            }
                            Save
                        </button>
                    </div>
                </div>

                <div class="modal-body">
                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger">@errorMessage</div>
                    }

                    <div class="form-row">
                        <div class="form-group">
                            <label>First Name <span class="required">*</span></label>
                            <input type="text"
                                   class="form-control @(validationErrors.ContainsKey("FirstName") ? "is-invalid" : "")"
                                   maxlength="100"
                                   @bind="editingCustomer.FirstName"
                                   placeholder="Enter first name" />

                            @if (validationErrors.ContainsKey("FirstName"))
                            {
                                <span class="validation-error">@validationErrors["FirstName"]</span>
                            }
                        </div>
                        <div class="form-group">
                            <label>Last Name <span class="required">*</span></label>
                            <input type="text"
                                   class="form-control @(validationErrors.ContainsKey("LastName") ? "is-invalid" : "")"
                                   maxlength="100"
                                   @bind="editingCustomer.LastName"
                                   placeholder="Enter last name" />

                            @if (validationErrors.ContainsKey("LastName"))
                            {
                                <span class="validation-error">@validationErrors["LastName"]</span>
                            }
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Email Address <span class="required">*</span></label>
                        <input type="email"
                               class="form-control @(validationErrors.ContainsKey("Email") ? "is-invalid" : "")"
                               maxlength="254"
                               @bind="editingCustomer.Email"
                               placeholder="email@example.com" />

                        @if (validationErrors.ContainsKey("Email"))
                        {
                            <span class="validation-error">@validationErrors["Email"]</span>
                        }
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Phone Number</label>
                            <div class="phone-input-wrapper">

                                <select class="phone-country-select" @bind="PhoneCountryCode">
                                    <option value="+63">🇵🇭 +63</option>
                                    <option value="+1">🇺🇸 +1</option>
                                    <option value="+44">🇬🇧 +44</option>
                                    <option value="+61">🇦🇺 +61</option>
                                    <option value="+65">🇸🇬 +65</option>
                                    <option value="+60">🇲🇾 +60</option>
                                    <option value="+91">🇮🇳 +91</option>
                                    <option value="+81">🇯🇵 +81</option>
                                    <option value="+86">🇨🇳 +86</option>
                                    <option value="+49">🇩🇪 +49</option>
                                    <option value="+33">🇫🇷 +33</option>
                                    <option value="+82">🇰🇷 +82</option>
                                </select>
                                <input type="tel"
                                    class="form-control phone-number-input @(validationErrors.ContainsKey("Phone") ? "is-invalid" : "")"
                                    @bind="phoneNumberDigits"
                                    @bind:event="oninput"
                                    maxlength="20"
                                    placeholder="@GetPhonePlaceholder()" />

                            </div>
                            @if (validationErrors.ContainsKey("Phone"))
                            {
                                <span class="validation-error">@validationErrors["Phone"]</span>
                            }
                        </div>

                        <style>
                            .phone-input-wrapper {
                                display: flex;
                                gap: 8px;
                            }

                            .phone-country-select {
                                min-width: 100px;
                                padding: 10px 12px;
                                border: 1px solid #e0e0e0;
                                border-radius: 8px;
                                background: white;
                                font-size: 14px;
                                cursor: pointer;
                                transition: border-color 0.2s;
                            }

                            .phone-country-select:hover {
                                border-color: #2563eb;
                            }

                            .phone-country-select:focus {
                                outline: none;
                                border-color: #2563eb;
                                box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
                            }

                            .phone-number-input {
                                flex: 1;
                            }

                            .phone-input-wrapper .form-control.is-invalid {
                                border-color: #dc2626;
                            }
                        </style>
                        <div class="form-group">
                            <label>Company Name</label>
                            <input type="text"
                                   class="form-control"
                                   maxlength="200"
                                   @bind="editingCustomer.CompanyName"
                                   placeholder="Enter company name" />

                        </div>
                    </div>

                    <div class="form-group">
                        <label>Address</label>
                        <input type="text"
                               class="form-control"
                               maxlength="200"
                               @bind="editingCustomer.Address"
                               placeholder="Enter address" />

                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>City</label>
                            <input type="text"
                                   class="form-control"
                                   maxlength="100"
                                   @bind="editingCustomer.City"
                                   placeholder="Enter city" />
                        </div>
                        <div class="form-group">
                            <label>State/Province</label>
                            <input type="text"
                                   class="form-control"
                                   maxlength="100"
                                   @bind="editingCustomer.StateProvince"
                                   placeholder="Enter state or province" />

                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Postal Code</label>
                            <input type="text"
                                   class="form-control @(validationErrors.ContainsKey("PostalCode") ? "is-invalid" : "")"
                                   maxlength="20"
                                   @bind="editingCustomer.PostalCode"
                                   placeholder="Enter postal code" />

                            @if (validationErrors.ContainsKey("PostalCode"))
                            {
                                <span class="validation-error">@validationErrors["PostalCode"]</span>
                            }
                        </div>
                        <div class="form-group">
                            <label>Country</label>
                            <select class="form-control" @bind="editingCustomer.Country">
                                <option value="Philippines">Philippines</option>
                                <option value="United States">United States</option>
                                <option value="Canada">Canada</option>
                                <option value="United Kingdom">United Kingdom</option>
                                <option value="Australia">Australia</option>
                                <option value="Singapore">Singapore</option>
                                <option value="Malaysia">Malaysia</option>
                                <option value="India">India</option>
                                <option value="Japan">Japan</option>
                                <option value="China">China</option>
                                <option value="Germany">Germany</option>
                                <option value="France">France</option>
                                <option value="South Korea">South Korea</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Customer Segment</label>
                        <select class="form-control" @bind="editingCustomer.SegmentId">
                            @if (segments == null || !segments.Any())
                            {
                                <option value="1">Default</option>
                            }
                            else
                            {
                                @foreach (var segment in segments)
                                {
                                    <option value="@segment.SegmentId">@segment.SegmentName</option>
                                }
                            }
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Customer Status</label>
                        <select class="form-control" @bind="editingCustomer.CustomerStatus">
                            <option value="Lead">Lead</option>
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                            <option value="Dormant">Dormant</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Source</label>
                        <select class="form-control" @bind="editingCustomer.Source">
                            <option value="">Select source...</option>
                            <option value="Website">Website</option>
                            <option value="Social Media">Social Media</option>
                            <option value="Referral">Referral</option>
                            <option value="Email Campaign">Email Campaign</option>
                            <option value="Event">Event</option>
                            <option value="Search Engine">Search Engine</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Notes</label>
                        <textarea class="form-control"
                                  @bind="editingCustomer.Notes"
                                  placeholder="Additional notes..."
                                  rows="3"
                                  maxlength="1000"></textarea>

                    </div>
                </div>
            </div>
        </div>
    }

    @* Archive Confirmation Modal *@
    @if (showArchiveModal && customerToArchive != null)
    {
        <div class="modal-overlay" @onclick="CloseArchiveModal">
            <div class="modal-content confirm-modal" @onclick:stopPropagation>
                <div class="modal-header">
                    <div class="modal-title">
                        <span class="user-icon warning"><i class="bi bi-exclamation-triangle"></i></span>
                        <h2>Archive Customer</h2>
                    </div>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to archive <strong>@customerToArchive.FullName</strong>?</p>
                    <p class="text-muted">This customer will be moved to the archived list but can be restored later.</p>

                    <div class="modal-footer">
                        <button class="btn-cancel" @onclick="CloseArchiveModal">Cancel</button>
                        <button class="btn-danger" @onclick="ArchiveCustomer" disabled="@isSaving">
                            @if (isSaving)
                            {
                                <span class="spinner-small"></span>
                            }
                            Archive Customer
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    @* Export CSV Confirmation Modal *@
    @if (showExportCsvModal)
    {
        <div class="modal-overlay" @onclick="CloseExportCsvModal">
            <div class="modal-content confirm-modal" @onclick:stopPropagation>
                <div class="modal-header">
                    <div class="modal-title">
                        <span class="user-icon"><i class="bi bi-file-earmark-spreadsheet"></i></span>
                        <h2>Export Customers to CSV</h2>
                    </div>
                </div>
                <div class="modal-body">
                    <p>
                        You are about to export
                        <strong>@(filteredCustomers?.Count ?? 0)</strong>
                        customer@(filteredCustomers != null && filteredCustomers.Count == 1 ? string.Empty : "s")
                        based on the current filters and search.
                    </p>

                    <p class="text-muted">The following details will be included for each customer:</p>
                    <ul class="export-details-list">
                        <li>Full Name</li>
                        <li>Company</li>
                        <li>Segment</li>
                        <li>Email</li>
                        <li>Phone</li>
                        <li>Status</li>
                        <li>Total Revenue</li>
                        <li>Created Date</li>
                    </ul>

                    <div class="modal-footer">
                        <button class="btn-cancel" @onclick="CloseExportCsvModal" disabled="@isExportingCsv">Cancel</button>
                        <button class="btn-save" @onclick="ConfirmExportCsv" disabled="@isExportingCsv">
                            @if (isExportingCsv)
                            {
                                <span class="spinner-small"></span>
                            }
                            Export CSV
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    @* Confirmation Modal *@
    @if (showConfirmModal)
    {
        <div class="modal-overlay" @onclick="CloseConfirmModal">
            <div class="modal-content confirm-modal" @onclick:stopPropagation>
                <div class="modal-header">
                    <div class="modal-title">
                        <span class="user-icon warning"><i class="bi bi-exclamation-triangle"></i></span>
                        <h2>@confirmTitle</h2>
                    </div>
                </div>
                <div class="modal-body">
                    <p>@confirmMessage</p>

                    <div class="modal-footer">
                        <button class="btn-cancel" @onclick="CloseConfirmModal">Cancel</button>
                        <button class="btn-save" @onclick="ConfirmSaveCustomer" disabled="@isSaving">
                            @if (isSaving)
                            {
                                <span class="spinner-small"></span>
                            }
                            Save
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</AuthorizeRoute>

@code {
    private CustomerService.PaginatedResult<Customer> customersResult = new CustomerService.PaginatedResult<Customer>();

    private List<Models.Customer> filteredCustomers = new();
    private List<CustomerSegment> segments = new();

    private string searchTerm = string.Empty;
    private string statusFilter = string.Empty;
    private bool showStatusFilter = false;
    private bool showModal = false;
    private bool showArchiveModal = false;
    private bool showConfirmModal = false;
    private bool showExportCsvModal = false;
    private bool isEditMode = false;
    private bool isLoading = true;
    private bool isSaving = false;
    private bool isExportingCsv = false;

    private Customer editingCustomer = new();
    private Customer? customerToArchive = null;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;
    private string confirmTitle = string.Empty;
    private string confirmMessage = string.Empty;
    private Dictionary<string, string> validationErrors = new();
    private int currentUserId => AuthService.CurrentUserId ?? 1;
    private bool showArchivedView = false;
    private int currentPage = 1;

    // Phone input state
    private string phoneCountryCode = "+63";
    private string phoneNumberDigits = string.Empty;

    private int DisplayStart => customersResult.TotalCount == 0 ? 0 : (currentPage - 1) * pageSize + 1;
    private int DisplayEnd => Math.Min(currentPage * pageSize, customersResult.TotalCount);

    private int _pageSize = 5;

    private const int MaxNameLength = 100;
    private const int MaxEmailLength = 254;
    private const int MaxCompanyLength = 200;
    private const int MaxAddressLength = 200;
    private const int MaxCityLength = 100;
    private const int MaxStateLength = 100;
    private const int MaxPostalCodeLength = 20;
    private const int MaxNotesLength = 1000;

    // Property wrapper so we can react when the country code changes
    private string PhoneCountryCode
    {
        get => phoneCountryCode;
        set
        {
            if (phoneCountryCode != value)
            {
                phoneCountryCode = value;
                // Clear digits when switching countries to avoid format confusion
                phoneNumberDigits = string.Empty;
            }
        }
    }

    // Country-aware phone rules: required local digits and example formats
    private readonly Dictionary<string, (int RequiredDigits, string Sample, string CountryName)> phoneCountryRules = new()
    {
        ["+63"] = (10, "912 345 6789", "Philippines"),
        ["+1"] = (10, "201 555 0123", "United States/Canada"),
        ["+44"] = (10, "7123 456 789", "United Kingdom"),
        ["+61"] = (9, "412 345 678", "Australia"),
        ["+65"] = (8, "8123 4567", "Singapore"),
        ["+60"] = (9, "12 345 6789", "Malaysia"),
        ["+91"] = (10, "91234 56789", "India"),
        ["+81"] = (9, "70 1234 567", "Japan"),
        ["+86"] = (11, "139 1234 5678", "China"),
        ["+49"] = (10, "1512 345 678", "Germany"),
        ["+33"] = (9, "6 12 34 56 78", "France"),
        ["+82"] = (9, "10 1234 567", "South Korea"),
    };

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/login", true);
            return;
        }

        try
        {
            segments = await Task.Run(() => CustomerSegmentService.GetAllSegments());
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading customer segments: {ex}");
        }

        await LoadCustomers();
    }

    private int pageSize
    {
        get => _pageSize;
        set
        {
            if (_pageSize != value)
            {
                _pageSize = value;
                currentPage = 1;
                _ = LoadCustomers();
            }
        }
    }

    private async Task GoToPage(int page)
    {
        if (page >= 1 && page <= customersResult.TotalPages && page != currentPage)
        {
            currentPage = page;
            await LoadCustomers();
        }
    }

    private async Task LoadCustomers()
    {
        try
        {
            isLoading = true;
            StateHasChanged();

            var safeSearchTerm = (searchTerm ?? string.Empty).Trim();
            if (safeSearchTerm.Length > 200)
            {
                safeSearchTerm = safeSearchTerm.Substring(0, 200);
            }
            searchTerm = safeSearchTerm;

            await Task.Run(() =>
            {
                customersResult = CustomerService.GetCustomersPaginated(
                    pageNumber: currentPage,
                    pageSize: pageSize,
                    searchTerm: safeSearchTerm,
                    statusFilter: statusFilter,
                    isArchived: showArchivedView
                );
            });

            filteredCustomers = new List<Customer>(customersResult.Items);
            errorMessage = string.Empty;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading customers: {ex.Message}";
            Console.WriteLine($"LoadCustomers Error: {ex.Message}\n{ex.StackTrace}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task SearchCustomers()
    {
        currentPage = 1;
        await LoadCustomers();
    }

    private async Task ApplyStatusFilter(string status)
    {
        statusFilter = status;
        showStatusFilter = false;
        currentPage = 1;
        await LoadCustomers();
    }

    private void CloseDropdowns()
    {
        showStatusFilter = false;
        StateHasChanged();
    }

    private async Task ClearSearch()
    {
        searchTerm = string.Empty;
        currentPage = 1;
        await LoadCustomers();
    }

    private async Task ClearFilters()
    {
        searchTerm = string.Empty;
        statusFilter = string.Empty;
        currentPage = 1;
        await LoadCustomers();
    }

    private void ShowExportCsvConfirmation()
    {
        if (filteredCustomers == null || !filteredCustomers.Any())
        {
            return;
        }

        showExportCsvModal = true;
    }

    private void CloseExportCsvModal()
    {
        if (isExportingCsv)
        {
            return;
        }

        showExportCsvModal = false;
    }

    private async Task ConfirmExportCsv()
    {
        if (isExportingCsv)
        {
            return;
        }

        try
        {
            isExportingCsv = true;
            StateHasChanged();

            await ExportCustomersToCsv();
        }
        finally
        {
            isExportingCsv = false;
            showExportCsvModal = false;
            StateHasChanged();
        }
    }

    private async Task ExportCustomersToCsv()
    {
        try
        {
            if (filteredCustomers == null || !filteredCustomers.Any())
            {
                return;
            }

            var sb = new System.Text.StringBuilder();
            sb.AppendLine("FullName,Company,Segment,Email,Phone,Status,TotalRevenue,CreatedDate");

            foreach (var customer in filteredCustomers.OrderByDescending(c => c.CreatedDate))
            {
                sb.AppendLine(string.Join(",", new[]
                {
                    EscapeCsv(customer.FullName),
                    EscapeCsv(string.IsNullOrEmpty(customer.CompanyName) ? string.Empty : customer.CompanyName),
                    EscapeCsv(string.IsNullOrEmpty(customer.CustomerSegment) ? string.Empty : customer.CustomerSegment),
                    EscapeCsv(customer.Email ?? string.Empty),
                    EscapeCsv(customer.Phone ?? string.Empty),
                    EscapeCsv(customer.CustomerStatus ?? string.Empty),
                    EscapeCsv(customer.TotalRevenue.ToString("0.00", System.Globalization.CultureInfo.InvariantCulture)),
                    EscapeCsv(customer.CreatedDate.ToString("yyyy-MM-dd"))
                }));
            }

            var fileName = $"MarFin_Customers_{DateTime.Now:yyyyMMdd_HHmmss}.csv";
            await JS.InvokeVoidAsync("downloadCsv", fileName, sb.ToString());
        }
        catch (Exception ex)
        {
            errorMessage = $"Error exporting customers: {ex.Message}";
            Console.WriteLine($"ExportCustomersToCsv Error: {ex}");
        }
    }

    private static string EscapeCsv(string? value)
    {
        if (string.IsNullOrEmpty(value))
            return string.Empty;

        if (value.Contains('"') || value.Contains(',') || value.Contains('\n') || value.Contains('\r'))
        {
            value = value.Replace("\"", "\"\"");
            return $"\"{value}\"";
        }

        return value;
    }

    private void OpenAddModal()
    {
        if (!AuthService.IsAdmin() && !AuthService.IsMarketing())
        {
            errorMessage = "You don't have permission to add customers";
            return;
        }

        isEditMode = false;
        editingCustomer = new Customer
        {
            SegmentId = 1,
            CreatedBy = currentUserId,
            Country = "Philippines",
            CustomerStatus = "Lead",
            IsActive = true
        };
        phoneCountryCode = "+63";
        phoneNumberDigits = string.Empty;
        editingCustomer.Phone = string.Empty;
        validationErrors.Clear();
        errorMessage = string.Empty;
        showModal = true;
    }

    private void OpenEditModal(Customer customer)
    {
        if (!AuthService.IsAdmin() && !AuthService.IsMarketing())
        {
            errorMessage = "You don't have permission to edit customers";
            return;
        }

        if (customer == null) return;

        isEditMode = true;
        editingCustomer = new Customer
        {
            CustomerId = customer.CustomerId,
            SegmentId = customer.SegmentId,
            CreatedBy = customer.CreatedBy,
            ModifiedBy = currentUserId,
            FirstName = customer.FirstName ?? string.Empty,
            LastName = customer.LastName ?? string.Empty,
            Email = customer.Email ?? string.Empty,
            Phone = customer.Phone ?? string.Empty,
            CompanyName = customer.CompanyName ?? string.Empty,
            Address = customer.Address ?? string.Empty,
            City = customer.City ?? string.Empty,
            StateProvince = customer.StateProvince ?? string.Empty,
            PostalCode = customer.PostalCode ?? string.Empty,
            Country = customer.Country ?? string.Empty,
            CustomerStatus = customer.CustomerStatus ?? "Lead",
            TotalRevenue = customer.TotalRevenue,
            Source = customer.Source ?? string.Empty,
            Notes = customer.Notes ?? string.Empty,
            IsActive = customer.IsActive
        };

        InitializePhoneFromCustomer();

        validationErrors.Clear();
        errorMessage = string.Empty;
        showModal = true;
    }

    private void InitializePhoneFromCustomer()
    {
        phoneCountryCode = "+63";
        phoneNumberDigits = string.Empty;

        if (string.IsNullOrWhiteSpace(editingCustomer.Phone))
        {
            return;
        }

        var digits = System.Text.RegularExpressions.Regex.Replace(editingCustomer.Phone, "[^0-9]", "");
        if (string.IsNullOrEmpty(digits))
        {
            return;
        }

        var codeMap = new Dictionary<string, string>
        {
            ["+63"] = "63",
            ["+1"] = "1",
            ["+44"] = "44",
            ["+61"] = "61",
            ["+65"] = "65",
            ["+60"] = "60",
            ["+91"] = "91",
            ["+81"] = "81",
            ["+86"] = "86",
            ["+49"] = "49",
            ["+33"] = "33",
            ["+82"] = "82"
        };

        foreach (var kvp in codeMap)
        {
            var codeDigits = kvp.Value;
            if (digits.StartsWith(codeDigits))
            {
                phoneCountryCode = kvp.Key;
                phoneNumberDigits = digits.Substring(codeDigits.Length);
                return;
            }
        }

        phoneNumberDigits = digits;
    }

    private void CloseModal()
    {
        showModal = false;
        isEditMode = false;
        validationErrors.Clear();
        errorMessage = string.Empty;
        StateHasChanged();
    }

    private void ShowSaveConfirmation()
    {
        if (!ValidateCustomer())
        {
            return;
        }

        confirmTitle = isEditMode ? "Update Customer" : "Create Customer";
        confirmMessage = isEditMode
            ? $"Are you sure you want to update {editingCustomer.FirstName} {editingCustomer.LastName}?"
            : $"Are you sure you want to create customer {editingCustomer.FirstName} {editingCustomer.LastName}?";
        showConfirmModal = true;
    }

    private void CloseConfirmModal()
    {
        showConfirmModal = false;
    }

    private async Task ConfirmSaveCustomer()
    {
        await SaveCustomer();
        CloseConfirmModal();
    }

    private async Task SaveCustomer()
    {
        if (!ValidateCustomer())
        {
            return;
        }

        try
        {
            isSaving = true;
            StateHasChanged();

            // Phone is already formatted in ValidateCustomer()

            bool success = false;
            if (isEditMode)
            {
                editingCustomer.ModifiedBy = currentUserId;
                await Task.Run(() =>
                {
                    success = CustomerService.UpdateCustomer(editingCustomer);
                });
                successMessage = success ? "Customer updated successfully" : string.Empty;
            }
            else
            {
                editingCustomer.CreatedBy = currentUserId;
                await Task.Run(() =>
                {
                    success = CustomerService.AddCustomer(editingCustomer);
                });
                successMessage = success ? "Customer created successfully" : string.Empty;
            }

            if (success)
            {
                CloseModal();
                await LoadCustomers();
            }
            else
            {
                errorMessage = "Failed to save customer";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving customer: {ex.Message}";
            Console.WriteLine($"SaveCustomer Error: {ex.Message}\n{ex.StackTrace}");
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private bool ValidateCustomer()
    {
        validationErrors.Clear();
        bool isValid = true;

        if (editingCustomer == null)
        {
            errorMessage = "No customer record to validate.";
            StateHasChanged();
            return false;
        }

        // Normalize and constrain string inputs
        editingCustomer.FirstName = (editingCustomer.FirstName ?? string.Empty).Trim();
        editingCustomer.LastName = (editingCustomer.LastName ?? string.Empty).Trim();
        editingCustomer.Email = (editingCustomer.Email ?? string.Empty).Trim();
        editingCustomer.CompanyName = (editingCustomer.CompanyName ?? string.Empty).Trim();
        editingCustomer.Address = (editingCustomer.Address ?? string.Empty).Trim();
        editingCustomer.City = (editingCustomer.City ?? string.Empty).Trim();
        editingCustomer.StateProvince = (editingCustomer.StateProvince ?? string.Empty).Trim();
        editingCustomer.PostalCode = (editingCustomer.PostalCode ?? string.Empty).Trim();
        editingCustomer.Country = string.IsNullOrWhiteSpace(editingCustomer.Country)
            ? "Philippines"
            : editingCustomer.Country.Trim();
        editingCustomer.Source = (editingCustomer.Source ?? string.Empty).Trim();
        editingCustomer.Notes = (editingCustomer.Notes ?? string.Empty).Trim();
        phoneNumberDigits = (phoneNumberDigits ?? string.Empty).Trim();

        if (editingCustomer.CompanyName.Length > MaxCompanyLength)
        {
            editingCustomer.CompanyName = editingCustomer.CompanyName.Substring(0, MaxCompanyLength);
        }

        if (editingCustomer.Address.Length > MaxAddressLength)
        {
            editingCustomer.Address = editingCustomer.Address.Substring(0, MaxAddressLength);
        }

        if (editingCustomer.City.Length > MaxCityLength)
        {
            editingCustomer.City = editingCustomer.City.Substring(0, MaxCityLength);
        }

        if (editingCustomer.StateProvince.Length > MaxStateLength)
        {
            editingCustomer.StateProvince = editingCustomer.StateProvince.Substring(0, MaxStateLength);
        }

        if (editingCustomer.Notes.Length > MaxNotesLength)
        {
            editingCustomer.Notes = editingCustomer.Notes.Substring(0, MaxNotesLength);
        }

        if (string.IsNullOrWhiteSpace(editingCustomer.CustomerStatus))
        {
            editingCustomer.CustomerStatus = "Lead";
        }

        // First name
        if (string.IsNullOrWhiteSpace(editingCustomer.FirstName))
        {
            validationErrors["FirstName"] = "First name is required";
            isValid = false;
        }
        else if (editingCustomer.FirstName.Length > MaxNameLength)
        {
            validationErrors["FirstName"] = $"First name must be {MaxNameLength} characters or less";
            isValid = false;
        }

        // Last name
        if (string.IsNullOrWhiteSpace(editingCustomer.LastName))
        {
            validationErrors["LastName"] = "Last name is required";
            isValid = false;
        }
        else if (editingCustomer.LastName.Length > MaxNameLength)
        {
            validationErrors["LastName"] = $"Last name must be {MaxNameLength} characters or less";
            isValid = false;
        }

        // Email
        if (string.IsNullOrWhiteSpace(editingCustomer.Email))
        {
            validationErrors["Email"] = "Email is required";
            isValid = false;
        }
        else if (editingCustomer.Email.Length > MaxEmailLength)
        {
            validationErrors["Email"] = $"Email must be {MaxEmailLength} characters or less";
            isValid = false;
        }
        else if (!System.Text.RegularExpressions.Regex.IsMatch(editingCustomer.Email,
            @"^[^@\s]+@[^@\s]+\.[^@\s]+$"))
        {
            validationErrors["Email"] = "Please enter a valid email address";
            isValid = false;
        }

        // Postal code
        if (!string.IsNullOrWhiteSpace(editingCustomer.PostalCode))
        {
            if (editingCustomer.PostalCode.Length > MaxPostalCodeLength)
            {
                validationErrors["PostalCode"] = $"Postal code must be {MaxPostalCodeLength} characters or less";
                isValid = false;
            }
            else if (!System.Text.RegularExpressions.Regex.IsMatch(editingCustomer.PostalCode, @"^[0-9A-Za-z\- ]+$"))
            {
                validationErrors["PostalCode"] = "Postal code contains invalid characters";
                isValid = false;
            }
        }

        // Country-aware phone validation
        if (!string.IsNullOrWhiteSpace(phoneNumberDigits))
        {
            // Remove all non-digit characters
            var digits = System.Text.RegularExpressions.Regex.Replace(phoneNumberDigits, "[^0-9]", "");

            if (string.IsNullOrEmpty(digits))
            {
                validationErrors["Phone"] = "Phone number must contain digits";
                isValid = false;
            }
            else if (phoneCountryRules.TryGetValue(phoneCountryCode, out var rule))
            {
                if (digits.Length != rule.RequiredDigits)
                {
                    validationErrors["Phone"] = $"Phone number must be {rule.RequiredDigits} digits for {rule.CountryName} ({phoneCountryCode}).";
                    isValid = false;
                }
                else
                {
                    // Store the formatted phone number using the selected country code
                    editingCustomer.Phone = phoneCountryCode + digits;
                }
            }
            else
            {
                // Fallback: generic 7-15 digit rule
                if (digits.Length < 7)
                {
                    validationErrors["Phone"] = "Phone number is too short (minimum 7 digits)";
                    isValid = false;
                }
                else if (digits.Length > 15)
                {
                    validationErrors["Phone"] = "Phone number is too long (maximum 15 digits)";
                    isValid = false;
                }
                else
                {
                    editingCustomer.Phone = phoneCountryCode + digits;
                }
            }
        }
        else
        {
            editingCustomer.Phone = string.Empty;
        }

        StateHasChanged();
        return isValid;
    }

    private void ConfirmArchive(Customer customer)
    {
        if (!AuthService.IsAdmin() && !AuthService.IsMarketing())
        {
            errorMessage = "You don't have permission to archive customers";
            return;
        }

        customerToArchive = customer;
        showArchiveModal = true;
    }

    private void CloseArchiveModal()
    {
        showArchiveModal = false;
        customerToArchive = null;
    }

    private async Task ArchiveCustomer()
    {
        if (customerToArchive == null) return;

        try
        {
            isSaving = true;
            StateHasChanged();

            bool success = false;
            await Task.Run(() =>
            {
                success = CustomerService.ArchiveCustomer(customerToArchive.CustomerId, currentUserId);
            });

            if (success)
            {
                successMessage = $"{customerToArchive.FullName} has been archived successfully";
                CloseArchiveModal();
                await LoadCustomers();
            }
            else
            {
                errorMessage = "Failed to archive customer";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error archiving customer: {ex.Message}";
            Console.WriteLine($"ArchiveCustomer Error: {ex.Message}\n{ex.StackTrace}");
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private void NavigateToDetails(int customerId)
    {
        Navigation.NavigateTo($"/customer-details/{customerId}");
    }

    private async Task ToggleArchivedView()
    {
        showArchivedView = !showArchivedView;
        searchTerm = string.Empty;
        statusFilter = string.Empty;
        showStatusFilter = false;
        currentPage = 1;
        await LoadCustomers();
    }

    private async Task RestoreCustomer(Customer customer)
    {
        if (!AuthService.IsAdmin() && !AuthService.IsMarketing())
        {
            errorMessage = "You don't have permission to restore customers";
            return;
        }

        try
        {
            isSaving = true;
            StateHasChanged();

            bool success = false;
            await Task.Run(() =>
            {
                success = CustomerService.RestoreCustomer(customer.CustomerId);
            });

            if (success)
            {
                successMessage = $"{customer.FullName} has been restored successfully";
                await LoadCustomers();
            }
            else
            {
                errorMessage = "Failed to restore customer";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error restoring customer: {ex.Message}";
            Console.WriteLine($"RestoreCustomer Error: {ex.Message}\n{ex.StackTrace}");
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private async Task PrevPage()
    {
        if (customersResult.HasPrevious)
        {
            currentPage--;
            await LoadCustomers();
        }
    }

    private async Task NextPage()
    {
        if (customersResult.HasNext)
        {
            currentPage++;
            await LoadCustomers();
        }
    }

    private void ToggleStatusFilter()
    {
        showStatusFilter = !showStatusFilter;
        StateHasChanged();
    }

    private string GetCustomerInitials(Customer customer)
    {
        if (customer == null)
        {
            return "?";
        }

        var first = (customer.FirstName ?? string.Empty).Trim();
        var last = (customer.LastName ?? string.Empty).Trim();

        var firstInitial = !string.IsNullOrEmpty(first) ? char.ToUpperInvariant(first[0]) : '?';
        char? lastInitial = !string.IsNullOrEmpty(last) ? char.ToUpperInvariant(last[0]) : (char?)null;

        return lastInitial.HasValue ? $"{firstInitial}{lastInitial.Value}" : firstInitial.ToString();
    }

    private string GetPhonePlaceholder()
    {
        if (phoneCountryRules.TryGetValue(phoneCountryCode, out var rule))
        {
            return rule.Sample;
        }

        return "Enter phone number";
    }
}
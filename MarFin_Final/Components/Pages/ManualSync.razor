@page "/manual-sync"
@inject RemoteDatabaseService RemoteDbService
@inject AuthService AuthService
@inject NavigationManager Navigation
@using MarFin_Final.Database.Services
@using MarFin_Final.Models

<div class="manual-sync-container">
    <div class="sync-header">
        <h1>Manual Data Sync</h1>
        <p>Directly insert and sync test data to the cloud database</p>
    </div>

    <div class="sync-content">
        <!-- Test Data Form -->
        <div class="sync-card">
            <div class="card-header">
                <h3>Add Test Customer</h3>
                <p>Create a sample customer to sync</p>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label>First Name</label>
                    <input type="text" class="form-control" @bind="testCustomer.FirstName" placeholder="John" />
                </div>
                <div class="form-group">
                    <label>Last Name</label>
                    <input type="text" class="form-control" @bind="testCustomer.LastName" placeholder="Doe" />
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" class="form-control" @bind="testCustomer.Email" placeholder="john@example.com" />
                </div>
                <div class="form-group">
                    <label>Company</label>
                    <input type="text" class="form-control" @bind="testCustomer.CompanyName" placeholder="Acme Corp" />
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" class="form-control" @bind="testCustomer.Phone" placeholder="+63 123 456 7890" />
                </div>
                <div class="form-group">
                    <label>Country</label>
                    <input type="text" class="form-control" @bind="testCustomer.Country" placeholder="Philippines" />
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select class="form-control" @bind="testCustomer.CustomerStatus">
                        <option value="Lead">Lead</option>
                        <option value="Prospect">Prospect</option>
                        <option value="Customer">Customer</option>
                        <option value="Inactive">Inactive</option>
                    </select>
                </div>
                <button class="btn btn-primary" @onclick="SyncTestCustomer" disabled="@isSyncing">
                    @if (isSyncing)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                        <span>Syncing...</span>
                    }
                    else
                    {
                        <i class="bi bi-cloud-arrow-up me-2"></i>
                        <span>Sync This Customer</span>
                    }
                </button>
            </div>
        </div>

        <!-- Bulk Sync -->
        <div class="sync-card">
            <div class="card-header">
                <h3>Bulk Sync</h3>
                <p>Create and sync multiple test customers at once</p>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label>Number of Customers</label>
                    <input type="number" class="form-control" @bind="bulkCount" min="1" max="100" placeholder="10" />
                </div>
                <button class="btn btn-success" @onclick="SyncBulkCustomers" disabled="@isSyncing">
                    @if (isSyncing)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                        <span>Syncing...</span>
                    }
                    else
                    {
                        <i class="bi bi-cloud-arrow-up me-2"></i>
                        <span>Create & Sync @bulkCount Customers</span>
                    }
                </button>
            </div>
        </div>

        <!-- Results -->
        @if (!string.IsNullOrEmpty(resultMessage))
        {
            <div class="sync-card">
                <div class="alert @(syncSuccess ? "alert-success" : "alert-warning")">
                    <i class="bi @(syncSuccess ? "bi-check-circle" : "bi-exclamation-triangle") me-2"></i>
                    @resultMessage
                </div>
            </div>
        }

        <!-- Sync Log -->
        @if (syncLog.Count > 0)
        {
            <div class="sync-card">
                <div class="card-header">
                    <h3>Sync Log</h3>
                </div>
                <div class="card-body">
                    <div class="sync-log">
                        @foreach (var log in syncLog)
                        {
                            <div class="log-entry @(log.Contains("✓") ? "success" : log.Contains("✗") ? "error" : "info")">
                                @log
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<style>
   
</style>

@code {
    private Customer testCustomer = new();
    private List<string> syncLog = new();
    private string resultMessage = "";
    private bool syncSuccess = false;
    private bool isSyncing = false;
    private int bulkCount = 10;

    protected override void OnInitialized()
    {
        if (!AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/login", true);
        }

        // Initialize test customer
        testCustomer = new Customer
        {
            FirstName = "John",
            LastName = "Doe",
            Email = $"john.doe.{DateTime.Now.Ticks}@example.com",
            CompanyName = "Acme Corporation",
            Phone = "+63 123 456 7890",
            Country = "Philippines",
            CustomerStatus = "Lead",
            SegmentId = 1,
            CreatedBy = 1,
            IsActive = true,
            TotalRevenue = 0
        };
    }

    private async Task SyncTestCustomer()
    {
        isSyncing = true;
        syncLog.Clear();
        resultMessage = "";
        StateHasChanged();

        try
        {
            AddLog($"Starting sync for: {testCustomer.FirstName} {testCustomer.LastName}");
            AddLog($"   Email: {testCustomer.Email}");

            var customers = new List<Customer> { testCustomer };
            var result = await RemoteDbService.SyncAllDataAsync(customers, new List<Invoice>());

            syncSuccess = result.IsSuccess;
            resultMessage = result.Message;

            if (result.IsSuccess)
            {
                AddLog($"✓ Sync completed successfully!");
                AddLog($"   {result.CustomersSynced} customer(s) synced");
            }
            else
            {
                AddLog($"✗ Sync failed: {result.Message}");
            }
        }
        catch (Exception ex)
        {
            syncSuccess = false;
            resultMessage = $"Error: {ex.Message}";
            AddLog($"✗ Exception: {ex.Message}");
        }
        finally
        {
            isSyncing = false;
            StateHasChanged();
        }
    }

    private async Task SyncBulkCustomers()
    {
        isSyncing = true;
        syncLog.Clear();
        resultMessage = "";
        StateHasChanged();

        try
        {
            AddLog($"Creating {bulkCount} test customers...");

            var customers = new List<Customer>();
            for (int i = 1; i <= bulkCount; i++)
            {
                customers.Add(new Customer
                {
                    FirstName = $"Customer{i}",
                    LastName = $"Test{i}",
                    Email = $"customer{i}.{DateTime.Now.Ticks}@example.com",
                    CompanyName = $"Company {i}",
                    Phone = $"+63 {i:D3} 456 7890",
                    Country = "Philippines",
                    CustomerStatus = i % 3 == 0 ? "Customer" : i % 2 == 0 ? "Prospect" : "Lead",
                    SegmentId = 1,
                    CreatedBy = 1,
                    IsActive = true,
                    TotalRevenue = i * 1000m
                });
            }

            AddLog($"✓ Created {customers.Count} customers");
            AddLog($" Syncing to remote database...");

            var result = await RemoteDbService.SyncAllDataAsync(customers, new List<Invoice>());

            syncSuccess = result.IsSuccess;
            resultMessage = result.Message;

            if (result.IsSuccess)
            {
                AddLog($"✓ Bulk sync completed!");
                AddLog($"   {result.CustomersSynced} of {result.CustomersAttempted} customers synced");
            }
            else
            {
                AddLog($"✗ Sync failed: {result.Message}");
            }
        }
        catch (Exception ex)
        {
            syncSuccess = false;
            resultMessage = $"Error: {ex.Message}";
            AddLog($"✗ Exception: {ex.Message}");
        }
        finally
        {
            isSyncing = false;
            StateHasChanged();
        }
    }

    private void AddLog(string message)
    {
        syncLog.Insert(0, $"[{DateTime.Now:HH:mm:ss}] {message}");
        StateHasChanged();
    }
}
